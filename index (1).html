<!DOCTYPE html>
<html lang="ja">
<head>
<link rel="icon" href="https://www.dropbox.com/scl/fi/jxjgwcg2oa5ic0jrfx5s6/.png?rlkey=tpj00fxn8kqnlt5rb75l7wmu3&st=szhw5y8u&dl=0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pop typer</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Noto+Serif+JP:wght@400;700&family=M+PLUS+Rounded+1c:wght@400;700;900&family=Orbitron:wght@700&family=Kiwi+Maru:wght@500&family=DotGothic16&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
	 /* ----------------------------------------------------- */
        /* CSS: „Çπ„Çø„Ç§„É´ÂÆöÁæ© */
        /* ----------------------------------------------------- */

        /* --- 0. Âü∫Êú¨Ë®≠ÂÆö„Å®ÈÖçËâ≤ --- */
        :root {
            --color-bg-start: #1e2a3a;
            --color-bg-end: #2d3f54;
            --color-main: #2c3e50;
            --color-accent: #3498db;
            --color-correct: #2ecc71;
            --color-error: #e74c3c;
            --color-text: #ecf0f1;
            --color-border: #3498db;
            --font-main: 'Noto Sans JP', 'Segoe UI', Tahoma, sans-serif;
            --font-serif: 'Noto Serif JP', serif;
            --font-rounded: 'M PLUS Rounded 1c', 'Noto Sans JP', sans-serif;
            --font-cyber: 'Orbitron', 'Noto Sans JP', sans-serif;
            --font-wa: 'Kiwi Maru', 'Noto Serif JP', serif;
            --font-pixel: 'DotGothic16', 'Noto Sans JP', sans-serif;
        }

        body {
            font-family: var(--font-main);
            background: linear-gradient(135deg, var(--color-bg-start), var(--color-bg-end));
            color: var(--color-text);
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            position: relative;
            transition: background 0.5s ease, font-family 0.3s ease, color 0.3s ease;
            background-size: 100% 100%;
        }
        body.font-serif { font-family: var(--font-serif); }
        body.font-rounded { font-family: var(--font-rounded); }
        body.font-pixel { font-family: var(--font-pixel); }

        /* „Åµ„Çä„Åå„Å™Ë°®Á§∫Âà∂Âæ° */
        body:not(.show-furigana) rt {
            display: none;
        }
        body.show-furigana rt {
            font-size: 0.4em;
            font-weight: 400;
        }

        /* „Ç≥„É≥„ÉúÈÄ£Âãï„Ç®„Éï„Çß„ÇØ„ÉàÁî®„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes background-pan-slow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes background-pan-fast {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        body.combo-tier-1 {
            background-size: 110% 110%;
        }
        body.combo-tier-2 {
            background-size: 120% 120%;
            animation: background-pan-slow 20s ease infinite;
        }
        body.combo-tier-3 {
            background-size: 130% 130%;
            animation: background-pan-fast 10s ease infinite;
        }

        @keyframes fever-glow {
            0% { box-shadow: 0 0 20px #ff0000, inset 0 0 20px #ff0000; }
            25% { box-shadow: 0 0 20px #ffff00, inset 0 0 20px #ffff00; }
            50% { box-shadow: 0 0 20px #00ff00, inset 0 0 20px #00ff00; }
            75% { box-shadow: 0 0 20px #0000ff, inset 0 0 20px #0000ff; }
            100% { box-shadow: 0 0 20px #ff0000, inset 0 0 20px #ff0000; }
        }
        body.fever-active #main-content {
            animation: fever-glow 1s linear infinite;
        }
        #fever-timer-display {
            position: fixed;
            top: 20px; 
            right: 280px; 
            font-size: 4em; 
            font-weight: 900;
            color: rgba(255, 255, 0, 0.8);
            text-shadow: 0 0 10px #000;
            z-index: 50;
            pointer-events: none;
            display: none;
        }


        /* --- 1. Âè≥„Çµ„Ç§„Éâ„Éê„Éº --- */
        #sidebar {
            width: 240px;
            position: fixed;
            top: 0;
            right: 0;
            height: 100vh;
            background-color: var(--color-main);
            padding: 20px 10px;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 10;
            flex-shrink: 0;
            overflow-y: auto;
            box-sizing: border-box;
            transition: background-color 0.3s ease;
        }
        #data-ui { 
            width: 100%; 
            text-align: center; 
            margin-bottom: 20px; 
            padding: 10px 0; 
            border-bottom: 2px solid var(--color-border); 
            transition: border-color 0.3s ease;
        }
        .sidebar-value { 
            font-size: 1.5em; 
            font-weight: bold; 
            color: var(--color-correct); 
            margin-bottom: 5px; 
            transition: color 0.3s ease;
        }
        .sidebar-label { 
            font-size: 0.8em; 
            color: #ccc; 
        }
        #level-display { margin-bottom: 10px; }
        #xp-bar-container {
            width: 90%;
            height: 10px;
            background-color: #1e2a3a;
            border-radius: 5px;
            margin: 0 auto 5px auto;
            overflow: hidden;
            border: 1px solid #111;
            transition: background-color 0.3s ease;
        }
        #xp-bar-progress {
            height: 100%;
            width: 0%;
            background-color: var(--color-accent);
            transition: width 0.3s ease, background-color 0.3s ease;
        }
        #xp-label { margin-bottom: 15px; }

        .sidebar-btn, .mode-btn { 
            width: 100%; 
            padding: 10px 15px; 
            margin-bottom: 10px; 
            border: 2px solid var(--color-accent); 
            border-radius: 8px; 
            background-color: transparent; 
            color: var(--color-text); 
            font-size: 0.9em; 
            cursor: pointer; 
            transition: background-color 0.2s, color 0.2s, border-color 0.3s ease; 
            text-align: left; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            box-sizing: border-box; 
            font-family: var(--font-main); 
        }
        /* ‚òÖ Â§ö„Åè„ÅÆ„Éú„Çø„É≥„Å´ÂØæÂøú„Åô„Çã„Åü„ÇÅ„Éû„Éº„Ç∏„É≥Á∏ÆÂ∞è */
        .sidebar-btn, .mode-btn {
            margin-bottom: 8px;
            padding: 8px 12px;
            font-size: 0.85em;
        }

        .mode-btn.active { 
            background-color: var(--color-accent); 
            color: var(--color-main); 
            font-weight: bold; 
        }
        #sudden-death-mode-btn {
            border-color: var(--color-error);
        }
        #sudden-death-mode-btn.active {
            background-color: var(--color-error);
            color: var(--color-main);
        }
        .mode-btn.challenge-btn {
            border-color: #f1c40f; 
        }
        .mode-btn.challenge-btn.active {
            background-color: #f1c40f;
            color: var(--color-main);
        }
        #custom-mode-btn {
            border-color: #9b59b6; 
        }
        #custom-mode-btn.active {
            background-color: #9b59b6;
            color: var(--color-main);
        }


        /* --- 2. „É°„Ç§„É≥„Ç≤„Éº„É†„Ç®„É™„Ç¢ --- */
        #main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            position: relative;
            transition: box-shadow 0.3s ease-out;
            margin-right: 260px;
            width: calc(100% - 260px);
            box-sizing: border-box;
        }
        #main-content.boost-active { 
            animation: boost-glow 1.5s infinite alternate ease-in-out; 
        }
        @keyframes boost-glow {
            from { box-shadow: 0 0 5px var(--color-accent); }
            to { box-shadow: 0 0 20px var(--color-accent), inset 0 0 10px var(--color-accent); }
        }

        /* --- 3. „Çπ„ÉÜ„Éº„Çø„Çπ„Éê„Éº („Çπ„Ç≥„Ç¢/„Ç≥„É≥„Éú/ÊôÇÈñì) --- */
        #status-bar { 
            display: flex; 
            justify-content: space-around; 
            align-items: center; 
            padding: 10px 0; 
            margin-bottom: 30px; 
            border-bottom: 3px solid var(--color-border); 
            flex-shrink: 0; 
            transition: border-color 0.3s ease;
        }
        .status-item { 
            text-align: center; 
            min-width: 180px; 
        }
        #score-display, #combo-display, #timer, #total-typed-display { 
            font-size: 3.0em; 
            font-weight: 900; 
            color: var(--color-text); 
            margin-bottom: 5px; 
            transition: transform 0.2s, color 0.3s ease; 
        }
        #timer { 
            color: var(--color-accent); 
            font-size: 3.2em; 
        }
        #total-typed-display {
            color: var(--color-correct);
            font-size: 2.8em;
        }

        /* --- 4. „Çø„Ç§„Éî„É≥„Ç∞„Ç®„É™„Ç¢ („ÅäÈ°åË°®Á§∫) --- */
        #typing-area { 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            position: relative; 
        }

        #kanji-display {
            font-size: 2.5em; 
            font-weight: 700;
            color: #ccc;
            margin-bottom: 10px;
            min-height: 1.5em;
            line-height: 1.5;
            text-align: center;
        }
        #word-display { 
            font-size: 4em; 
            font-weight: bold; 
            padding: 20px 40px; 
            border-radius: 15px; 
            background: rgba(0, 0, 0, 0.2); 
            margin-bottom: 30px; 
            min-height: 80px; 
            max-width: 90%; 
            text-align: center; 
            transition: transform 0.1s, background-color 0.3s ease; 
            letter-spacing: 2px; 
            line-height: 1.5; 
        }
        /* ‚òÖ„ÉÄ„Éñ„É´„É¢„Éº„ÉâÁî® */
        #word-display-sub {
            font-size: 2em;
            font-weight: 700;
            color: #aaa;
            background: rgba(0, 0, 0, 0.1);
            padding: 10px 20px;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        #word-display span { 
            display: inline-block; 
            transition: color 0.1s; 
            margin: 0 2px; 
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        #word-display span.current {
            position: relative;
            color: var(--color-accent); 
            border-bottom: 3px solid var(--color-accent); 
            background-color: rgba(52, 152, 219, 0.2); 
            border-radius: 5px; 
            padding: 0 5px; 
            margin: 0; 
        }
        #word-display span.current::after {
            content: '|';
            position: absolute;
            right: -2px;
            top: 0;
            color: var(--color-accent);
            font-weight: bold;
            animation: blink 1s step-end infinite;
        }
        #word-display span.incorrect { 
            color: var(--color-error) !important; 
            animation: shake 0.5s; 
        }
        #word-display span.correct { 
            color: var(--color-correct); 
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
            20%, 40%, 60%, 80% { transform: translateX(3px); }
        }
        #quote-input { 
            position: absolute; 
            top: -100px; 
            opacity: 0; 
        }
        
        /* --- 5. ‰ªÆÊÉ≥„Ç≠„Éº„Éú„Éº„Éâ --- */
        #keyboard-container {
            width: 80%;
            max-width: 900px;
            margin-top: auto;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            flex-shrink: 0;
            transition: box-shadow 0.5s, background-color 0.3s ease;
        }
        #keyboard-container.perfect-mode {
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.8), inset 0 0 5px rgba(52, 152, 219, 0.5);
        }
        #keyboard-container.boost-rainbow {
            animation: rainbow-glow 2s linear infinite;
        }
        @keyframes rainbow-glow {
            0% { box-shadow: 0 0 20px #ff0000, inset 0 0 8px #ff0000; }
            16% { box-shadow: 0 0 20px #ff7f00, inset 0 0 8px #ff7f00; }
            33% { box-shadow: 0 0 20px #ffff00, inset 0 0 8px #ffff00; }
            50% { box-shadow: 0 0 20px #00ff00, inset 0 0 8px #00ff00; }
            66% { box-shadow: 0 0 20px #0000ff, inset 0 0 8px #0000ff; }
            83% { box-shadow: 0 0 20px #8b00ff, inset 0 0 8px #8b00ff; }
            100% { box-shadow: 0 0 20px #ff0000, inset 0 0 8px #ff0000; }
        }

        .keyboard-row { 
            display: flex; 
            justify-content: center; 
            margin-bottom: 8px; 
        }
        .key { 
            padding: 8px 12px; 
            margin: 0 4px; 
            background-color: #444; 
            color: #fff; 
            border-radius: 4px; 
            font-size: 0.9em; 
            font-weight: bold; 
            text-align: center; 
            min-width: 25px; 
            transition: background-color 0.1s, box-shadow 0.1s; 
            box-shadow: 0 3px 0 #222; 
            cursor: default; 
            text-transform: uppercase; 
        }
        .key.highlight { 
            background-color: var(--color-accent); 
            color: var(--color-main); 
            box-shadow: 0 1px 0 var(--color-border); 
            transform: translateY(2px); 
            transition: none; 
        }
        /* ‚òÖ„Ç≠„Éº„Éú„Éº„Éâ„Çπ„Ç≠„É≥ */
        #keyboard-container.skin-wood .key { background: #8B4513; box-shadow: 0 3px 0 #5A2D0C; }
        #keyboard-container.skin-pixel .key { background: #555; border-radius: 0; box-shadow: 0 3px 0 #222; font-family: var(--font-pixel); }
        #keyboard-container.skin-neko .key { background: #ffc0cb; color: #333; box-shadow: 0 3px 0 #db7093; border-radius: 10px; }
        
        /* --- 6. „Éù„ÉÉ„Éó„Ç®„Éï„Çß„ÇØ„Éà („Çø„Ç§„ÉóÊôÇ„ÅÆÊºîÂá∫) --- */
        .pop-key { 
            position: fixed; 
            font-size: 3em; 
            font-weight: bold; 
            pointer-events: none; 
            user-select: none; 
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.8); 
            animation: pop-anim-default 1.0s forwards;
            color: white;
            z-index: 100;
        }

        @keyframes pop-anim-default {
            0% { transform: translate(0, 0) scale(1.0); opacity: 1; }
            100% { transform: translate(var(--pop-x), var(--pop-y)) scale(1.5); opacity: 0; } 
        }
        .pop-key.rainbow {
            background-clip: text; 
            -webkit-background-clip: text; 
            color: transparent; 
            background-image: linear-gradient(90deg, #ff0000, #ff7f00, #ffff00, #00ff00, #00ffff, #0000ff, #8b00ff); 
            background-size: 200% 100%;
            animation: pop-anim-default 1.0s forwards, rainbow-text 0.2s linear infinite;
        }
        @keyframes rainbow-text { 
            0% { background-position: 0% 50%; } 
            100% { background-position: 100% 50%; } 
        }
        
        @keyframes pop-anim-firework {
            0% { transform: scale(0.5); opacity: 1; }
            50% { opacity: 1; }
            100% { transform: scale(2.0); opacity: 0; }
        }
        .pop-key.firework {
            animation: pop-anim-firework 0.6s forwards;
            color: gold;
            text-shadow: 0 0 5px gold, 0 0 10px red;
        }
        
        @keyframes pop-anim-bubble {
            0% { transform: scale(0.8) translateY(0); opacity: 1; }
            100% { transform: scale(1.2) translateY(-150px); opacity: 0; }
        }
        .pop-key.bubble {
            animation: pop-anim-bubble 1.2s forwards;
            color: #fff;
            background: radial-gradient(circle at 65% 15%, white 1px, aqua 3%, blue 60%, aqua 100%);
            border-radius: 50%;
            padding: 0 5px; 
            text-shadow: none;
        }

        @keyframes pop-anim-lines {
            0% { transform: scale(0.5); opacity: 0.5; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        .pop-key.lines {
            animation: pop-anim-lines 0.4s forwards;
            color: white;
            text-shadow: 0 0 2px black, 0 0 5px black;
        }


        /* --- 7. „É¢„Éº„ÉÄ„É´ („Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóÁîªÈù¢) ÂÖ±ÈÄö --- */
        .modal-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.9); 
            display: none;
            justify-content: center; 
            align-items: center; 
            z-index: 30; 
            padding: 0; 
        }
        .modal-content { 
            background-color: var(--color-main); 
            width: 100%; 
            height: 100%; 
            max-width: 100%; 
            max-height: 100%; 
            border-radius: 0; 
            padding: 40px; 
            box-sizing: border-box; 
            overflow-y: auto; 
            position: relative; 
            transition: background-color 0.3s ease;
        }
        .modal-overlay.panel-modal .modal-content {
            max-width: 800px; 
            max-height: 90vh;
            height: auto;
            border-radius: 10px;
        }
        .close-btn { 
            position: absolute; 
            top: 20px; 
            right: 30px; 
            background: rgba(0,0,0,0.3); 
            border: 2px solid var(--color-accent); 
            color: var(--color-text); 
            font-size: 2.5em; 
            cursor: pointer; 
            border-radius: 50%; 
            width: 50px; 
            height: 50px; 
            line-height: 50px; 
            text-align: center; 
            padding: 0; 
            z-index: 40; 
            transition: all 0.2s; 
        }
        .close-btn:hover { 
            background: var(--color-accent); 
            color: var(--color-main); 
        }
        
        /* --- 8. „É¢„Éº„ÉÄ„É´ÂÜÖ„Ç≥„É≥„ÉÜ„É≥„ÉÑ --- */
        #shop-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); 
            gap: 20px; 
            padding: 20px; 
        }
        .shop-item { 
            background-color: var(--color-bg-start); 
            border: 1px solid var(--color-border); 
            padding: 15px; 
            border-radius: 5px; 
            text-align: center; 
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .shop-item h3 { 
            color: var(--color-accent); 
            margin-top: 0; 
            transition: color 0.3s ease;
        }
        .item-price { 
            font-size: 1.2em; 
            font-weight: bold; 
            color: var(--color-correct); 
            margin: 10px 0; 
            transition: color 0.3s ease;
        }
        .item-buy-btn { 
            padding: 10px 20px; 
            background-color: var(--color-accent); 
            color: var(--color-main); 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            transition: background-color 0.2s, color 0.3s ease; 
            font-weight: bold; 
            font-family: var(--font-main); 
        }
        .item-buy-btn:disabled { 
            background-color: #7f8c8d; 
            cursor: not-allowed; 
        }
        .item-buy-btn.active { 
            background-color: var(--color-correct); 
            color: var(--color-main); 
            cursor: default; 
        }
        
        #title-list-container, #mission-list-container, #achievement-list-container { 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            padding: 20px; 
        }
        .title-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px; 
            border-bottom: 1px solid #555; 
            background: var(--color-bg-start); 
            border-radius: 5px; 
            transition: background-color 0.3s ease;
        }
        .title-item .item-name { flex-grow: 1; font-weight: bold; }
        .title-item .item-description { flex-shrink: 0; margin-left: 15px; font-size: 0.9em; color: #aaa; }
        .title-item .item-status { flex-shrink: 0; margin-left: 15px; font-weight: bold; }
        
        .mission-item, .achievement-item { 
            display: grid; 
            grid-template-columns: 1fr auto auto;
            gap: 10px;
            align-items: center; 
            padding: 10px; 
            border-bottom: 1px solid #555; 
            background: var(--color-bg-start); 
            border-radius: 5px; 
            transition: background-color 0.3s ease;
        }
        .item-name { font-weight: bold; }
        .item-description { font-size: 0.9em; color: #aaa; grid-column: 1 / -1; } 
        .item-status { font-weight: bold; }
        .item-status.unlocked { color: var(--color-correct); }
        .item-status.locked { color: #777; }
        .item-reward { font-weight: bold; color: var(--color-correct); }
        .item-ap { font-weight: bold; color: var(--color-accent); } 

        /* --- 9. „É™„Ç∂„É´„ÉàÁîªÈù¢ („Ç≤„Éº„É†„Ç™„Éº„Éê„Éº) --- */
        #results-content { 
            background-color: var(--color-main); 
            padding: 40px; 
            border-radius: 10px; 
            text-align: center; 
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7); 
            max-width: 500px; 
            border: 2px solid var(--color-accent); 
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        #results-content h2 { 
            color: var(--color-error); 
            font-size: 2.5em; 
            margin-top: 0; 
            transition: color 0.3s ease;
        }
        #end-title { 
            font-size: 1.5em; 
            color: var(--color-correct); 
            margin-bottom: 20px; 
            min-height: 1.5em; 
            transition: color 0.3s ease;
        }
        .result-stat { 
            font-size: 1.2em; 
            margin-bottom: 15px; 
        }
        .result-stat span { 
            font-weight: bold; 
            color: var(--color-text); 
            transition: color 0.3s ease;
        }
        #retry-button { 
            padding: 15px 30px; 
            margin-top: 20px; 
            border: 2px solid var(--color-accent); 
            border-radius: 8px; 
            background-color: var(--color-accent); 
            color: var(--color-main); 
            font-size: 1.2em; 
            font-weight: bold; 
            cursor: pointer; 
            transition: all 0.2s; 
            font-family: var(--font-main); 
        }
        #retry-button:hover { 
            background-color: transparent; 
            color: var(--color-accent); 
        }

        /* --- 10. ËÉåÊôØ„Éª„Çª„É¨„ÇØ„Çø„Éº --- */
        body.bg-ocean { background: linear-gradient(160deg, #00c6ff, #0072ff); }
        body.bg-galaxy { background: linear-gradient(135deg, #232526, #414345); }
        body.bg-forest { background: linear-gradient(135deg, #134E5E, #71B280); }
        body.bg-sunset { background: linear-gradient(135deg, #ff7e5f, #feb47b); }
        body.bg-cyber { background: linear-gradient(135deg, #0f0c29, #302b63, #24243e); }
        body.bg-aurora { background: linear-gradient(135deg, #0052D4, #4364F7, #6FB1FC); } 
        body.bg-sakura { background-image: linear-gradient(135deg, #FFB7C5, #FFE4E1); } /* ‚òÖ„Ç§„Éô„É≥„Éà */
        
        @keyframes rainbow-background {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        body.bg-legend {
            background: linear-gradient(135deg, #4b0082, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #8b00ff);
            background-size: 1000% 1000%;
        }
        body.bg-legend.effect-active {
            animation: rainbow-background 15s ease infinite;
        }
        
        .data-management-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }
        
        #background-selector-container, #font-selector-container, #sound-selector-container, 
        #word-pack-selector-container, #effect-selector-container, #theme-selector-container,
        #pet-selector-container, #pet-item-selector-container, #pet-house-selector-container,
        #title-color-selector-container, #bgm-selector-container, #keyboard-skin-selector-container,
        #charm-selector-container, #icon-selector-container { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
            gap: 10px; 
        }
        .bg-select-btn, .font-select-btn, .sound-select-btn, .word-pack-select-btn, 
        .effect-select-btn, .theme-select-btn, .pet-select-btn, .pet-item-select-btn, .pet-house-select-btn,
        .title-color-btn, .bgm-select-btn, .keyboard-skin-select-btn,
        .charm-select-btn, .icon-select-btn { 
            padding: 10px; 
            border: 2px solid var(--color-accent); 
            background: transparent; 
            color: var(--color-text); 
            border-radius: 5px; 
            cursor: pointer; 
            transition: background-color 0.2s, color 0.3s ease, border-color 0.3s ease; 
            font-family: var(--font-main); 
            font-size: 0.9em; 
        }
        .bg-select-btn:hover, .font-select-btn:hover, .sound-select-btn:hover, .word-pack-select-btn:hover, 
        .effect-select-btn:hover, .theme-select-btn:hover, .pet-select-btn:hover, .pet-item-select-btn:hover, 
        .pet-house-select-btn:hover, .title-color-btn:hover, .bgm-select-btn:hover, .keyboard-skin-select-btn:hover,
        .charm-select-btn:hover, .icon-select-btn:hover { background: #ffffff1a; }
        
        .bg-select-btn.active, .font-select-btn.active, .sound-select-btn.active, .word-pack-select-btn.active, 
        .effect-select-btn.active, .theme-select-btn.active, .pet-select-btn.active, .pet-item-select-btn.active,
        .pet-house-select-btn.active, .title-color-btn.active, .bgm-select-btn.active, .keyboard-skin-select-btn.active,
        .charm-select-btn.active, .icon-select-btn.active { 
            background: var(--color-accent); 
            color: var(--color-main); 
            font-weight: bold; 
        }
        .font-select-btn[data-font="font-serif"] { font-family: var(--font-serif); }
        .font-select-btn[data-font="font-rounded"] { font-family: var(--font-rounded); }
        .font-select-btn[data-font="font-cyber"] { font-family: var(--font-cyber); }
        .font-select-btn[data-font="font-wa"] { font-family: var(--font-wa); }
        .font-select-btn[data-font="font-pixel"] { font-family: var(--font-pixel); }


        /* --- 11. „Éë„Éç„É´ (ÁÆ°ÁêÜËÄÖ / Ëá™ÂãïÂÖ•Âäõ / Áµ±Ë®à) --- */
        .admin-panel-section, .auto-type-section {
            margin-top: 20px;
        }
        .admin-panel-section h3, .auto-type-section h3 {
            margin-top: 0;
            margin-bottom: 10px;
            border-bottom: 1px solid var(--color-accent);
            padding-bottom: 5px;
            font-size: 1.1em;
            transition: border-color 0.3s ease;
        }
        .admin-grid-money {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .admin-grid-unlocks {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        .auto-type-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }
        .admin-btn, .auto-type-btn {
            padding: 10px;
            font-size: 0.9em;
            font-weight: bold;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-family: var(--font-main);
            transition: all 0.2s;
            text-align: center;
        }
        .admin-btn.plus { background-color: var(--color-correct); color: var(--color-main); }
        .admin-btn.plus:hover { background-color: #27ae60; }
        .admin-btn.minus { background-color: #f39c12; color: var(--color-main); }
        .admin-btn.minus:hover { background-color: #e67e22; }
        .admin-btn.reset { background-color: var(--color-error); color: var(--color-main); grid-column: 1 / -1; }
        .admin-btn.reset:hover { background-color: #c0392b; }
        .admin-btn.action { background-color: var(--color-accent); color: var(--color-main); }
        .admin-btn.action:hover { background-color: #2980b9; }

        .auto-type-btn.toggle { background-color: var(--color-error); color: var(--color-main); grid-column: 1 / -1; }
        .auto-type-btn.toggle.active { background-color: var(--color-correct); }
        .auto-type-btn.interval { background-color: #7f8c8d; color: var(--color-main); }
        .auto-type-btn.interval.active { background-color: var(--color-accent); }

        #stats-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px 25px;
            padding: 20px;
        }
        #stats-graph-container {
            width: 100%;
            height: 300px;
            background: var(--color-bg-start);
            padding: 10px;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .stat-block {
            background: var(--color-bg-start); 
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--color-accent);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--color-text);
            transition: color 0.3s ease;
        }
        .stat-label {
            font-size: 0.9em;
            color: #ccc;
        }
        
        /* --- 12. „Ç¨„ÉÅ„É£ --- */
        #gacha-section {
            background: var(--color-bg-end);
            padding: 20px;
            margin: 0 20px 30px 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px dashed var(--color-accent);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .gacha-btn {
            padding: 15px 30px;
            font-size: 1.2em;
            font-weight: bold;
            color: white;
            background: linear-gradient(145deg, #ff00ff, #00ffff);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            animation: rainbow-glow 3s linear infinite;
        }
        .gacha-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px #fff;
        }
        .gacha-btn:disabled {
            background: #7f8c8d;
            animation: none;
            cursor: not-allowed;
        }
        #gacha-result-rarity.rare { color: #3498db; }
        #gacha-result-rarity.super-rare { color: #f1c40f; animation: rainbow-text 2s linear infinite; }
        #gacha-result-rarity.legendary { color: #ff00ff; animation: rainbow-text 1s linear infinite; }

        /* --- 13. „É©„É≥„Ç≠„É≥„Ç∞ --- */
        #ranking-mode-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap; /* ‚òÖ„É¢„Éº„ÉâËøΩÂä†ÂØæÂøú */
        }
        #ranking-mode-selector button {
            padding: 8px 15px;
            font-size: 0.9em;
        }
        
        #ranking-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        #ranking-list li {
            display: flex;
            justify-content: space-between;
            align-items: center; /* ‚òÖ */
            padding: 12px;
            background: var(--color-bg-start);
            border-radius: 5px;
            margin-bottom: 8px;
            font-size: 1.1em;
            transition: background-color 0.3s ease;
        }
        #ranking-list li:nth-child(1) { background: #c9b037; color: #333; font-weight: bold; }
        #ranking-list li:nth-child(2) { background: #b4b4b4; color: #333; font-weight: bold; }
        #ranking-list li:nth-child(3) { background: #a0714F; color: #fff; font-weight: bold; }
        
        .rank-name {
            font-weight: bold;
        }
        /* ‚òÖ„Éó„É≠„Éï„Ç£„Éº„É´„Ç¢„Ç§„Ç≥„É≥ */
        .rank-icon {
            font-size: 1.2em;
            margin-right: 10px;
        }
        .rank-score {
            font-weight: bold;
            color: var(--color-correct);
        }
        #ranking-list li:nth-child(-n+3) .rank-score {
            color: inherit;
        }
        
        /* --- 14. UI„ÉÜ„Éº„Éû --- */
        
        /* „ÉÜ„Éº„Éû: „Çµ„Ç§„Éê„Éº */
        body.theme-cyber {
            --color-bg-start: #0f0c29;
            --color-bg-end: #24243e;
            --color-main: #1a1a2e;
            --color-accent: #00ffff;
            --color-correct: #00ff00;
            --color-error: #ff00ff;
            --color-text: #e0e0e0;
            --color-border: #00ffff;
            font-family: var(--font-cyber);
        }
        body.theme-cyber #word-display { background: rgba(0, 255, 255, 0.1); }
        body.theme-cyber #keyboard-container { background: rgba(0, 0, 0, 0.5); }
        body.theme-cyber #xp-bar-container { background: #000; }
        body.theme-cyber .key { background: #333; box-shadow: 0 3px 0 #111; }
        body.theme-cyber .key.highlight { background: var(--color-accent); color: #000; }
        body.theme-cyber #pet-sprite { filter: hue-rotate(180deg) brightness(1.5); }

        /* „ÉÜ„Éº„Éû: ÂíåÈ¢® */
        body.theme-wa {
            --color-bg-start: #fdfbfb;
            --color-bg-end: #ebedee;
            --color-main: #ffffff;
            --color-accent: #c0392b;
            --color-correct: #27ae60;
            --color-error: #c0392b;
            --color-text: #333333;
            --color-border: #8e44ad;
            font-family: var(--font-wa);
            background: #f4f4f4;
        }
        body.theme-wa #sidebar { background: #e0e0e0; box-shadow: -5px 0 15px rgba(0, 0, 0, 0.2);}
        body.theme-wa #word-display { background: rgba(0, 0, 0, 0.05); }
        body.theme-wa #keyboard-container { background: rgba(0, 0, 0, 0.05); }
        body.theme-wa #xp-bar-container { background: #ccc; }
        body.theme-wa .key { background: #fff; color: #333; box-shadow: 0 3px 0 #999; }
        body.theme-wa .key.highlight { background: var(--color-accent); color: #fff; }
        body.theme-wa .modal-content { background: #f9f9f9; }
        body.theme-wa .shop-item, body.theme-wa .stat-block, body.theme-wa .mission-item, body.theme-wa .achievement-item, body.theme-wa .title-item, body.theme-wa #ranking-list li { background: #fff; }
        
        /* „ÉÜ„Éº„Éû: „Éî„ÇØ„Çª„É´ */
        body.theme-pixel {
            --color-bg-start: #222;
            --color-bg-end: #000;
            --color-main: #333;
            --color-accent: #0f0;
            --color-correct: #0f0;
            --color-error: #f00;
            --color-text: #fff;
            --color-border: #0f0;
            font-family: var(--font-pixel);
            image-rendering: pixelated;
        }
        body.theme-pixel .sidebar-btn, body.theme-pixel .mode-btn { border-radius: 0; }
        body.theme-pixel #word-display { border-radius: 0; border: 2px solid var(--color-border); }
        body.theme-pixel #keyboard-container { border-radius: 0; }
        body.theme-pixel .key { border-radius: 0; }
        body.theme-pixel #pet-sprite { image-rendering: pixelated; }

        /* --- 15. Ëª¢Áîü„Çø„Ç§„ÉóÈÅ∏Êäû --- */
        #prestige-choice-container, #prestige-trial-container {
            display: flex;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        .prestige-choice-option {
            flex: 1;
            min-width: 200px;
            padding: 20px;
            border: 2px solid var(--color-border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .prestige-choice-option:hover {
            background-color: var(--color-bg-end);
            transform: translateY(-5px);
        }
        .prestige-choice-option h3 {
            margin-top: 0;
            color: var(--color-accent);
        }
        .prestige-choice-option p {
            font-size: 0.9em;
        }
        #prestige-current-trial {
            margin-top: 20px;
            padding: 10px;
            background: var(--color-bg-start);
            border-radius: 5px;
        }
        #prestige-current-trial-text {
            color: var(--color-accent);
            font-weight: bold;
        }

        /* --- 16. „Ç¥„Éº„Çπ„Éà„Çπ„Ç≥„Ç¢ --- */
        #ghost-score-display {
            position: absolute;
            top: 100px;
            left: 30px;
            font-size: 1.5em;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.5);
            z-index: 5;
        }
        #ghost-score-display.beating {
            color: var(--color-correct);
            animation: pulse 1s infinite;
        }
        #ghost-score-display.losing {
            color: var(--color-error);
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* --- 17. ÂÆüÁ∏æ„Éù„Ç§„É≥„Éà --- */
        #ap-summary {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: var(--color-accent);
            margin-bottom: 20px;
        }
        #ap-rewards-container {
            margin-bottom: 20px;
        }
        #ap-rewards-list {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 10px;
        }
        .ap-reward-item {
            flex: 0 0 150px;
            padding: 10px;
            background: var(--color-bg-start);
            border-radius: 5px;
            text-align: center;
            border: 2px solid var(--color-border);
        }
        .ap-reward-item.claimed {
            background: var(--color-accent);
            color: var(--color-main);
        }
        .ap-reward-item.claimed .ap-reward-name {
            color: var(--color-main);
        }
        .ap-reward-ap {
            font-size: 1.1em;
            font-weight: bold;
        }
        .ap-reward-name {
            font-size: 0.9em;
            color: #ccc;
            margin-top: 5px;
        }

        /* --- 18. „Éö„ÉÉ„Éà --- */
        #pet-container {
            position: fixed;
            top: calc(100vh - 120px); 
            left: 20px;
            width: 100px;
            height: 100px;
            z-index: 50;
            cursor: grab; 
            pointer-events: auto; 
            transition: opacity 0.3s ease;
            user-select: none;
        }
        #pet-container.dragging {
            cursor: grabbing;
            opacity: 0.8;
            transition: none; 
        }
        #pet-sprite {
            width: 100%;
            height: 100%;
            font-size: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
            /* ‚òÖ„Éê„Ç∞‰øÆÊ≠£: ÁµµÊñáÂ≠ó„Åå„Éâ„É©„ÉÉ„Ç∞„Åï„Çå„Å™„ÅÑ„Çà„ÅÜ„Å´ */
            pointer-events: none; 
        }
        #pet-house {
            position: absolute;
            width: 100%;
            height: 100%;
            font-size: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: -1;
            opacity: 0.5;
            pointer-events: none;
        }

        /* „Éö„ÉÉ„Éà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes pet-idle {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        @keyframes pet-happy {
            0%, 100% { transform: scale(1) rotate(0); }
            25% { transform: scale(1.1) rotate(-10deg); }
            75% { transform: scale(1.1) rotate(10deg); }
        }
        @keyframes pet-sad {
            0%, 100% { transform: rotate(0); }
            50% { transform: rotate(15deg); }
        }
        #pet-sprite.idle { animation: pet-idle 2s ease-in-out infinite; }
        #pet-sprite.happy { animation: pet-happy 0.5s ease-in-out; }
        #pet-sprite.sad { animation: pet-sad 0.5s ease-in-out; }
        
        /* „Éö„ÉÉ„ÉàÁùÄ„ÅõÊõø„Åà */
        #pet-item-hat {
            position: absolute;
            top: -10px; /* ÁµµÊñáÂ≠ó„Å´Âêà„Çè„Åõ„Çã */
            left: 0;
            width: 100%;
            height: 50%;
            font-size: 40px; /* ÁµµÊñáÂ≠ó„Å´Âêà„Çè„Åõ„Çã */
            text-align: center;
            pointer-events: none;
        }
        
        /* --- 19. „Éó„É≠„Éï„Ç£„Éº„É´ --- */
        #profile-button {
            display: flex;
            align-items: center;
            padding: 10px;
            background: var(--color-bg-start);
            border-radius: 5px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #profile-button:hover {
            background: var(--color-bg-end);
        }
        #profile-icon {
            font-size: 2em;
            margin-right: 10px;
        }
        #profile-name {
            font-weight: bold;
            font-size: 1.1em;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        #profile-main {
            display: flex;
            align-items: center;
            background: var(--color-bg-start);
            padding: 20px;
            border-radius: 10px;
        }
        #profile-main-icon {
            font-size: 5em;
            margin-right: 20px;
        }
        #profile-main-name {
            font-size: 1.8em;
            margin: 0 0 10px 0;
        }
        #profile-change-name-btn {
            width: auto;
            padding: 5px 8px;
            font-size: 0.6em;
            margin-left: 10px;
        }
        #profile-main-title {
            font-size: 1.1em;
            color: var(--color-accent);
            font-weight: bold;
            margin-bottom: 5px;
        }
        #profile-bonus-summary {
            margin-top: 20px;
        }
        #profile-bonus-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        #profile-bonus-list div {
            background: var(--color-bg-start);
            padding: 10px;
            border-radius: 5px;
        }
        #profile-bonus-list div span {
            color: var(--color-correct);
            font-weight: bold;
        }

        /* --- 20. „Çπ„Ç≠„É´„ÉÑ„É™„Éº --- */
        #skill-tree-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--color-bg-start);
            border-radius: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        #skill-tree-grid {
            position: relative;
            width: 100%;
            height: 500px;
            overflow: auto;
            background: var(--color-bg-end);
            border-radius: 5px;
        }
        .skill-node {
            position: absolute;
            width: 60px;
            height: 60px;
            background: #444;
            border: 3px solid #666;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            transition: all 0.2s;
            z-index: 5;
        }
        .skill-node.unlocked {
            background: var(--color-accent);
            border-color: #fff;
            color: var(--color-main);
        }
        .skill-node.maxed {
            background: #f1c40f;
            border-color: #fff;
            color: #333;
        }
        .skill-node.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .skill-node:hover {
            transform: scale(1.1);
        }
        .skill-line {
            position: absolute;
            background: #666;
            height: 5px;
            transform-origin: 0 50%;
            z-index: 1;
        }
        .skill-line.unlocked {
            background: var(--color-accent);
        }
        #skill-tooltip {
            position: fixed;
            background: #111;
            border: 1px solid var(--color-accent);
            padding: 15px;
            border-radius: 5px;
            max-width: 300px;
            z-index: 100;
            pointer-events: none;
        }
        #skill-tooltip h4 { margin-top: 0; color: var(--color-accent); }
        #skill-tooltip p { margin-bottom: 5px; }
        #skill-tooltip-cost { color: var(--color-correct); }
        #skill-tooltip-status { color: var(--color-error); }
        
        #preset-container { margin: 5px 0; }
        #preset-container .preset-btn-load {
            padding: 5px 10px;
            font-size: 0.9em;
            margin: 0 2px;
            width: auto;
        }
        #preset-container .preset-btn-load.active {
            background: var(--color-correct);
            border-color: var(--color-correct);
        }

        /* --- 21. „ÅäÁü•„Çâ„Åõ„Éª„Éü„ÉÉ„Ç∑„Éß„É≥ --- */
        #news-list-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .news-item {
            background: var(--color-bg-start);
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid var(--color-accent);
        }
        .news-item h3 { margin-top: 0; }
        
        #weekly-mission-container {
            background: var(--color-bg-end);
            padding: 15px;
            border-radius: 5px;
        }
        #weekly-mission-container h3 {
            margin-top: 0;
        }
        #weekly-timer {
            color: var(--color-accent);
        }
        
        /* --- 22. „ÇØ„Ç§„ÉÉ„ÇØ„ÇØ„É¨„Éº„É† --- */
        #quick-claim-container {
            position: fixed;
            bottom: 20px;
            right: 280px;
            background: var(--color-main);
            border: 2px solid var(--color-correct);
            padding: 15px;
            border-radius: 10px;
            z-index: 100;
            display: none; /* JS„Åßflex„Å´Â§âÊõ¥ */
            align-items: center;
            gap: 15px;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #quick-claim-btn {
            padding: 8px 12px;
            background: var(--color-correct);
            border: none;
            border-radius: 5px;
            color: var(--color-main);
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="pet-container">
        <div id="pet-house" class="pet-house-none"></div>
        <div id="pet-sprite" class="idle">üò∫</div>
        <div id="pet-item-hat"></div>
    </div>

    <div id="quick-claim-container" style="display: none;">
        <div id="quick-claim-text"></div>
        <button id="quick-claim-btn">Âèó„ÅëÂèñ„Çã</button>
    </div>

    <div id="main-content">
        <div id="status-bar">
            <div class="status-item"> <div id="score-display">0</div> <div class="sidebar-label">SCORE</div> </div>
            <div class="status-item"> <div id="combo-display">0</div> <div class="sidebar-label">COMBO</div> </div>
            <div class="status-item"> <div id="timer">0.00</div> <div class="sidebar-label" id="timer-label">TIME / LEFT</div> </div>
            <div class="status-item"> <div id="total-typed-display">0</div> <div class="sidebar-label">TOTAL TYPED</div> </div>
        </div>
        
        <div id="fever-timer-display"></div>
        <div id="ghost-score-display" style="display: none;">
            <i class="fas fa-ghost"></i> GHOST: <span>0</span>
        </div>
        
        <div id="item-effect-display" style="text-align: center; color: var(--color-correct); font-weight: bold; min-height: 20px;"></div>
        
        <div id="typing-area">
            <div id="word-display-sub" style="display: none;"></div>
            
            <div id="kanji-display"></div>
            <div id="word-display"></div>
            <input type="text" id="quote-input" readonly placeholder="Type here...">
        </div>
        
        <div id="keyboard-container">
            <div class="keyboard-row">
                <div class="key" data-key="q">Q</div><div class="key" data-key="w">W</div><div class="key" data-key="e">E</div><div class="key" data-key="r">R</div><div class="key" data-key="t">T</div><div class="key" data-key="y">Y</div><div class="key" data-key="u">U</div><div class="key" data-key="i">I</div><div class="key" data-key="o">O</div><div class="key" data-key="p">P</div>
            </div>
            <div class="keyboard-row">
                <div class="key" style="min-width: 40px;"></div>
                <div class="key" data-key="a">A</div><div class="key" data-key="s">S</div><div class="key" data-key="d">D</div><div class="key" data-key="f">F</div><div class="key" data-key="g">G</div><div class="key" data-key="h">H</div><div class="key" data-key="j">J</div><div class="key" data-key="k">K</div><div class="key" data-key="l">L</div>
                <div class="key" style="min-width: 40px;"></div>
            </div>
            <div class="keyboard-row">
                <div class="key" style="min-width: 60px;"></div>
                <div class="key" data-key="z">Z</div><div class="key" data-key="x">X</div><div class="key" data-key="c">C</div><div class="key" data-key="v">V</div><div class="key" data-key="b">B</div><div class="key" data-key="n">N</div><div class="key" data-key="m">M</div><div class="key" data-key=",">,</div><div class="key" data-key=".">.</div><div class="key" data-key="-">-</div>
                <div class="key" style="min-width: 60px;"></div>
            </div>
            <div class="keyboard-row">
                <div class="key" data-key=" ">SPACE</div>
            </div>
        </div>
    </div>

    <div id="sidebar">
        <div id="data-ui">
            <div id="profile-button">
                <div id="profile-icon"></div>
                <div id="profile-name">TYPER</div>
            </div>
            <div class="sidebar-value" id="level-display">Lv. 1</div>
            <div id="xp-bar-container"><div id="xp-bar-progress"></div></div>
            <div class="sidebar-label" id="xp-label">XP: 0 / 100</div>

            <div class="sidebar-value" id="money-display">0</div>
            <div class="sidebar-label"><i class="fas fa-coins"></i> ÊâÄÊåÅÈáë</div>
            
            <div class="sidebar-value" id="high-score-display" style="margin-top: 15px;">0</div>
            <div class="sidebar-label" id="high-score-label">T-30„Éè„Ç§„Çπ„Ç≥„Ç¢</div>
        </div>
        
        <button id="time-mode-btn" class="mode-btn active"><i class="far fa-clock"></i> 30Áßí„É¢„Éº„Éâ</button>
        <button id="word-mode-btn" class="mode-btn"><i class="fas fa-keyboard"></i> 30ÂçòË™û„É¢„Éº„Éâ</button>
        <button id="sudden-death-mode-btn" class="mode-btn"><i class="fas fa-skull-crossbones"></i> „Çµ„Éâ„É≥„Éá„Çπ</button>
        
        <button id="time-attack-mode-btn" class="mode-btn challenge-btn"><i class="fas fa-stopwatch"></i> TA (20ÂçòË™û)</button>
        <button id="accuracy-mode-btn" class="mode-btn challenge-btn"><i class="fas fa-crosshairs"></i> Á≤æÂ∫¶ (1ÂàÜ)</button>
        <button id="english-mode-btn" class="mode-btn challenge-btn"><i class="fas fa-font"></i> Ëã±ÂçòË™û„É¢„Éº„Éâ</button>
        <button id="double-mode-btn" class="mode-btn challenge-btn"><i class="fas fa-clone"></i> „ÉÄ„Éñ„É´</button>
        <button id="fill-mode-btn" class="mode-btn challenge-btn"><i class="fas fa-question"></i> Á©¥Âüã„ÇÅ</button>
        <button id="fast-mode-btn" class="mode-btn challenge-btn"><i class="fas fa-forward"></i> Êó©ÈÄÅ„Çä</button>

        <button id="news-btn" class="sidebar-btn" style="border-color: #2ecc71;"><i class="fas fa-bullhorn"></i> „ÅäÁü•„Çâ„Åõ</button>
        <button id="ranking-btn" class="sidebar-btn" style="border-color: #f1c40f;"><i class="fas fa-medal"></i> „É©„É≥„Ç≠„É≥„Ç∞</button>
        <button id="skill-tree-btn" class="sidebar-btn" style="border-color: #9b59b6;"><i class="fas fa-sitemap"></i> „Çπ„Ç≠„É´ (<span id="skill-point-display">0</span>)</button>

        <button id="shop-btn" class="sidebar-btn"><i class="fas fa-shopping-cart"></i> „Ç∑„Éß„ÉÉ„Éó</button>
        <button id="title-list-btn" class="sidebar-btn"><i class="fas fa-trophy"></i> Áß∞Âè∑‰∏ÄË¶ß</button>
        <button id="mission-btn" class="sidebar-btn"><i class="fas fa-tasks"></i> „Éü„ÉÉ„Ç∑„Éß„É≥</button>
        <button id="achievement-btn" class="sidebar-btn"><i class="fas fa-award"></i> ÂÆüÁ∏æ</button>
        <button id="stats-btn" class="sidebar-btn"><i class="fas fa-chart-bar"></i> Áµ±Ë®à</button>
        <button id="advanced-settings-btn" class="sidebar-btn"><i class="fas fa-cog"></i> Ë©≥Á¥∞Ë®≠ÂÆö</button>
        <button id="custom-mode-btn" class="mode-btn"><i class="fas fa-edit"></i> „Ç´„Çπ„Çø„É†</button>

        <button id="code-btn" class="sidebar-btn" style="margin-top: 15px; border-color: #f39c12;"><i class="fas fa-key"></i> „Ç≥„Éº„Éâ</button>
    
        <div id="auto-type-panel-container" style="display: none; width: 100%; margin-top: 15px; border: 2px solid #f39c12; border-radius: 8px; padding: 10px; box-sizing: border-box;">
            <div class="auto-type-section">
                <h3 style="margin-top: 0;"><i class="fas fa-robot"></i> Ëá™ÂãïÂÖ•Âäõ</h3>
                <button class="auto-type-btn toggle" id="auto-type-toggle">Ëá™ÂãïÂÖ•Âäõ OFF</button>
            </div>
            <div class="auto-type-section">
                <h3><i class="fas fa-tachometer-alt"></i> ÈñìÈöî (ms)</h3>
                <div class="auto-type-grid" id="auto-type-interval-grid">
                    <button class="auto-type-btn interval" data-interval="500">500</button>
                    <button class="auto-type-btn interval active" data-interval="300">300</button>
                    <button class="auto-type-btn interval" data-interval="200">200</button>
                    <button class="auto-type-btn interval" data-interval="100">100</button>
                    <button class="auto-type-btn interval" data-interval="50">50</button>
                    <button class="auto-type-btn interval" data-interval="10">10</button>
                </div>
            </div>
        </div>
    </div>

    <div id="end-screen-overlay" class="modal-overlay" style="display: none;">
        <div id="results-content">
            <h2 id="end-result-title">GAME OVER</h2>
            <div id="end-title"></div>
            <div class="result-stat" id="end-wpm">WPM: <span>0</span></div>
            <div class="result-stat" id="end-accuracy">Accuracy: <span>0%</span></div>
            <div class="result-stat" id="end-total-typed">Á∑è„Çø„Ç§„ÉóÊï∞: <span>0</span></div>
            <div class="result-stat" id="end-score">„Çπ„Ç≥„Ç¢: <span>0</span></div>
            <button id="share-button" class="sidebar-btn" style="width: auto; background-color: #1DA1F2; margin-top: 10px; margin-bottom: 20px; display: inline-block; text-align: center;"><i class="fas fa-share-alt"></i> „Çπ„Ç≥„Ç¢„Çí„Ç∑„Çß„Ç¢</button>
            <button id="retry-button">„É™„Éà„É©„Ç§ / Space„ÅßÈñãÂßã</button>
        </div>
    </div>
    
    <div id="shop-overlay" class="modal-overlay" style="display: none;">
        <div id="shop-content" class="modal-content">
            <h2><i class="fas fa-shopping-cart"></i> „Ç∑„Éß„ÉÉ„Éó</h2>
            <button class="close-btn" id="close-shop-btn">&times;</button>
            <div id="gacha-section">
                <h3><i class="fas fa-box-open"></i> „É©„É≥„ÉÄ„É†„Éú„ÉÉ„ÇØ„Çπ</h3>
                <p>„É¨„Ç¢„Å™„Ç¢„Ç§„ÉÜ„É†„ÅåÊâã„Å´ÂÖ•„Çã„Åã„ÇÇÔºü<span id="gacha-bonus-text" style="color: var(--color-correct); font-weight: bold; display: none;"> („É¨„Ç¢ÁéáUP‰∏≠!)</span></p>
                <button id="gacha-pull-btn" class="gacha-btn">1ÂõûÂºï„Åè (5,000 G)</button>
            </div>
            <h2><i class="fas fa-paint-brush"></i> „Ç¢„Ç§„ÉÜ„É†‰∏ÄË¶ß</h2>
            <div id="shop-grid"></div> 
        </div>
    </div>

    <div id="gacha-result-overlay" class="modal-overlay panel-modal" style="display: none;">
        <div id="gacha-result-content" class="modal-content" style="text-align: center;">
            <button class="close-btn" id="close-gacha-result-btn">&times;</button>
            <h2 id="gacha-result-rarity"></h2>
            <div id="gacha-result-item" style="font-size: 1.8em; font-weight: bold; margin: 20px 0;"></div>
            <div id="gacha-result-description" style="font-size: 1em; color: #ccc;"></div>
        </div>
    </div>

    <div id="ranking-overlay" class="modal-overlay panel-modal" style="display: none;">
        <div id="ranking-content" class="modal-content">
            <h2><i class="fas fa-medal"></i> „É©„É≥„Ç≠„É≥„Ç∞</h2>
            <button class="close-btn" id="close-ranking-btn">&times;</button>
            <div id="ranking-mode-selector" style="text-align: center; margin-bottom: 20px;"></div>
            <ol id="ranking-list"></ol>
        </div>
    </div>
    
    <div id="news-overlay" class="modal-overlay panel-modal" style="display: none;">
        <div id="news-content" class="modal-content">
            <h2><i class="fas fa-bullhorn"></i> „ÅäÁü•„Çâ„Åõ</h2>
            <button class="close-btn" id="close-news-btn">&times;</button>
            <div id="news-list-container"></div>
        </div>
    </div>

    <div id="skill-tree-overlay" class="modal-overlay" style="display: none;">
        <div id="skill-tree-content" class="modal-content">
            <h2><i class="fas fa-sitemap"></i> „Çπ„Ç≠„É´„ÉÑ„É™„Éº</h2>
            <button class="close-btn" id="close-skill-tree-btn">&times;</button>
            
            <div id="skill-tree-header">
                <div>
                    ÊâÄÊåÅ„Çπ„Ç≠„É´„Éù„Ç§„É≥„Éà: <span id="skill-points-available">0</span> SP
                    (Ëª¢ÁîüLv. <span id="skill-tree-prestige-level">0</span>)
                </div>
                <div id="preset-container">
                    <strong>„Éó„É™„Çª„ÉÉ„Éà:</strong>
                    <button class="preset-btn-load active" data-id="0">1</button>
                    <button class="preset-btn-load" data-id="1">2</button>
                    <button class="preset-btn-load" data-id="2">3</button>
                    <button id="save-preset-btn" class="sidebar-btn" style="width: auto; padding: 5px 10px; margin-left: 10px;"><i class="fas fa-save"></i> ‰øùÂ≠ò</button>
                </div>
                <div>
                    <button id="skill-reset-btn" class="sidebar-btn" style="width: auto; background-color: var(--color-error);"><i class="fas fa-undo"></i> „Çπ„Ç≠„É´„É™„Çª„ÉÉ„Éà (P.Lv x 1000 G)</button>
                </div>
            </div>

            <div id="skill-tree-grid">
                </div>
            
            <div id="skill-tooltip" style="display: none;">
                <h4 id="skill-tooltip-name"></h4>
                <p id="skill-tooltip-desc"></p>
                <p id="skill-tooltip-cost"></p>
                <p id="skill-tooltip-status"></p>
            </div>
        </div>
    </div>
    
    <div id="profile-overlay" class="modal-overlay panel-modal" style="display: none;">
        <div id="profile-content" class="modal-content">
            <h2><i class="fas fa-user"></i> „Éó„É≠„Éï„Ç£„Éº„É´</h2>
            <button class="close-btn" id="close-profile-btn">&times;</button>
            <div id="profile-main">
                <div id="profile-main-icon"></div>
                <div id="profile-main-info">
                    <h3 id="profile-main-name">TYPER <button id="profile-change-name-btn" class="sidebar-btn"><i class="fas fa-edit"></i></button></h3>
                    <div id="profile-main-title"></div>
                    <div>Lv. <span id="profile-main-level">1</span> <span id="profile-main-prestige"></span></div>
                    <div>AP: <span id="profile-main-ap">0</span></div>
                </div>
            </div>
            <div id="profile-bonus-summary">
                <h4>ÁèæÂú®„ÅÆÊ∞∏Á∂ö„Éú„Éº„Éä„Çπ</h4>
                <div id="profile-bonus-list"></div>
            </div>
        </div>
    </div>

    <div id="title-list-overlay" class="modal-overlay" style="display: none;">
        <div id="title-list-content" class="modal-content">
            <h2><i class="fas fa-trophy"></i> Áß∞Âè∑‰∏ÄË¶ß</h2>
            <button class="close-btn" id="close-title-list-btn">&times;</button>
            <div id="title-list-container"></div> 
            <h3 style="margin-top: 20px;">Áß∞Âè∑„Ç´„É©„Éº</h3>
            <div id="title-color-selector-container"></div>
        </div>
    </div>

    <div id="mission-overlay" class="modal-overlay" style="display: none;">
        <div id="mission-content" class="modal-content">
            <h2><i class="fas fa-tasks"></i> „Éü„ÉÉ„Ç∑„Éß„É≥</h2>
            <button class="close-btn" id="close-mission-btn">&times;</button>
            <div id="weekly-mission-container">
                <h3><i class="fas fa-calendar-week"></i> ‰ªäÈÄ±„ÅÆ„Éü„ÉÉ„Ç∑„Éß„É≥ (<span id="weekly-timer"></span>)</h3>
                <div id="weekly-mission-list"></div>
            </div>
            <hr style="border-color: var(--color-border); margin: 20px 0;">
            <h3><i class="fas fa-calendar-day"></i> „Éá„Ç§„É™„Éº„Éü„ÉÉ„Ç∑„Éß„É≥</h3>
            <div id="mission-list-container"></div> 
        </div>
    </div>

    <div id="achievement-overlay" class="modal-overlay" style="display: none;">
        <div id="achievement-content" class="modal-content">
            <h2><i class="fas fa-award"></i> ÂÆüÁ∏æ</h2>
            <button class="close-btn" id="close-achievement-btn">&times;</button>
            <div id="ap-summary">
                Á¥ØË®àÂÆüÁ∏æ„Éù„Ç§„É≥„Éà: <span id="total-ap-display">0</span> AP
            </div>
            <div id="ap-rewards-container">
                <h3>Á¥ØË®àAPÂ†±ÈÖ¨</h3>
                <div id="ap-rewards-list"></div>
            </div>
            <hr style="border-color: var(--color-border); margin: 20px 0;">
            <div id="achievement-list-container"></div> 
        </div>
    </div>

    <div id="stats-overlay" class="modal-overlay panel-modal" style="display: none;">
        <div id="stats-content" class="modal-content">
            <h2><i class="fas fa-chart-bar"></i> Áµ±Ë®à</h2>
            <button class="close-btn" id="close-stats-btn">&times;</button>
            <div id="stats-graph-container">
                <canvas id="stats-graph"></canvas>
            </div>
            <hr style="border-color: var(--color-border); margin: 20px 0;">
            <div id="stats-container"></div>
        </div>
    </div>

    <div id="prestige-choice-overlay" class="modal-overlay panel-modal" style="display: none;">
        <div id="prestige-choice-content" class="modal-content" style="text-align: center;">
            <h2><i class="fas fa-star"></i> „Éó„É¨„Çπ„ÉÜ„Éº„Ç∏ Lv. <span id="prestige-modal-level">1</span></h2>
            <button class="close-btn" id="close-prestige-choice-btn">&times;</button>
            
            <div id="prestige-type-choice" style="display: none;">
                <p>ÊúÄÂàù„ÅÆËª¢Áîü„Åß„Åô„ÄÇ„Å©„Å°„Çâ„ÅÆÈÅì„ÇíÈÅ∏„Å≥„Åæ„Åô„ÅãÔºü („Åì„ÅÆÈÅ∏Êäû„ÅØÊ∞∏Á∂ö„Åß„Åô)</p>
                <div id="prestige-choice-container">
                    <div class="prestige-choice-option" id="prestige-choice-standard">
                        <h3><i class="fas fa-tachometer-alt"></i> „Çπ„Çø„É≥„ÉÄ„Éº„ÉâËª¢Áîü</h3>
                        <p>„Çπ„Ç≥„Ç¢„Å®XP„ÅÆÁç≤ÂæóÈáè„Å´Ê∞∏‰πÖ„Éú„Éº„Éä„Çπ„ÇíÂæó„Çã„ÄÅÁéãÈÅì„ÅÆËª¢Áîü„Åß„Åô„ÄÇ</p>
                    </div>
                    <div class="prestige-choice-option" id="prestige-choice-wealth">
                        <h3><i class="fas fa-gem"></i> ÂØåË±™„ÅÆËª¢Áîü</h3>
                        <p>„Ç¨„ÉÅ„É£„ÅÆ„É¨„Ç¢„Ç¢„Ç§„ÉÜ„É†ÊéíÂá∫Áéá„ÅåÊ∞∏Á∂öÁöÑ„Å´‰∏äÊòá„Åô„Çã„ÄÅ„Ç≥„É¨„ÇØ„Çø„ÉºÂêë„Åë„ÅÆËª¢Áîü„Åß„Åô„ÄÇ</p>
                    </div>
                </div>
            </div>

            <div id="prestige-trial-choice" style="display: none;">
                <p>Ëª¢Áîü„ÅÆ„ÄåË©¶Á∑¥„Äç„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇË©¶Á∑¥„ÇíÈÅîÊàê„Åó„Å¶Ëª¢Áîü„Åô„Çã„Å®„ÄÅÁç≤Âæó„Çπ„Ç≠„É´„Éù„Ç§„É≥„Éà„ÅåÂ¢óÂä†„Åó„Åæ„Åô„ÄÇ</p>
                <div id="prestige-trial-container">
                    <div class="prestige-choice-option" id="prestige-trial-none">
                        <h3><i class="fas fa-running"></i> Ë©¶Á∑¥„Å™„Åó (x1.0)</h3>
                        <p>Ë©¶Á∑¥„ÇíË°å„Çè„Åö„ÄÅÈÄöÂ∏∏Èáè„ÅÆ„Çπ„Ç≠„É´„Éù„Ç§„É≥„ÉàÔºà<span class="trial-sp-reward">1</span> SPÔºâ„ÇíÁç≤Âæó„Åó„Å¶Ëª¢Áîü„Åó„Åæ„Åô„ÄÇ</p>
                    </div>
                    <div class="prestige-choice-option" id="prestige-trial-combo">
                        <h3><i class="fas fa-link"></i> „Ç≥„É≥„Éú„ÅÆË©¶Á∑¥ (x2.0)</h3>
                        <p>„ÄåËª¢ÁîüÂæå„ÄÅLv. 30„Å´„Å™„Çã„Åæ„Åß„Å´**100„Ç≥„É≥„Éú**„ÇíÈÅîÊàê„Åô„Çã„Äç</p>
                        <p>ÈÅîÊàê„Åß <span class="trial-sp-reward">2</span> SP Áç≤Âæó„ÄÇ</p>
                    </div>
                    <div class="prestige-choice-option" id="prestige-trial-perfect">
                        <h3><i class="fas fa-check-double"></i> ÂÆåÂÖ®ÁÑ°Ê¨†„ÅÆË©¶Á∑¥ (x3.0)</h3>
                        <p>„ÄåËª¢ÁîüÂæå„ÄÅLv. 30„Å´„Å™„Çã„Åæ„Åß„Å´**30Áßí„É¢„Éº„Éâ„Çí„Éé„Éº„Éü„Çπ**„Åß„ÇØ„É™„Ç¢„Åô„Çã„Äç</p>
                        <p>ÈÅîÊàê„Åß <span class="trial-sp-reward">3</span> SP Áç≤Âæó„ÄÇ</p>
                    </div>
                </div>
                <div id="prestige-current-trial" style="margin-top: 20px;">
                    <h4><i class="fas fa-tasks"></i> ÁèæÂú®„ÅÆË©¶Á∑¥</h4>
                    <p id="prestige-current-trial-text">„Å™„Åó</p>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-overlay" class="modal-overlay" style="display: none;">
        <div id="settings-content" class="modal-content">
            <h2><i class="fas fa-cog"></i> Ë©≥Á¥∞Ë®≠ÂÆö</h2>
            <button class="close-btn" id="close-settings-btn">&times;</button>
            <div style="margin-top: 20px;">
                <button id="pop-mode-btn" class="sidebar-btn" style="width: auto;"><i class="fas fa-bolt"></i> ÊºîÂá∫: „É©„É≥„ÉÄ„É†</button>
                
                <button id="furigana-toggle-btn" class="sidebar-btn" style="width: auto; margin-top: 10px;">
                    <i class="fas fa-eye"></i> „Åµ„Çä„Åå„Å™: ON
                </button>

                <button id="bgm-toggle-btn" class="sidebar-btn" style="width: auto; margin-top: 10px;">
                    <i class="fas fa-music"></i> BGM: ON
                </button>

                <button id="legend-effect-btn" class="sidebar-btn" style="display: none; width: auto; margin-top: 10px; border-color: #f1c40f;">
                    <i class="fas fa-magic"></i> ‰ºùË™¨„Ç®„Éï„Çß„ÇØ„Éà: ON
                </button>

                <h3 style="margin-top: 30px;">„ÅäÂÆà„ÇäË£ÖÂÇô</h3>
                <div id="charm-selector-container"></div>

                <h3 style="margin-top: 30px;">„ÉÜ„Éº„Éû („Çπ„Ç≠„É≥)</h3>
                <div id="theme-selector-container"></div>
                
                <h3 style="margin-top: 30px;">„Éö„ÉÉ„ÉàË®≠ÂÆö</h3>
                <div id="pet-selector-container"></div>
                <h4 style="margin-top: 15px;">„Éö„ÉÉ„ÉàÁùÄ„ÅõÊõø„Åà</h4>
                <div id="pet-item-selector-container"></div>
                <h4 style="margin-top: 15px;">„Éö„ÉÉ„Éà„ÅÆÂÆ∂</h4>
                <div id="pet-house-selector-container"></div>
                
                <h3 style="margin-top: 30px;">„Éó„É¨„Ç§„É§„Éº„Ç¢„Ç§„Ç≥„É≥</h3>
                <div id="icon-selector-container"></div>

                <h3 style="margin-top: 30px;">„Éù„ÉÉ„Éó„Ç®„Éï„Çß„ÇØ„ÉàÂ§âÊõ¥</h3>
                <div id="effect-selector-container"></div>
                
                <h3 style="margin-top: 30px;">ÂçòË™û„Éë„ÉÉ„ÇØ</h3>
                <div id="word-pack-selector-container"></div>

                <h3 style="margin-top: 30px;">„Éï„Ç©„É≥„ÉàÂ§âÊõ¥</h3>
                <div id="font-selector-container"></div>
                
                <h3 style="margin-top: 30px;">„Çø„Ç§„ÉóÈü≥Â§âÊõ¥</h3>
                <div id="sound-selector-container"></div>
                
                <h3 style="margin-top: 30px;">BGMÂ§âÊõ¥ („Ç∏„É•„Éº„ÇØ„Éú„ÉÉ„ÇØ„Çπ)</h3>
                <div id="bgm-selector-container"></div>

                <h3 style="margin-top: 30px;">„Ç≠„Éº„Éú„Éº„Éâ„Çπ„Ç≠„É≥Â§âÊõ¥</h3>
                <div id="keyboard-skin-selector-container"></div>

                <h3 style="margin-top: 30px;">ËÉåÊôØ„ÉÜ„Éº„Éû</h3>
                <div id="background-selector-container"></div> 
                
                <h3 style="margin-top: 30px;">Á∑¥Áøí</h3>
                <div id="practice-container">
                    <button id="weak-word-practice-btn" class="sidebar-btn" style="width: auto;"><i class="fas fa-dumbbell"></i> Ëã¶ÊâãÂçòË™ûÁ∑¥Áøí</button>
                </div>

                <h3 style="margin-top: 30px;">„Éá„Éº„ÇøÁÆ°ÁêÜ</h3>
                <div class="data-management-grid">
                    <button id="export-button" class="sidebar-btn" style="width: auto; background-color: #f39c12;"><i class="fas fa-download"></i> „Éá„Éº„ÇøÊõ∏„ÅçÂá∫„Åó (.sav)</button>
                    <button onclick="document.getElementById('import-input').click()" class="sidebar-btn" style="width: auto; background-color: #3498db;"><i class="fas fa-upload"></i> „Éá„Éº„ÇøË™≠„ÅøËæº„Åø</button>
                    <button id="delete-data-btn" class="sidebar-btn" style="width: auto; background-color: #e74c3c;"><i class="fas fa-trash-alt"></i> ÂÖ®„Éá„Éº„ÇøÂâäÈô§</button>
                </div>
                <input type="file" id="import-input" accept=".sav" style="display: none;">
                
                <div id="custom-word-section" style="margin-top: 20px;">
                    <h4>„Ç´„Çπ„Çø„É†„ÅäÈ°åÔºà„ÄåÊº¢Â≠ó[„Çà„Åø]„ÄçÂΩ¢Âºè„ÅßÂÖ•ÂäõÔºâ</h4>
                    <textarea id="custom-textarea" rows="5" style="width: 100%; box-sizing: border-box; font-family: var(--font-main); font-size: 1em; background: var(--color-bg-start); color: var(--color-text); border: 1px solid var(--color-border); border-radius: 5px;" placeholder="‰æãÔºöÊó•Êú¨[„Å´„Åª„Çì]&#10;ÂØøÂè∏[„Åô„Åó]&#10;„Çø„Ç§„Éî„É≥„Ç∞"></textarea>
                    <button id="start-custom-btn" class="sidebar-btn" style="width: auto; background-color: var(--color-correct); margin-top: 10px;"><i class="fas fa-play"></i> „Åì„ÅÆ„ÅäÈ°å„ÅßÈñãÂßã</button>
                </div>
            
                <h3 style="margin-top: 30px;">„Éó„É¨„Çπ„ÉÜ„Éº„Ç∏</h3>
                <button id="prestige-btn" class="sidebar-btn" style="width: 100%; background-color: #e67e22; border-color: #f39c12; display: none;"><i class="fas fa-star"></i> „Éó„É¨„Çπ„ÉÜ„Éº„Ç∏ (Lv. 100„ÅßÂÆüË°åÂèØ)</button>
            </div>
        </div>
    </div>

    <div id="admin-panel-overlay" class="modal-overlay panel-modal" style="display: none;">
        <div id="admin-panel-content" class="modal-content">
            <h2><i class="fas fa-cogs"></i> ÁÆ°ÁêÜËÄÖ„Éë„Éç„É´</h2>
            <button class="close-btn" id="close-admin-panel-btn">&times;</button>
            <p>„Çª„Éº„Éñ„Éá„Éº„Çø„ÅÆÂÄ§„ÇíÁõ¥Êé•Â§âÊõ¥„Åó„Åæ„Åô„ÄÇ</p>

            <div id="admin-panel-container">
                <div class="admin-panel-section">
                    <h3><i class="fas fa-coins"></i> ÊâÄÊåÅÈáë</h3>
                    <div class="admin-grid-money">
                        <button class="admin-btn plus" data-action="money" data-value="1000">+1,000 G</button>
                        <button class="admin-btn plus" data-action="money" data-value="100000">+100,000 G</button>
                        <button class="admin-btn plus" data-action="money" data-value="1000000">+1,000,000 G</button>
                        <button class="admin-btn reset" data-action="money" data-value="reset">ÊâÄÊåÅÈáë„Çí 0 „Å´„Åô„Çã</button>
                    </div>
                </div>

                <div class="admin-panel-section">
                    <h3><i class="fas fa-level-up-alt"></i> „É¨„Éô„É´ & XP</h3>
                    <div class="admin-grid-unlocks">
                        <button class="admin-btn plus" data-action="xp" data-value="1000">+1,000 XP</button>
                        <button class="admin-btn plus" data-action="xp" data-value="100000">+100,000 XP</button>
                        <button class="admin-btn action" data-action="level" data-value="100">Lv. 100 „Å´Ë®≠ÂÆö</button>
                        <button class="admin-btn reset" data-action="level" data-value="reset">Lv. 1 „Å´„É™„Çª„ÉÉ„Éà</button>
                    </div>
                </div>
                
                <div class="admin-panel-section">
                    <h3><i class="fas fa-sitemap"></i> „Çπ„Ç≠„É´</h3>
                    <div class="admin-grid-unlocks">
                        <button class="admin-btn plus" data-action="sp" data-value="1">+1 SP</button>
                        <button class="admin-btn plus" data-action="sp" data-value="10">+10 SP</button>
                    </div>
                </div>

                <div class="admin-panel-section">
                    <h3><i class="fas fa-unlock-alt"></i> Ëß£ÊîæË®≠ÂÆö</h3>
                    <div class="admin-grid-unlocks">
                        <button class="admin-btn action" data-action="unlock-all">ÂÖ®„Ç¢„Ç§„ÉÜ„É†/„Éë„ÉÉ„ÇØËß£Êîæ</button>
                        <button class="admin-btn action" data-action="lock-all">ÂÖ®„Ç¢„Ç§„ÉÜ„É†/„Éë„ÉÉ„ÇØÂâäÈô§</button>
                        <button class="admin-btn action" data-action="unlock-titles">Áß∞Âè∑ ÂÖ®Áç≤Âæó</button>
                        <button class="admin-btn action" data-action="lock-titles">Áß∞Âè∑ ÂÖ®ÂâäÈô§</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <audio id="pop-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-popcorn-pop-20.mp3" preload="auto"></audio>
    <audio id="boost-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-bonus-alert-353.mp3" preload="auto"></audio>
    <audio id="miss-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-cartoon-spring-boing-56.mp3" preload="auto"></audio>
    <audio id="shield-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-video-game-power-up-3164.mp3" preload="auto"></audio>
    
    <audio id="pop-sound-2" src="https://assets.mixkit.co/sfx/preview/mixkit-fast-thin-click-1123.mp3" preload="auto"></audio>
    <audio id="pop-sound-3" src="https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3" preload="auto"></audio>
    <audio id="levelup-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-video-game-win-2016.mp3" preload="auto"></audio>
    <audio id="reward-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-video-game-treasure-2066.mp3" preload="auto"></audio>
    <audio id="gacha-normal-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-retro-arcade-casino-notification-211.mp3" preload="auto"></audio>
    <audio id="gacha-rare-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-whip-whoosh-1498.mp3" preload="auto"></audio>
    <audio id="gacha-super-rare-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-fantasy-game-success-notification-270.mp3" preload="auto"></audio>
    <audio id="skill-unlock-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-magic-sweep-game-trophy-257.mp3" preload="auto"></audio>
    
    <audio id="bgm-audio" loop></audio>
    <audio id="bgm-audio-2" loop></audio>
    <audio id="bgm-audio-3" loop></audio>

    <script>
/* ----------------------------------------------------- */
        /* JavaScript: „Ç≤„Éº„É†„É≠„Ç∏„ÉÉ„ÇØ (ÂÆåÂÖ®‰øÆÊ≠£Áâà v14) */
        /* ----------------------------------------------------- */
        
        // --- 1. ÂÆöÊï∞„Å®DOMË¶ÅÁ¥†„ÅÆÂèñÂæó ---
        const STORAGE_KEY = 'pop-typer-data-v14-full-bugfix'; // „Éê„Éº„Ç∏„Éß„É≥„Ç¢„ÉÉ„Éó
        const TOTAL_TITLES = 10;
        const XP_PER_CHAR = 1; // 1ÊñáÂ≠ó„ÅÇ„Åü„Çä„ÅÆXP
        const XP_PER_WORD = 10; // 1ÂçòË™û„ÇØ„É™„Ç¢„ÅÇ„Åü„Çä„ÅÆXP
        const LEVEL_BASE_XP = 100; // „É¨„Éô„É´1‚Üí2„Å´ÂøÖË¶Å„Å™XP
        const MAX_LEVEL = 100; // „Éó„É¨„Çπ„ÉÜ„Éº„Ç∏ÂèØËÉΩ„Å™„É¨„Éô„É´
        const MAX_PRESTIGE_LEVEL = 20; // ‚òÖËª¢Áîü„É¨„Éô„É´‰∏äÈôê
        const GACHA_COST = 5000; 

        // DOM: „É°„Ç§„É≥„Ç≤„Éº„É†
        const moneyDisplay = document.getElementById('money-display');
        const highScoreDisplay = document.getElementById('high-score-display'); 
        const highScoreLabel = document.getElementById('high-score-label'); 
        const scoreDisplay = document.getElementById('score-display');
        const comboDisplay = document.getElementById('combo-display');
        const timerLabel = document.getElementById('timer-label'); 
        const kanjiDisplay = document.getElementById('kanji-display'); 
        const wordDisplayElement = document.getElementById('word-display');
        const wordDisplaySub = document.getElementById('word-display-sub'); // ‚òÖ„ÉÄ„Éñ„É´„É¢„Éº„Éâ
        const totalTypedDisplay = document.getElementById('total-typed-display'); 
        const quoteInputElement = document.getElementById('quote-input');
        const keyboardContainer = document.getElementById('keyboard-container');
        const mainContent = document.getElementById('main-content');
        const feverTimerDisplay = document.getElementById('fever-timer-display');
        
        // DOM: „Çµ„Ç¶„É≥„Éâ
        const popSound = document.getElementById('pop-sound');
        const popSound2 = document.getElementById('pop-sound-2');
        const popSound3 = document.getElementById('pop-sound-3');
        const boostSound = document.getElementById('boost-sound');
        const missSound = document.getElementById('miss-sound');
        const shieldSound = document.getElementById('shield-sound');
        const levelupSound = document.getElementById('levelup-sound');
        const rewardSound = document.getElementById('reward-sound'); 
        const gachaNormalSound = document.getElementById('gacha-normal-sound');
        const gachaRareSound = document.getElementById('gacha-rare-sound');
        const gachaSuperRareSound = document.getElementById('gacha-super-rare-sound');
        const skillUnlockSound = document.getElementById('skill-unlock-sound');
        const bgmAudio = document.getElementById('bgm-audio'); 
        const bgmAudio2 = document.getElementById('bgm-audio-2'); 
        const bgmAudio3 = document.getElementById('bgm-audio-3'); 
        
        // DOM: Áµ±Ë®à
        const statsBtn = document.getElementById('stats-btn');
        const statsOverlay = document.getElementById('stats-overlay');
        const closeStatsBtn = document.getElementById('close-stats-btn');
        const statsContainer = document.getElementById('stats-container');
        const statsGraphCanvas = document.getElementById('stats-graph');
        let statsChart;

        // DOM: „É¨„Éô„É´
        const levelDisplay = document.getElementById('level-display');
        const xpLabel = document.getElementById('xp-label');
        const xpBarProgress = document.getElementById('xp-bar-progress');
        
        // DOM: „Ç´„Çπ„Çø„É†
        const customModeBtn = document.getElementById('custom-mode-btn');
        const customTextarea = document.getElementById('custom-textarea');
        const startCustomBtn = document.getElementById('start-custom-btn');
        
        // DOM: „Éó„É¨„Çπ„ÉÜ„Éº„Ç∏
        const prestigeBtn = document.getElementById('prestige-btn');
        const prestigeChoiceOverlay = document.getElementById('prestige-choice-overlay');
        const closePrestigeChoiceBtn = document.getElementById('close-prestige-choice-btn');
        const prestigeModalLevel = document.getElementById('prestige-modal-level');
        const prestigeTypeChoice = document.getElementById('prestige-type-choice');
        const prestigeTrialChoice = document.getElementById('prestige-trial-choice');
        const prestigeChoiceStandard = document.getElementById('prestige-choice-standard');
        const prestigeChoiceWealth = document.getElementById('prestige-choice-wealth');
        const prestigeTrialNone = document.getElementById('prestige-trial-none');
        const prestigeTrialCombo = document.getElementById('prestige-trial-combo');
        const prestigeTrialPerfect = document.getElementById('prestige-trial-perfect');
        const prestigeCurrentTrialText = document.getElementById('prestige-current-trial-text');
        
        // DOM: „Ç¨„ÉÅ„É£
        const gachaPullBtn = document.getElementById('gacha-pull-btn');
        const gachaResultOverlay = document.getElementById('gacha-result-overlay');
        const closeGachaResultBtn = document.getElementById('close-gacha-result-btn');
        const gachaResultRarity = document.getElementById('gacha-result-rarity');
        const gachaResultItem = document.getElementById('gacha-result-item');
        const gachaResultDescription = document.getElementById('gacha-result-description');
        const gachaBonusText = document.getElementById('gacha-bonus-text');

        // DOM: „É©„É≥„Ç≠„É≥„Ç∞
        const rankingBtn = document.getElementById('ranking-btn');
        const rankingOverlay = document.getElementById('ranking-overlay');
        const closeRankingBtn = document.getElementById('close-ranking-btn');
        const rankingModeSelector = document.getElementById('ranking-mode-selector');
        const rankingList = document.getElementById('ranking-list');
        
        // DOM: ÂÆüÁ∏æ„Éù„Ç§„É≥„Éà (AP)
        const totalApDisplay = document.getElementById('total-ap-display');
        const apRewardsList = document.getElementById('ap-rewards-list');

        // DOM: „Éö„ÉÉ„Éà
        const petContainer = document.getElementById('pet-container');
        const petSprite = document.getElementById('pet-sprite');
        const petItemHat = document.getElementById('pet-item-hat');
        const petHouse = document.getElementById('pet-house');

        // DOM: „Ç¥„Éº„Çπ„Éà
        const ghostScoreDisplay = document.getElementById('ghost-score-display');

        // DOM: „Çπ„Ç≠„É´„ÉÑ„É™„Éº
        const skillTreeBtn = document.getElementById('skill-tree-btn');
        const skillPointDisplay = document.getElementById('skill-point-display');
        const skillTreeOverlay = document.getElementById('skill-tree-overlay');
        const closeSkillTreeBtn = document.getElementById('close-skill-tree-btn');
        const skillPointsAvailable = document.getElementById('skill-points-available');
        const skillTreePrestigeLevel = document.getElementById('skill-tree-prestige-level');
        const skillResetBtn = document.getElementById('skill-reset-btn');
        const skillTreeGrid = document.getElementById('skill-tree-grid');
        const skillTooltip = document.getElementById('skill-tooltip');
        
        // DOM: „Éó„É™„Çª„ÉÉ„Éà
        const presetContainer = document.getElementById('preset-container');
        const savePresetBtn = document.getElementById('save-preset-btn');
        
        // DOM: „ÅäÁü•„Çâ„Åõ
        const newsBtn = document.getElementById('news-btn');
        const newsOverlay = document.getElementById('news-overlay');
        const closeNewsBtn = document.getElementById('close-news-btn');
        const newsListContainer = document.getElementById('news-list-container');
        
        // DOM: „Éó„É≠„Éï„Ç£„Éº„É´
        const profileButton = document.getElementById('profile-button');
        const profileOverlay = document.getElementById('profile-overlay');
        const closeProfileBtn = document.getElementById('close-profile-btn');
        const profileIcon = document.getElementById('profile-icon');
        const profileName = document.getElementById('profile-name');
        const profileMainIcon = document.getElementById('profile-main-icon');
        const profileMainName = document.getElementById('profile-main-name');
        const profileChangeNameBtn = document.getElementById('profile-change-name-btn');
        const profileMainTitle = document.getElementById('profile-main-title');
        const profileMainLevel = document.getElementById('profile-main-level');
        const profileMainPrestige = document.getElementById('profile-main-prestige');
        const profileMainAp = document.getElementById('profile-main-ap');
        const profileBonusList = document.getElementById('profile-bonus-list');
        
        // DOM: „Éü„ÉÉ„Ç∑„Éß„É≥
        const missionBtn = document.getElementById('mission-btn');
        const missionOverlay = document.getElementById('mission-overlay');
        const closeMissionBtn = document.getElementById('close-mission-btn');
        const weeklyMissionList = document.getElementById('weekly-mission-list');
        const weeklyTimer = document.getElementById('weekly-timer');
        const quickClaimContainer = document.getElementById('quick-claim-container');
        const quickClaimText = document.getElementById('quick-claim-text');
        const quickClaimBtn = document.getElementById('quick-claim-btn');

        // DOM: Áß∞Âè∑
        const titleListBtn = document.getElementById('title-list-btn');
        const titleListOverlay = document.getElementById('title-list-overlay');
        const closeTitleListBtn = document.getElementById('close-title-list-btn');
        const titleColorSelectorContainer = document.getElementById('title-color-selector-container');
        
        // DOM: Á∑¥Áøí
        const weakWordPracticeBtn = document.getElementById('weak-word-practice-btn');
        
        // DOM: Ë®≠ÂÆö
        const advancedSettingsBtn = document.getElementById('advanced-settings-btn');
        const settingsOverlay = document.getElementById('settings-overlay');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        
        // DOM: ÂÆüÁ∏æ
        const achievementBtn = document.getElementById('achievement-btn');
        const achievementOverlay = document.getElementById('achievement-overlay');
        const closeAchievementBtn = document.getElementById('close-achievement-btn');
        
        // DOM: „Ç∑„Éß„ÉÉ„Éó
        const shopBtn = document.getElementById('shop-btn');
        const shopOverlay = document.getElementById('shop-overlay');
        const closeShopBtn = document.getElementById('close-shop-btn');
        
        // DOM: ÁÆ°ÁêÜËÄÖ„Éë„Éç„É´
        const adminPanelOverlay = document.getElementById('admin-panel-overlay');
        const closeAdminPanelBtn = document.getElementById('close-admin-panel-btn');
        const adminPanelContainer = document.getElementById('admin-panel-container');
        
        
        // --- 2. Áä∂ÊÖãÁÆ°ÁêÜÂ§âÊï∞ ---
        let gameRunning = false;
        let gameWaitingToStart = false; 
        let timer;
        let startTime;
        let gameStartTime; 
        let remainingTime;
        let gameMode = 'time'; 
        let gameValue = 30; 
        let errors = 0;
        let totalTypeCount = 0;
        let correctCharsCount = 0;
        let currentWordIndex = 0;
        let wordsToType = [];
        let hiraganaSpans = [];
        let targetHiraganaIndex = 0;
        let targetRomaOptions = [];
        let currentRomaInput = "";
        let currentScore = 0;
        let currentCombo = 0;
        let maxComboThisGame = 0; 
        let boostLevel = 1; 
        let popMode = 'random'; 
        let escapePressed = false; 
        let userInteracted = false; 
        let isWeekendBoost = false; 
        let currentWordPack = 'default'; 
        let lastGameResult = {}; 
        let quickClaimQueue = []; // „Éü„ÉÉ„Ç∑„Éß„É≥Âç≥ÊôÇÂèó„ÅëÂèñ„ÇäÁî®

        // „Ç¢„Ç§„ÉÜ„É†„Éª„Éñ„Éº„Çπ„ÉàÁ≥ª
        let isScoreBoostActive = false;
        let isMoneyBoostActive = false;
        let isComboShieldActive = false;
        let isEasyStartActive = false; 
        let isSlowTimerActive = false; 
        let isFeverItemActive = false; 
        let isFeverTime = false; 
        let feverEndTime = 0; 

        // „Ç¥„Éº„Çπ„Éà
        let ghostData = []; 
        let ghostTimer;
        let ghostScore = 0;
        let currentGhostIndex = 0;

        // „Éö„ÉÉ„Éà
        let petState = 'idle'; // 'idle', 'happy', 'sad'
        let petStateTimer;
        let isPetDragging = false;
        let petDragOffsetX = 0;
        let petDragOffsetY = 0;
        let petAnimationFrame;

        let currentTimeModeLength = 3; 
        const MIN_YOMI_LENGTH = 3;
        const MAX_YOMI_LENGTH = 8; 
        let recentWords = []; 
        const RECENT_WORD_MAX = 10; 

        // Ëá™ÂãïÂÖ•Âäõ
        let isAutoTyping = false;
        let autoTypeInterval = 300;
        let autoTyper;
        let autoTypeToggleClickCount = 0; 
        
        // BGM
        let allBgms = [];
        let currentBgm = bgmAudio;
        
        // Êñ∞„É¢„Éº„Éâ
        let doubleWordData = null; // „ÉÄ„Éñ„É´„É¢„Éº„Éâ„ÅÆ„Çµ„Éñ„ÅäÈ°å
        let fastModeSpeed = 1.0; // Êó©ÈÄÅ„Çä„É¢„Éº„Éâ„ÅÆÈÄüÂ∫¶
        
        // --- 3. „Éá„Éº„ÇøÂÆöÁæ© („Ç∑„Éß„ÉÉ„Éó„Ç¢„Ç§„ÉÜ„É† / Áß∞Âè∑ / „ÅäÈ°å) ---
        const masterItemList = {
            // „Éñ„Éº„Çπ„Éà
            scoreBoost: { name: "„Çπ„Ç≥„Ç¢„Éñ„Éº„Çπ„Éà", price: 250, description: "Ê¨°„ÅÆ„Ç≤„Éº„É†„ÅÆ„Çπ„Ç≥„Ç¢„Çí2ÂÄç„Å´„Åó„Åæ„Åô„ÄÇ", type: "boost" },
            moneyBoost: { name: "„ÅäÈáë„Éñ„Éº„Çπ„Éà", price: 200, description: "Ê¨°„ÅÆ„Ç≤„Éº„É†„ÅÆÁç≤Âæó„ÅäÈáë„Çí2ÂÄç„Å´„Åó„Åæ„Åô„ÄÇ", type: "boost" },
            comboShield: { name: "„Ç≥„É≥„Éú„Ç∑„Éº„É´„Éâ", price: 300, description: "Ê¨°„ÅÆ„Ç≤„Éº„É†„Åß1Âõû„Å†„Åë„Éü„Çπ„ÇíÁÑ°ÂäπÂåñ„Åó„Åæ„Åô„ÄÇ", type: "boost" },
            easyStart: { name: "„Ç§„Éº„Ç∏„Éº„Çπ„Çø„Éº„Éà", price: 150, description: "Ê¨°„ÅÆ„Ç≤„Éº„É†„ÅÆÊúÄÂàù„ÅÆ5ÂçòË™û„ÅåÁ∞°Âçò„Å´„Å™„Çä„Åæ„Åô„ÄÇ", type: "boost" },
            boostStart: { name: "„Éñ„Éº„Çπ„Éà„Çπ„Çø„Éº„Éà", price: 250, description: "„Ç≥„É≥„Éú10„Åã„Çâ„Ç≤„Éº„É†„ÇíÈñãÂßã„Åó„Åæ„Åô„ÄÇ", type: "boost" },
            timePlusTwo: { name: "„Çø„Ç§„É†„Éó„É©„Çπ (+2Áßí)", price: 150, description: "ÊôÇÈñì„É¢„Éº„Éâ„ÅÆÂà∂ÈôêÊôÇÈñì„Çí2ÁßíÂª∂Èï∑„Åó„Åæ„Åô„ÄÇ", type: "boost" },
            timePlusFive: { name: "„Çø„Ç§„É†„Éó„É©„Çπ (+5Áßí)", price: 300, description: "ÊôÇÈñì„É¢„Éº„Éâ„ÅÆÂà∂ÈôêÊôÇÈñì„Çí5ÁßíÂª∂Èï∑„Åó„Åæ„Åô„ÄÇ", type: "boost" },
            wordSkip: { name: "ÂçòË™û„Çπ„Ç≠„ÉÉ„Éó", price: 150, description: "ÂçòË™û„É¢„Éº„Éâ„ÅÆ„Éé„É´„Éû„Çí1ÂçòË™ûÊ∏õ„Çâ„Åó„Åæ„Åô„ÄÇ", type: "boost" },
            slowTimer: { name: "„Çπ„É≠„Éº„Çø„Ç§„Éû„Éº", price: 280, description: "„Çø„Ç§„Éû„Éº„ÅÆÈÄ≤„ÅøÊñπ„Åå10%ÈÅÖ„Åè„Å™„Çä„Åæ„Åô„ÄÇ", type: "boost" },
            feverBoost: { name: "„Éï„Ç£„Éº„Éê„Éº+", price: 500, description: "10„Ç≥„É≥„Éú„Åß„Éï„Ç£„Éº„Éê„Éº„Çø„Ç§„É†(„Çπ„Ç≥„Ç¢/Èáë3ÂÄç)„ÅåÁô∫Âãï„ÄÇ", type: "boost" }, 
            bonusMoney: { name: "„Éú„Éº„Éä„Çπ„Éû„Éç„Éº", price: 150, description: "Ë≥ºÂÖ•Âæå„Åô„Åê„Å´50ÂÜÜ„ÇíÁç≤Âæó„Åó„Åæ„Åô„ÄÇ", type: "utility" },
            
            // „Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ
            upgrade_money: { name: "Áç≤ÂæóÈáëÈ°çUP (Ê∞∏Á∂ö)", price: 5000, description: "„Ç≤„Éº„É†ÁµÇ‰∫ÜÊôÇ„ÅÆÁç≤ÂæóÈáëÈ°ç„ÅåÊ∞∏‰πÖ„Å´10%Â¢óÂä†„Åó„Åæ„Åô„ÄÇ", type: "upgrade", key: "moneyBoost" },
            upgrade_fever: { name: "„Éï„Ç£„Éº„Éê„ÉºÊôÇÈñìUP (Ê∞∏Á∂ö)", price: 8000, description: "„Éï„Ç£„Éº„Éê„Éº„Çø„Ç§„É†„ÅÆÊåÅÁ∂öÊôÇÈñì„ÅåÊ∞∏‰πÖ„Å´1ÁßíÂ¢óÂä†„Åó„Åæ„Åô„ÄÇ", type: "upgrade", key: "feverTime" },
            upgrade_infiniteFever: { name: "ÁÑ°Èôê„Éï„Ç£„Éº„Éê„Éº (Ê∞∏Á∂ö)", price: 100000, description: "„Éï„Ç£„Éº„Éê„Éº„Çø„Ç§„É†„Åå„Éü„Çπ„Çí„Åó„Å¶„ÇÇ„Ç≤„Éº„É†ÁµÇ‰∫Ü„Åæ„ÅßÊ∞∏Á∂ö„Åó„Åæ„Åô„ÄÇ", type: "upgrade", key: "infiniteFever" },

            // ËÉåÊôØ
            bg_ocean: { name: "ËÉåÊôØ: Êµ∑", price: 1000, description: "ËÉåÊôØ„ÉÜ„Éº„Éû„ÄåÊµ∑„Äç„ÇíËß£Êîæ„Åó„Åæ„Åô„ÄÇ", type: "background" },
            bg_galaxy: { name: "ËÉåÊôØ: ÈäÄÊ≤≥", price: 1500, description: "ËÉåÊôØ„ÉÜ„Éº„Éû„ÄåÈäÄÊ≤≥„Äç„ÇíËß£Êîæ„Åó„Åæ„Åô„ÄÇ", type: "background" },
            bg_forest: { name: "ËÉåÊôØ: Ê£Æ", price: 1000, description: "ËÉåÊôØ„ÉÜ„Éº„Éû„ÄåÊ£Æ„Äç„ÇíËß£Êîæ„Åó„Åæ„Åô„ÄÇ", type: "background" },
            bg_sunset: { name: "ËÉåÊôØ: Â§ïÁÑº„Åë", price: 1200, description: "ËÉåÊôØ„ÉÜ„Éº„Éû„ÄåÂ§ïÁÑº„Åë„Äç„ÇíËß£Êîæ„Åó„Åæ„Åô„ÄÇ", type: "background" },
            bg_cyber: { name: "ËÉåÊôØ: „Çµ„Ç§„Éê„Éº", price: 2000, description: "ËÉåÊôØ„ÉÜ„Éº„Éû„Äå„Çµ„Ç§„Éê„Éº„Äç„ÇíËß£Êîæ„Åó„Åæ„Åô„ÄÇ", type: "background" },
            bg_legend: { name: "ËÉåÊôØ: ‰ºùË™¨", price: 50000, description: "‰ºùË™¨„ÅÆËÉåÊôØ„ÉÜ„Éº„Éû„ÇíËß£Êîæ„Åó„Åæ„Åô„ÄÇ", type: "background" },
            bg_sakura: { name: "ËÉåÊôØ: Ê°ú", price: 0, description: "„Ç§„Éô„É≥„ÉàÈôêÂÆö„ÅÆËÉåÊôØ„Åß„Åô„ÄÇ", type: "background", event: "e_sakura" }, // ‚òÖ„Ç§„Éô„É≥„Éà

            // „Éï„Ç©„É≥„Éà
            font_serif: { name: "„Éï„Ç©„É≥„Éà: ÊòéÊúù‰Ωì", price: 3000, description: "„Ç≤„Éº„É†ÂÖ®‰Ωì„ÅÆ„Éï„Ç©„É≥„Éà„ÇíÊòéÊúù‰Ωì„Å´Ë®≠ÂÆö„Åß„Åç„Åæ„Åô„ÄÇ", type: "font" },
            font_rounded: { name: "„Éï„Ç©„É≥„Éà: ‰∏∏„Ç¥„Ç∑„ÉÉ„ÇØ", price: 3000, description: "„Ç≤„Éº„É†ÂÖ®‰Ωì„ÅÆ„Éï„Ç©„É≥„Éà„Çí‰∏∏„Ç¥„Ç∑„ÉÉ„ÇØ‰Ωì„Å´Ë®≠ÂÆö„Åß„Åç„Åæ„Åô„ÄÇ", type: "font" },

            // „Çø„Ç§„ÉóÈü≥
            sound_click: { name: "„Çø„Ç§„ÉóÈü≥: „Ç´„ÉÅ„Ç´„ÉÅ", price: 2000, description: "„Çø„Ç§„ÉóÈü≥„Çí„É°„Ç´„Éã„Ç´„É´È¢®„Å´„Åó„Åæ„Åô„ÄÇ", type: "sound" },
            sound_synth: { name: "„Çø„Ç§„ÉóÈü≥: „Éî„Ç≥„Éî„Ç≥", price: 2000, description: "„Çø„Ç§„ÉóÈü≥„ÇíÈõªÂ≠êÈü≥È¢®„Å´„Åó„Åæ„Åô„ÄÇ", type: "sound" },
            
            // ÂçòË™û„Éë„ÉÉ„ÇØ
            pack_animal: { name: "ÂçòË™û„Éë„ÉÉ„ÇØ: ÂãïÁâ©", price: 5000, description: "ÂãïÁâ©„Å´Èñ¢ÈÄ£„Åô„ÇãÂçòË™û„ÅåÂá∫È°å„Åï„Çå„Çã„Çà„ÅÜ„Å´„Å™„Çä„Åæ„Åô„ÄÇ", type: "pack" },
            pack_food: { name: "ÂçòË™û„Éë„ÉÉ„ÇØ: È£ü„ÅπÁâ©", price: 5000, description: "È£ü„ÅπÁâ©„Å´Èñ¢ÈÄ£„Åô„ÇãÂçòË™û„ÅåÂá∫È°å„Åï„Çå„Çã„Çà„ÅÜ„Å´„Å™„Çä„Åæ„Åô„ÄÇ", type: "pack" },
            pack_difficult: { name: "ÂçòË™û„Éë„ÉÉ„ÇØ: Á•û„ÄÖ", price: 50000, description: "Ë∂ÖÈ´òÈõ£ÊòìÂ∫¶„ÅÆÂçòË™û„Éë„ÉÉ„ÇØ„Åß„Åô„ÄÇ", type: "pack" },

            // „Éù„ÉÉ„Éó„Ç®„Éï„Çß„ÇØ„Éà
            effect_rainbow: { name: "„Ç®„Éï„Çß„ÇØ„Éà: ËôπËâ≤", price: 10000, description: "„Çø„Ç§„ÉóÊñáÂ≠ó„ÅåËôπËâ≤„Å´ÂÖâ„Çä„Åæ„Åô„ÄÇ", type: "effect" },
            effect_firework: { name: "„Ç®„Éï„Çß„ÇØ„Éà: Ëä±ÁÅ´", price: 15000, description: "„Çø„Ç§„ÉóÊñáÂ≠ó„ÅåËä±ÁÅ´„ÅÆ„Çà„ÅÜ„Å´ÁàÜÁô∫„Åó„Åæ„Åô„ÄÇ", type: "effect" },
            effect_bubble: { name: "„Ç®„Éï„Çß„ÇØ„Éà: Ê≥°", price: 12000, description: "„Çø„Ç§„ÉóÊñáÂ≠ó„ÅåÊ≥°„Å´„Å™„Å£„Å¶Ê∂à„Åà„Åæ„Åô„ÄÇ", type: "effect" },
            effect_lines: { name: "„Ç®„Éï„Çß„ÇØ„Éà: ÈõÜ‰∏≠Á∑ö", price: 12000, description: "„Çø„Ç§„ÉóÊñáÂ≠ó„Å´ÈõÜ‰∏≠Á∑ö„ÅåÂá∫„Åæ„Åô„ÄÇ", type: "effect" },

            // „ÉÜ„Éº„Éû
            theme_cyber: { name: "„ÉÜ„Éº„Éû: „Çµ„Ç§„Éê„Éº", price: 30000, description: "UIÂÖ®‰Ωì„Çí„Çµ„Ç§„Éê„Éº„Éë„É≥„ÇØÈ¢®„Å´„Åó„Åæ„Åô„ÄÇ", type: "theme" },
            theme_wa: { name: "„ÉÜ„Éº„Éû: ÂíåÈ¢®", price: 30000, description: "UIÂÖ®‰Ωì„ÇíÂíåÈ¢®ÔºàÊòéËâ≤Ôºâ„Å´„Åó„Åæ„Åô„ÄÇ", type: "theme" },
            theme_pixel: { name: "„ÉÜ„Éº„Éû: „Éî„ÇØ„Çª„É´", price: 20000, description: "UIÂÖ®‰Ωì„Çí„É¨„Éà„É≠„Ç≤„Éº„É†È¢®„Å´„Åó„Åæ„Åô„ÄÇ", type: "theme" },
            
            // „Éö„ÉÉ„Éà
            pet_dog: { name: "„Éö„ÉÉ„Éà: Áä¨", price: 25000, description: "„Éû„Çπ„Ç≥„ÉÉ„Éà„ÄåÁä¨„Äç„ÇíËß£Êîæ„Åó„Åæ„Åô„ÄÇ", type: "pet" },
            pet_robot: { name: "„Éö„ÉÉ„Éà: „É≠„Éú„ÉÉ„Éà", price: 25000, description: "„Éû„Çπ„Ç≥„ÉÉ„Éà„Äå„É≠„Éú„ÉÉ„Éà„Äç„ÇíËß£Êîæ„Åó„Åæ„Åô„ÄÇ", type: "pet" },
            pet_item_santa: { name: "„Éö„ÉÉ„ÉàÊúç: „Çµ„É≥„ÇøÂ∏Ω", price: 10000, description: "„Éö„ÉÉ„ÉàÁî®„ÅÆ„Çµ„É≥„ÇøÂ∏Ω„Åß„Åô„ÄÇ", type: "pet-item" },
            pet_house_cushion: { name: "„Éö„ÉÉ„Éà„ÅÆÂÆ∂: „ÇØ„ÉÉ„Ç∑„Éß„É≥", price: 15000, description: "„Éö„ÉÉ„Éà„ÅÆË∂≥Â†¥„Çí„ÇØ„ÉÉ„Ç∑„Éß„É≥„Å´„Åó„Åæ„Åô„ÄÇ", type: "pet-house" },
            pet_house_space: { name: "„Éö„ÉÉ„Éà„ÅÆÂÆ∂: ÂÆáÂÆôËàπ", price: 15000, description: "„Éö„ÉÉ„Éà„ÅÆË∂≥Â†¥„ÇíÂÆáÂÆôËàπ„Å´„Åó„Åæ„Åô„ÄÇ", type: "pet-house" },
            
            // BGM („Ç∏„É•„Éº„ÇØ„Éú„ÉÉ„ÇØ„Çπ)
            bgm_2: { name: "BGM: Battle", price: 10000, description: "BGM„ÄåBattle„Äç„ÇíËß£Êîæ„Åó„Åæ„Åô„ÄÇ", type: "bgm" },
            bgm_3: { name: "BGM: Dream", price: 10000, description: "BGM„ÄåDream„Äç„ÇíËß£Êîæ„Åó„Åæ„Åô„ÄÇ", type: "bgm" },
            
            // „Ç≠„Éº„Éú„Éº„Éâ„Çπ„Ç≠„É≥
            kb_skin_wood: { name: "KB„Çπ„Ç≠„É≥: Êú®ÁõÆË™ø", price: 8000, description: "„Ç≠„Éº„Éú„Éº„Éâ„ÇíÊú®ÁõÆË™ø„Å´„Åó„Åæ„Åô„ÄÇ", type: "kb-skin" },
            kb_skin_pixel: { name: "KB„Çπ„Ç≠„É≥: „Éî„ÇØ„Çª„É´", price: 8000, description: "„Ç≠„Éº„Éú„Éº„Éâ„Çí„É¨„Éà„É≠È¢®„Å´„Åó„Åæ„Åô„ÄÇ", type: "kb-skin" },
            
            // „Éó„É¨„Ç§„É§„Éº„Ç¢„Ç§„Ç≥„É≥
            icon_neko: { name: "„Ç¢„Ç§„Ç≥„É≥: Áå´", price: 5000, description: "„Éó„É≠„Éï„Ç£„Éº„É´„Ç¢„Ç§„Ç≥„É≥„Äåüò∫„Äç", type: "icon", emoji: "üò∫" },
            icon_inu: { name: "„Ç¢„Ç§„Ç≥„É≥: Áä¨", price: 5000, description: "„Éó„É≠„Éï„Ç£„Éº„É´„Ç¢„Ç§„Ç≥„É≥„Äåüê∂„Äç", type: "icon", emoji: "üê∂" },
            icon_default: { name: "„Ç¢„Ç§„Ç≥„É≥: „Éá„Éï„Ç©„É´„Éà", price: 0, description: "„Éó„É≠„Éï„Ç£„Éº„É´„Ç¢„Ç§„Ç≥„É≥„Äåüë§„Äç", type: "icon", emoji: "üë§" },

            // ‚òÖ„Ç¨„ÉÅ„É£ÈôêÂÆö„Ç¢„Ç§„ÉÜ„É†
            effect_gold: { name: "„Ç®„Éï„Çß„ÇØ„Éà: „Ç¥„Éº„É´„Éâ", description: "„Çø„Ç§„ÉóÊñáÂ≠ó„ÅåÈáëËâ≤„Å´Ëºù„ÅèÔºÅ", type: "effect", gacha: true, rarity: "super-rare" },
            bg_aurora: { name: "ËÉåÊôØ: „Ç™„Éº„É≠„É©", description: "ÂπªÊÉ≥ÁöÑ„Å™„Ç™„Éº„É≠„É©„ÅÆËÉåÊôØ", type: "background", gacha: true, rarity: "super-rare" },
            pet_item_party: { name: "„Éö„ÉÉ„ÉàÊúç: „Éë„Éº„ÉÜ„Ç£Â∏Ω", description: "„Éö„ÉÉ„ÉàÁî®„ÅÆ„ÅäÁ•ù„ÅÑ„ÅÆÂ∏ΩÂ≠ê", type: "pet-item", gacha: true, rarity: "rare" },
            pet_item_sakura: { name: "„Éö„ÉÉ„ÉàÊúç: Ê°ú", description: "„Éö„ÉÉ„ÉàÁî®„ÅÆÊ°ú„ÅÆ„Åã„Çì„Åñ„Åó", type: "pet-item", gacha: true, rarity: "rare", event: "e_sakura" }, // ‚òÖ„Ç§„Éô„É≥„Éà
            icon_legend: { name: "„Ç¢„Ç§„Ç≥„É≥: ‰ºùË™¨", description: "„Éó„É≠„Éï„Ç£„Éº„É´„Ç¢„Ç§„Ç≥„É≥„Äå‚ú®„Äç", type: "icon", gacha: true, rarity: "super-rare", emoji: "‚ú®" },
            kb_skin_neko: { name: "KB„Çπ„Ç≠„É≥: ËÇâÁêÉ", description: "„Ç≠„Éº„Éú„Éº„Éâ„ÅåËÇâÁêÉ„Åæ„Åø„Çå„Å´", type: "kb-skin", gacha: true, rarity: "rare" },
            charm_maneki: { name: "„ÅäÂÆà„Çä: Èáë„ÅÆÊãõ„ÅçÁå´", description: "Áç≤ÂæóG„ÅåÊ∞∏‰πÖ„Å´+5%ÔºÅ (Ë£ÖÂÇô‰∏≠„ÅÆ„Åø)", type: "charm", gacha: true, rarity: "legendary" },
            charm_kame: { name: "„ÅäÂÆà„Çä: ‰∫Ä„ÅÆÁî≤ÁæÖ", description: "ÊúÄÂàù„ÅÆ3„Éü„Çπ„Åæ„Åß„Ç≥„É≥„Éú„ÅåÈÄîÂàá„Çå„Å™„ÅÑ (Ë£ÖÂÇô‰∏≠„ÅÆ„Åø)", type: "charm", gacha: true, rarity: "legendary" },
            charm_taka: { name: "„ÅäÂÆà„Çä: È∑π„ÅÆÁæΩ", description: "„Éù„ÉÉ„Éó„Ç®„Éï„Çß„ÇØ„Éà„ÅåÂ∞ë„ÅóË±™ËèØ„Å´„Å™„Çã (Ë£ÖÂÇô‰∏≠„ÅÆ„Åø)", type: "charm", gacha: true, rarity: "rare" },
            charm_hude: { name: "„ÅäÂÆà„Çä: ÈÅî‰∫∫„ÅÆÁ≠Ü", description: "WPM„Å´Âøú„Åò„Å¶„Çπ„Ç≥„Ç¢„Å´„Éú„Éº„Éä„Çπ (Ë£ÖÂÇô‰∏≠„ÅÆ„Åø)", type: "charm", gacha: true, rarity: "legendary" },
            money_small: { name: "500 G", description: "500 G „ÇíÁç≤Âæó„Åó„Åü", type: "utility", gacha: true, rarity: "normal", value: 500 },
            money_medium: { name: "10,000 G", description: "10,000 G „ÇíÁç≤Âæó„Åó„ÅüÔºÅ", type: "utility", gacha: true, rarity: "rare", value: 10000 },
            boost_pack: { name: "„Éñ„Éº„Çπ„Éà„Éë„ÉÉ„ÇØ", description: "„Éñ„Éº„Çπ„Éà„Ç¢„Ç§„ÉÜ„É†3Á®ÆË©∞„ÇÅÂêà„Çè„ÅõÔºÅ", type: "utility", gacha: true, rarity: "rare", value: ['scoreBoost', 'moneyBoost', 'comboShield'] }
        };

        const gachaPool = {
            'normal': 60,    // 60%
            'rare': 30,      // 30%
            'super-rare': 8, // 8%
            'legendary': 2   // 2% („ÅäÂÆà„Çä)
        };
        let gachaItemsByRarity = { 'normal': [], 'rare': [], 'super-rare': [], 'legendary': [] };
        Object.keys(masterItemList).forEach(key => {
            const item = masterItemList[key];
            if (item.gacha) {
                if (!gachaItemsByRarity[item.rarity]) gachaItemsByRarity[item.rarity] = [];
                gachaItemsByRarity[item.rarity].push(key);
            }
        });

        const masterTitleList = Array(TOTAL_TITLES).fill(0).map((_i, i) => ({ name: `ÈÅî‰∫∫ ${i + 1} ÊÆµ`, score: (i + 1) * 50000 }));
        
        const wordPacks = {
            'default': [
                { display: "<ruby>Áå´<rt>„Å≠„Åì</rt></ruby>", yomi: "„Å≠„Åì" }, { display: "<ruby>Áä¨<rt>„ÅÑ„Å¨</rt></ruby>", yomi: "„ÅÑ„Å¨" }, { display: "<ruby>Á©∫<rt>„Åù„Çâ</rt></ruby>", yomi: "„Åù„Çâ" }, { display: "<ruby>Êµ∑<rt>„ÅÜ„Åø</rt></ruby>", yomi: "„ÅÜ„Åø" }, { display: "<ruby>Â§¢<rt>„ÇÜ„ÇÅ</rt></ruby>", yomi: "„ÇÜ„ÇÅ" },
                { display: "<ruby>Â±±<rt>„ÇÑ„Åæ</rt></ruby>", yomi: "„ÇÑ„Åæ" }, { display: "<ruby>Â∑ù<rt>„Åã„Çè</rt></ruby>", yomi: "„Åã„Çè" }, { display: "<ruby>Êúà<rt>„Å§„Åç</rt></ruby>", yomi: "„Å§„Åç" }, { display: "<ruby>Êòü<rt>„Åª„Åó</rt></ruby>", yomi: "„Åª„Åó" }, { display: "<ruby>Èõ®<rt>„ÅÇ„ÇÅ</rt></ruby>", yomi: "„ÅÇ„ÇÅ" },
                { display: "<ruby>‰ªï‰∫ã<rt>„Åó„Åî„Å®</rt></ruby>", yomi: "„Åó„Åî„Å®" }, { display: "<ruby>ÂãâÂº∑<rt>„Åπ„Çì„Åç„Çá„ÅÜ</rt></ruby>", yomi: "„Åπ„Çì„Åç„Çá„ÅÜ" },
                { display: "„Ç≤„Éº„É†", yomi: "„Åí„Éº„ÇÄ" }, { display: "„Ç≥„Éº„Éâ", yomi: "„Åì„Éº„Å©" },
                { display: "„Éë„ÇΩ„Ç≥„É≥", yomi: "„Å±„Åù„Åì„Çì" }, { display: "<ruby>Â≠¶Ê†°<rt>„Åå„Å£„Åì„ÅÜ</rt></ruby>", yomi: "„Åå„Å£„Åì„ÅÜ" }, { display: "<ruby>‰ºöÁ§æ<rt>„Åã„ÅÑ„Åó„ÇÉ</rt></ruby>", yomi: "„Åã„ÅÑ„Åó„ÇÉ" }, { display: "„Åä„ÅØ„Çà„ÅÜ", yomi: "„Åä„ÅØ„Çà„ÅÜ" }, { display: "<ruby>ÂÖÉÊ∞ó<rt>„Åí„Çì„Åç</rt></ruby>", yomi: "„Åí„Çì„Åç" },
                { display: "„Ç≠„Éº„Éú„Éº„Éâ", yomi: "„Åç„Éº„Åº„Éº„Å©" }, { display: "<ruby>‰∏ÄÊó•<rt>„ÅÑ„Å°„Å´„Å°</rt></ruby>", yomi: "„ÅÑ„Å°„Å´„Å°" }, { display: "<ruby>Êå®Êã∂<rt>„ÅÇ„ÅÑ„Åï„Å§</rt></ruby>", yomi: "„ÅÇ„ÅÑ„Åï„Å§" }, { display: "<ruby>ÂèãÈÅî<rt>„Å®„ÇÇ„Å†„Å°</rt></ruby>", yomi: "„Å®„ÇÇ„Å†„Å°" }, { display: "„Çø„Ç§„Éî„É≥„Ç∞", yomi: "„Åü„ÅÑ„Å¥„Çì„Åê" },
                { display: "<ruby>Êó•Êú¨<rt>„Å´„Åª„Çì</rt></ruby>", yomi: "„Å´„Åª„Çì" }, { display: "<ruby>‰∏ñÁïå<rt>„Åõ„Åã„ÅÑ</rt></ruby>", yomi: "„Åõ„Åã„ÅÑ" }, { display: "<ruby>Êú™Êù•<rt>„Åø„Çâ„ÅÑ</rt></ruby>", yomi: "„Åø„Çâ„ÅÑ" },
                { display: "„ÅÇ„Çä„Åå„Å®„ÅÜ", yomi: "„ÅÇ„Çä„Åå„Å®„ÅÜ" }, { display: "„Åì„Çì„Å´„Å°„ÅØ", yomi: "„Åì„Çì„Å´„Å°„ÅØ" }, { display: "„Åï„Çà„ÅÜ„Å™„Çâ", yomi: "„Åï„Çà„ÅÜ„Å™„Çâ" }, { display: "„ÅØ„Åò„ÇÅ„Åæ„Åó„Å¶", yomi: "„ÅØ„Åò„ÇÅ„Åæ„Åó„Å¶" },
                { display: "<ruby>„ÅäÁñ≤„ÇåÊßò<rt>„Åä„Å§„Åã„Çå„Åï„Åæ</rt></ruby>", yomi: "„Åä„Å§„Åã„Çå„Åï„Åæ" }, { display: "„Éó„É≠„Ç∞„É©„Éü„É≥„Ç∞", yomi: "„Å∑„Çç„Åê„Çâ„Åø„Çì„Åê" }, { display: "„Ç≥„É≥„Éú„Éú„Éº„Éä„Çπ", yomi: "„Åì„Çì„Åº„Åº„Éº„Å™„Åô" },
                { display: "<ruby>ÂãïÁâ©Âúí<rt>„Å©„ÅÜ„Å∂„Å§„Åà„Çì</rt></ruby>", yomi: "„Å©„ÅÜ„Å∂„Å§„Åà„Çì" }, { display: "<ruby>Ê∞¥ÊóèÈ§®<rt>„Åô„ÅÑ„Åû„Åè„Åã„Çì</rt></ruby>", yomi: "„Åô„ÅÑ„Åû„Åè„Åã„Çì" }, { display: "„Éû„Ç¶„Çπ„ÇØ„É™„ÉÉ„ÇØ", yomi: "„Åæ„ÅÜ„Åô„Åè„Çä„Å£„Åè" }, { display: "<ruby>Êñ∞ÂππÁ∑ö<rt>„Åó„Çì„Åã„Çì„Åõ„Çì</rt></ruby>", yomi: "„Åó„Çì„Åã„Çì„Åõ„Çì" },
                { display: "<ruby>ÈõªÂÖâÁü≥ÁÅ´<rt>„Åß„Çì„Åì„ÅÜ„Åõ„Å£„Åã</rt></ruby>", yomi: "„Åß„Çì„Åì„ÅÜ„Åõ„Å£„Åã" }, { display: "<ruby>Êò•Â§èÁßãÂÜ¨<rt>„Åó„ÇÖ„Çì„Åã„Åó„ÇÖ„ÅÜ„Å®„ÅÜ</rt></ruby>", yomi: "„Åó„ÇÖ„Çì„Åã„Åó„ÇÖ„ÅÜ„Å®„ÅÜ" }, { display: "<ruby>Ê∏©ÊïÖÁü•Êñ∞<rt>„Åä„Çì„Åì„Å°„Åó„Çì</rt></ruby>", yomi: "„Åä„Çì„Åì„Å°„Åó„Çì" }, { display: "„Ç§„É≥„Çø„Éº„Éç„ÉÉ„Éà", yomi: "„ÅÑ„Çì„Åü„Éº„Å≠„Å£„Å®" },
                { display: "<ruby>‰∏ÄÊúü‰∏Ä‰ºö<rt>„ÅÑ„Å°„Åî„ÅÑ„Å°„Åà</rt></ruby>", yomi: "„ÅÑ„Å°„Åî„ÅÑ„Å°„Åà" }, { display: "<ruby>‰∏ÉËª¢ÂÖ´Ëµ∑<rt>„Åó„Å°„Å¶„Çì„ÅØ„Å£„Åç</rt></ruby>", yomi: "„Åó„Å°„Å¶„Çì„ÅØ„Å£„Åç" }, { display: "<ruby>Âº±ËÇâÂº∑È£ü<rt>„Åò„ÇÉ„Å´„Åè„Åç„Çá„ÅÜ„Åó„Çá„Åè</rt></ruby>", yomi: "„Åò„ÇÉ„Å´„Åè„Åç„Çá„ÅÜ„Åó„Çá„Åè" }, { display: "<ruby>Â§ßÂô®Êô©Êàê<rt>„Åü„ÅÑ„Åç„Å∞„Çì„Åõ„ÅÑ</rt></ruby>", yomi: "„Åü„ÅÑ„Åç„Å∞„Çì„Åõ„ÅÑ" },
                { display: "„Éï„Ç£„Éº„Éê„Éº„Çø„Ç§„É†", yomi: "„Åµ„ÅÉ„Éº„Å∞„Éº„Åü„ÅÑ„ÇÄ" }, { display: "<ruby>Ëá™Âãï<rt>„Åò„Å©„ÅÜ</rt></ruby><ruby>ÂÖ•Âäõ<rt>„Å´„ÇÖ„ÅÜ„Çä„Çá„Åè</rt></ruby>", yomi: "„Åò„Å©„ÅÜ„Å´„ÇÖ„ÅÜ„Çä„Çá„Åè" }, { display: "„Çø„Ç§„Éî„É≥„Ç∞<ruby>Á∑¥Áøí<rt>„Çå„Çì„Åó„ÇÖ„ÅÜ</rt></ruby>", yomi: "„Åü„ÅÑ„Å¥„Çì„Åê„Çå„Çì„Åó„ÇÖ„ÅÜ" },
                { display: "„Çπ„Éû„Éº„Éà„Éï„Ç©„É≥", yomi: "„Åô„Åæ„Éº„Å®„Åµ„Åâ„Çì" }, { display: "<ruby>‰∏ÄÊó•‰∏ÄÂñÑ<rt>„ÅÑ„Å°„Å´„Å°„ÅÑ„Å°„Åú„Çì</rt></ruby>", yomi: "„ÅÑ„Å°„Å´„Å°„ÅÑ„Å°„Åú„Çì" }, { display: "<ruby>ÁôæËä±Áπö‰π±<rt>„Å≤„ÇÉ„Å£„Åã„Çä„Çá„ÅÜ„Çâ„Çì</rt></ruby>", yomi: "„Å≤„ÇÉ„Å£„Åã„Çä„Çá„ÅÜ„Çâ„Çì" },
                { display: "<ruby>‰∏ÄÊî´ÂçÉÈáë<rt>„ÅÑ„Å£„Åã„Åè„Åõ„Çì„Åç„Çì</rt></ruby>", yomi: "„ÅÑ„Å£„Åã„Åè„Åõ„Çì„Åç„Çì" }, { display: "<ruby>Ê≤πÊñ≠Â§ßÊïµ<rt>„ÇÜ„Å†„Çì„Åü„ÅÑ„Å¶„Åç</rt></ruby>", yomi: "„ÇÜ„Å†„Çì„Åü„ÅÑ„Å¶„Åç" }, { display: "<ruby>‰∏çË®ÄÂÆüË°å<rt>„Åµ„Åí„Çì„Åò„Å£„Åì„ÅÜ</rt></ruby>", yomi: "„Åµ„Åí„Çì„Åò„Å£„Åì„ÅÜ" }, 
                { display: "<ruby>Êúà<rt>„Å§„Åç</rt></ruby>„Åå<ruby>Á∂∫È∫ó<rt>„Åç„Çå„ÅÑ</rt></ruby>„Åß„Åô„Å≠", yomi: "„Å§„Åç„Åå„Åç„Çå„ÅÑ„Åß„Åô„Å≠" }, { display: "„Çµ„Éº„Éê„Éº„ÉÄ„Ç¶„É≥", yomi: "„Åï„Éº„Å∞„Éº„Å†„ÅÜ„Çì" }, { display: "<ruby>‰∫∫Â∑•<rt>„Åò„Çì„Åì„ÅÜ</rt></ruby><ruby>Áü•ËÉΩ<rt>„Å°„ÅÆ„ÅÜ</rt></ruby>", yomi: "„Åò„Çì„Åì„ÅÜ„Å°„ÅÆ„ÅÜ" },
                { display: "<ruby>ÂêæËº©<rt>„Çè„Åå„ÅØ„ÅÑ</rt></ruby>„ÅØ<ruby>Áå´<rt>„Å≠„Åì</rt></ruby>„Åß„ÅÇ„Çã", yomi: "„Çè„Åå„ÅØ„ÅÑ„ÅØ„Å≠„Åì„Åß„ÅÇ„Çã" },
                { display: "„ÇØ„É©„Ç¶„Éâ„Ç≥„É≥„Éî„É•„Éº„ÉÜ„Ç£„É≥„Ç∞", yomi: "„Åè„Çâ„ÅÜ„Å©„Åì„Çì„Å¥„ÇÖ„Éº„Å¶„ÅÉ„Çì„Åê" },
                { display: "<ruby>Á•áÂúíÁ≤æËàé<rt>„Åé„Åä„Çì„Åó„Çá„ÅÜ„Åò„ÇÉ</rt></ruby>„ÅÆ<ruby>Èêò<rt>„Åã„Å≠</rt></ruby>„ÅÆ<ruby>Â£∞<rt>„Åì„Åà</rt></ruby>", yomi: "„Åé„Åä„Çì„Åó„Çá„ÅÜ„Åò„ÇÉ„ÅÆ„Åã„Å≠„ÅÆ„Åì„Åà" },
                { display: "„Éá„Ç∏„Çø„É´„Éà„É©„É≥„Çπ„Éï„Ç©„Éº„É°„Éº„Ç∑„Éß„É≥", yomi: "„Åß„Åò„Åü„Çã„Å®„Çâ„Çì„Åô„Åµ„Åâ„Éº„ÇÅ„Éº„Åó„Çá„Çì" },
                { display: "<ruby>Áîü<rt>„Å™„Åæ</rt></ruby><ruby>È∫¶<rt>„ÇÄ„Åé</rt></ruby><ruby>Áîü<rt>„Å™„Åæ</rt></ruby><ruby>Á±≥<rt>„Åî„ÇÅ</rt></ruby><ruby>Áîü<rt>„Å™„Åæ</rt></ruby><ruby>Âçµ<rt>„Åü„Åæ„Åî</rt></ruby>", yomi: "„Å™„Åæ„ÇÄ„Åé„Å™„Åæ„Åî„ÇÅ„Å™„Åæ„Åü„Åæ„Åî" },
                { display: "„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà<ruby>ÊåáÂêë<rt>„Åó„Åì„ÅÜ</rt></ruby>„Éó„É≠„Ç∞„É©„Éü„É≥„Ç∞", yomi: "„Åä„Å∂„Åò„Åá„Åè„Å®„Åó„Åì„ÅÜ„Å∑„Çç„Åê„Çâ„Åø„Çì„Åê" },
                { display: "<ruby>Êó•Êú¨<rt>„Å´„Åª„Çì</rt></ruby><ruby>ÁµåÊ∏à<rt>„Åë„ÅÑ„Åñ„ÅÑ</rt></ruby><ruby>Êñ∞ËÅû<rt>„Åó„Çì„Å∂„Çì</rt></ruby>", yomi: "„Å´„Åª„Çì„Åë„ÅÑ„Åñ„ÅÑ„Åó„Çì„Å∂„Çì" },
                { display: "<ruby>Èö£<rt>„Å®„Å™„Çä</rt></ruby>„ÅÆ<ruby>ÂÆ¢<rt>„Åç„ÇÉ„Åè</rt></ruby>„ÅØ„Çà„Åè<ruby>Êüø<rt>„Åã„Åç</rt></ruby><ruby>È£ü<rt>„Åè</rt></ruby>„ÅÜ<ruby>ÂÆ¢<rt>„Åç„ÇÉ„Åè</rt></ruby>„Å†", yomi: "„Å®„Å™„Çä„ÅÆ„Åç„ÇÉ„Åè„ÅØ„Çà„Åè„Åã„Åç„Åè„ÅÜ„Åç„ÇÉ„Åè„Å†" },
                { display: "„Éê„Çπ„Ç¨„Çπ<ruby>ÁàÜÁô∫<rt>„Å∞„Åè„ÅØ„Å§</rt></ruby>", yomi: "„Å∞„Åô„Åå„Åô„Å∞„Åè„ÅØ„Å§" },
                { display: "<ruby>Ëµ§<rt>„ÅÇ„Åã</rt></ruby>„Éë„Ç∏„É£„Éû<ruby>Èùí<rt>„ÅÇ„Åä</rt></ruby>„Éë„Ç∏„É£„Éû<ruby>ÈªÑ<rt>„Åç</rt></ruby>„Éë„Ç∏„É£„Éû", yomi: "„ÅÇ„Åã„Å±„Åò„ÇÉ„Åæ„ÅÇ„Åä„Å±„Åò„ÇÉ„Åæ„Åç„Å±„Åò„ÇÉ„Åæ" },
                { display: "„Åì„ÅÆ<ruby>‰∏≠<rt>„Å™„Åã</rt></ruby>„Å´<ruby>Ë£èÂàá<rt>„ÅÜ„Çâ„Åé</rt></ruby>„Çä<ruby>ËÄÖ<rt>„ÇÇ„ÅÆ</rt></ruby>„Åå„ÅÑ„Çã", yomi: "„Åì„ÅÆ„Å™„Åã„Å´„ÅÜ„Çâ„Åé„Çä„ÇÇ„ÅÆ„Åå„ÅÑ„Çã" },
                { display: "<ruby>‰ø∫<rt>„Åä„Çå</rt></ruby>„ÅÆ<ruby>Êà¶<rt>„Åü„Åü„Åã</rt></ruby>„ÅÑ„ÅØ„Åì„Çå„Åã„Çâ„Å†", yomi: "„Åä„Çå„ÅÆ„Åü„Åü„Åã„ÅÑ„ÅØ„Åì„Çå„Åã„Çâ„Å†" },
                { display: "„É°„É™„Éº„ÇØ„É™„Çπ„Éû„Çπ", yomi: "„ÇÅ„Çä„Éº„Åè„Çä„Åô„Åæ„Åô" },
                { display: "„ÅÇ„Åë„Åæ„Åó„Å¶„Åä„ÇÅ„Åß„Å®„ÅÜ", yomi: "„ÅÇ„Åë„Åæ„Åó„Å¶„Åä„ÇÅ„Åß„Å®„ÅÜ" },
                { display: "JavaScript", yomi: "„Åò„ÇÉ„Å∞„Åô„Åè„Çä„Å∑„Å®" }, { display: "Python", yomi: "„Å±„ÅÑ„Åù„Çì" },
                { display: "CSS", yomi: "„Åó„Éº„Åà„Åô„Åà„Åô" }, { display: "HTML", yomi: "„Åà„ÅÑ„Å°„Å¶„ÅÉ„Éº„Åà„ÇÄ„Åà„Çã" },
                { display: "„Éá„Éº„Çø„Éô„Éº„Çπ", yomi: "„Åß„Éº„Åü„Åπ„Éº„Åô" }, { display: "„Éï„Ç°„Ç§„Ç¢„Ç¶„Ç©„Éº„É´", yomi: "„Åµ„ÅÅ„ÅÑ„ÅÇ„ÅÜ„Åâ„Éº„Çã" },
                { display: "„Çª„Ç≠„É•„É™„ÉÜ„Ç£", yomi: "„Åõ„Åç„ÇÖ„Çä„Å¶„ÅÉ" }
            ],
            'pack_animal': [
                { display: "<ruby>Áå´<rt>„Å≠„Åì</rt></ruby>", yomi: "„Å≠„Åì" }, { display: "<ruby>Áä¨<rt>„ÅÑ„Å¨</rt></ruby>", yomi: "„ÅÑ„Å¨" }, { display: "„É©„Ç§„Ç™„É≥", yomi: "„Çâ„ÅÑ„Åä„Çì" }, { display: "„Ç≠„É™„É≥", yomi: "„Åç„Çä„Çì" },
                { display: "„Éë„É≥„ÉÄ", yomi: "„Å±„Çì„Å†" }, { display: "„Ç≥„Ç¢„É©", yomi: "„Åì„ÅÇ„Çâ" }, { display: "„Éö„É≥„ÇÆ„É≥", yomi: "„Å∫„Çì„Åé„Çì" },
                { display: "„Ç´„Éî„Éê„É©", yomi: "„Åã„Å¥„Å∞„Çâ" }, { display: "„Ç¢„É´„Éë„Ç´", yomi: "„ÅÇ„Çã„Å±„Åã" }, { display: "„Éï„Çß„Éç„ÉÉ„ÇØ", yomi: "„Åµ„Åá„Å≠„Å£„Åè" },
                { display: "„Ç∑„Éû„Ç®„Éä„Ç¨", yomi: "„Åó„Åæ„Åà„Å™„Åå" }, { display: "„ÉÜ„Ç£„É©„Éé„Çµ„Ç¶„É´„Çπ", yomi: "„Å¶„ÅÉ„Çâ„ÅÆ„Åï„ÅÜ„Çã„Åô" },
                { display: "<ruby>ÂÖé<rt>„ÅÜ„Åï„Åé</rt></ruby>", yomi: "„ÅÜ„Åï„Åé" }, { display: "<ruby>Ë±°<rt>„Åû„ÅÜ</rt></ruby>", yomi: "„Åû„ÅÜ" }, { display: "<ruby>Ëôé<rt>„Å®„Çâ</rt></ruby>", yomi: "„Å®„Çâ" }, { display: "<ruby>È¶¨<rt>„ÅÜ„Åæ</rt></ruby>", yomi: "„ÅÜ„Åæ" },
                { display: "<ruby>Áæä<rt>„Å≤„Å§„Åò</rt></ruby>", yomi: "„Å≤„Å§„Åò" }, { display: "<ruby>Áåø<rt>„Åï„Çã</rt></ruby>", yomi: "„Åï„Çã" }, { display: "<ruby>Èº†<rt>„Å≠„Åö„Åø</rt></ruby>", yomi: "„Å≠„Åö„Åø" }, { display: "<ruby>Áâõ<rt>„ÅÜ„Åó</rt></ruby>", yomi: "„ÅÜ„Åó" },
                { display: "„Ç´„Éê", yomi: "„Åã„Å∞" }, { display: "„Çµ„Ç§", yomi: "„Åï„ÅÑ" }, { display: "„Ç∑„Éû„Ç¶„Éû", yomi: "„Åó„Åæ„ÅÜ„Åæ" }, { display: "„Ç´„É≥„Ç¨„É´„Éº", yomi: "„Åã„Çì„Åå„Çã„Éº" },
                { display: "„Ç¥„É™„É©", yomi: "„Åî„Çä„Çâ" }, { display: "„ÉÅ„É≥„Éë„É≥„Ç∏„Éº", yomi: "„Å°„Çì„Å±„Çì„Åò„Éº" }, { display: "„Ç´„ÉØ„Ç¶„ÇΩ", yomi: "„Åã„Çè„ÅÜ„Åù" }
            ],
            'pack_food': [
                { display: "<ruby>ÂØøÂè∏<rt>„Åô„Åó</rt></ruby>", yomi: "„Åô„Åó" }, { display: "„É©„Éº„É°„É≥", yomi: "„Çâ„Éº„ÇÅ„Çì" }, { display: "<ruby>Â§©„Å∑„Çâ<rt>„Å¶„Çì„Å∑„Çâ</rt></ruby>", yomi: "„Å¶„Çì„Å∑„Çâ" },
                { display: "„Éê„Éä„Éä", yomi: "„Å∞„Å™„Å™" }, { display: "„Çä„Çì„Åî", yomi: "„Çä„Çì„Åî" }, { display: "„É°„É≠„É≥", yomi: "„ÇÅ„Çç„Çì" },
                { display: "„Åä„Å´„Åé„Çä", yomi: "„Åä„Å´„Åé„Çä" }, { display: "„Éè„É≥„Éê„Éº„Ç∞", yomi: "„ÅØ„Çì„Å∞„Éº„Åê" },
                { display: "<ruby>ÂçµÁÑº<rt>„Åü„Åæ„Åî„ÇÑ</rt></ruby>„Åç", yomi: "„Åü„Åæ„Åî„ÇÑ„Åç" }, { display: "„Åä<ruby>ÂØøÂè∏<rt>„Åô„Åó</rt></ruby>„ÇÑ„Åï„Çì", yomi: "„Åä„Åô„Åó„ÇÑ„Åï„Çì" },
                { display: "<ruby>ÁÑºËÇâ<rt>„ÇÑ„Åç„Å´„Åè</rt></ruby><ruby>ÂÆöÈ£ü<rt>„Å¶„ÅÑ„Åó„Çá„Åè</rt></ruby>", yomi: "„ÇÑ„Åç„Å´„Åè„Å¶„ÅÑ„Åó„Çá„Åè" }, { display: "<ruby>Ë±ö<rt>„Å∂„Åü</rt></ruby>„Éê„É©„Éñ„É≠„ÉÉ„ÇØ", yomi: "„Å∂„Åü„Å∞„Çâ„Å∂„Çç„Å£„Åè" },
                { display: "„Ç´„É¨„Éº„É©„Ç§„Çπ", yomi: "„Åã„Çå„Éº„Çâ„ÅÑ„Åô" }, { display: "<ruby>ÁÑº<rt>„ÇÑ</rt></ruby>„Åç<ruby>ËÇâ<rt>„Å´„Åè</rt></ruby>È£ü„Åπ<ruby>ÊîæÈ°å<rt>„Åª„ÅÜ„Å†„ÅÑ</rt></ruby>", yomi: "„ÇÑ„Åç„Å´„Åè„Åü„Åπ„Åª„ÅÜ„Å†„ÅÑ" },
                { display: "„Ç∑„É•„Éº„ÇØ„É™„Éº„É†", yomi: "„Åó„ÇÖ„Éº„Åè„Çä„Éº„ÇÄ" }, { display: "„Ç®„Éì„ÉÅ„É™„ÇΩ„Éº„Çπ", yomi: "„Åà„Å≥„Å°„Çä„Åù„Éº„Åô" },
                { display: "<ruby>È∫ªÂ©ÜË±ÜËÖê<rt>„Åæ„Éº„Åº„Éº„Å©„ÅÜ„Åµ</rt></ruby>", yomi: "„Åæ„Éº„Åº„Éº„Å©„ÅÜ„Åµ" }, { display: "„Ç™„É†„É©„Ç§„Çπ", yomi: "„Åä„ÇÄ„Çâ„ÅÑ„Åô" },
                { display: "„Éä„Éù„É™„Çø„É≥", yomi: "„Å™„ÅΩ„Çä„Åü„Çì" }, { display: "„ÅÑ„Å°„Åî", yomi: "„ÅÑ„Å°„Åî" }, { display: "„Å∂„Å©„ÅÜ", yomi: "„Å∂„Å©„ÅÜ" },
                { display: "„Åø„Åã„Çì", yomi: "„Åø„Åã„Çì" }, { display: "„Ç∑„Éß„Éº„Éà„Ç±„Éº„Ç≠", yomi: "„Åó„Çá„Éº„Å®„Åë„Éº„Åç" }, { display: "„É¢„É≥„Éñ„É©„É≥", yomi: "„ÇÇ„Çì„Å∂„Çâ„Çì" }
            ],
            'pack_difficult': [ // ‚òÖÊñ∞„Éë„ÉÉ„ÇØ
                { display: "<ruby>È≠ëÈ≠ÖÈ≠çÈ≠é<rt>„Å°„Åø„ÇÇ„ÅÜ„Çä„Çá„ÅÜ</rt></ruby>", yomi: "„Å°„Åø„ÇÇ„ÅÜ„Çä„Çá„ÅÜ" },
                { display: "<ruby>Ê™∏Ê™¨<rt>„Çå„ÇÇ„Çì</rt></ruby>", yomi: "„Çå„ÇÇ„Çì" },
                { display: "<ruby>ËñîËñá<rt>„Å∞„Çâ</rt></ruby>", yomi: "„Å∞„Çâ" },
                { display: "<ruby>ÊÜÇÈ¨±<rt>„ÇÜ„ÅÜ„ÅÜ„Å§</rt></ruby>", yomi: "„ÇÜ„ÅÜ„ÅÜ„Å§" },
                { display: "<ruby>Êå®Êã∂<rt>„ÅÇ„ÅÑ„Åï„Å§</rt></ruby>", yomi: "„ÅÇ„ÅÑ„Åï„Å§" },
                { display: "<ruby>ÈÜ§Ê≤π<rt>„Åó„Çá„ÅÜ„ÇÜ</rt></ruby>", yomi: "„Åó„Çá„ÅÜ„ÇÜ" },
                { display: "<ruby>Âæ°Âæ°Âæ°‰ªò<rt>„Åä„Åø„Åä„Å§„Åë</rt></ruby>", yomi: "„Åä„Åø„Åä„Å§„Åë" }
            ],
            // ‚òÖÊ≠åË©û„Çø„Ç§„Éî„É≥„Ç∞ÂâäÈô§
            'pack_english': [ // ‚òÖÊñ∞„Éë„ÉÉ„ÇØ
                { display: "<ruby>Áå´<rt>„Å≠„Åì</rt></ruby>", yomi: "cat" },
                { display: "<ruby>Áä¨<rt>„ÅÑ„Å¨</rt></ruby>", yomi: "dog" },
                { display: "<ruby>„Çä„Çì„Åî<rt>„Çä„Çì„Åî</rt></ruby>", yomi: "apple" },
                { display: "<ruby>Ê∞¥<rt>„Åø„Åö</rt></ruby>", yomi: "water" },
                { display: "<ruby>Â≠¶Ê†°<rt>„Åå„Å£„Åì„ÅÜ</rt></ruby>", yomi: "school" },
                { display: "<ruby>„Çø„Ç§„Éî„É≥„Ç∞<rt>„Åü„ÅÑ„Å¥„Çì„Åê</rt></ruby>", yomi: "typing" },
                { display: "„Ç≤„Éº„É†", yomi: "game" }
            ],
            'pack_event_sakura': [ // ‚òÖ„Ç§„Éô„É≥„Éà
                { display: "<ruby>Ê°ú<rt>„Åï„Åè„Çâ</rt></ruby>", yomi: "„Åï„Åè„Çâ" },
                { display: "<ruby>„ÅäËä±Ë¶ã<rt>„Åä„ÅØ„Å™„Åø</rt></ruby>", yomi: "„Åä„ÅØ„Å™„Åø" },
                { display: "„Çπ„Éó„É™„É≥„Ç∞", yomi: "„Åô„Å∑„Çä„Çì„Åê" }
            ]
        };
        
        let masterWordList = []; 
        let wordListByYomiLength = {};
        let easyWordList = [];

        function setWordList(packName = 'default') {
            currentWordPack = packName;
            masterWordList = [...(wordPacks[packName] || wordPacks['default'])];
            
            // ‚òÖ„Ç§„Éô„É≥„ÉàÂçòË™û„ÅÆËøΩÂä†
            if (gameData.activeEvent === 'e_sakura' && packName !== 'pack_english') {
                masterWordList.push(...wordPacks['pack_event_sakura']);
            }
            
            wordListByYomiLength = {};
            
            masterWordList.forEach(word => {
                const len = word.yomi.length;
                const key = len >= MAX_YOMI_LENGTH ? MAX_YOMI_LENGTH : (len <= MIN_YOMI_LENGTH ? MIN_YOMI_LENGTH : len); 
                if (!wordListByYomiLength[key]) {
                    wordListByYomiLength[key] = [];
                }
                wordListByYomiLength[key].push(word);
            });
            easyWordList = wordListByYomiLength[MIN_YOMI_LENGTH] || [];
        }

        // ‚òÖ„Éá„Ç§„É™„Éº„Éü„ÉÉ„Ç∑„Éß„É≥
        const masterMissionList = {
            dailyPlay: { name: "„Éá„Ç§„É™„Éº„Éó„É¨„Ç§", description: "1Êó•„Å´3Âõû„Éó„É¨„Ç§„Åô„Çã", goal: 3, reward: 100, type: "daily", key: "playCount" },
            dailyMoney: { name: "„Éá„Ç§„É™„ÉºÁ®º„Åé", description: "1Êó•„ÅßÂêàË®à1000 GÁ®º„Åê", goal: 1000, reward: 200, type: "daily", key: "moneyEarned" },
            dailyTypes: { name: "„Éá„Ç§„É™„Éº„Çø„Ç§„Éó", description: "1Êó•„Å´ÂêàË®à1000Âõû„Çø„Ç§„Éó„Åô„Çã", goal: 1000, reward: 150, type: "daily", key: "totalTypes" },
            dailyMaxCombo: { name: "„Éá„Ç§„É™„Éº„Ç≥„É≥„Éú", description: "1Êó•„Å´ÊúÄÂ§ß„Ç≥„É≥„Éú30„ÇíÈÅîÊàê„Åô„Çã", goal: 30, reward: 150, type: "daily", key: "maxCombo" }
        };
        
        // ‚òÖ„Ç¶„Ç£„Éº„ÇØ„É™„Éº„Éü„ÉÉ„Ç∑„Éß„É≥
        const masterWeeklyMissions = [
            { id: "w01", name: "ÂãïÁâ©ÊÑõ", description: "ÂãïÁâ©„Éë„ÉÉ„ÇØ„ÅßÂêàË®à10,000ÁÇπÁ®º„Åê", goal: 10000, reward: 1000, check: (res, data) => (data.gameMode === 'time_30' && data.pack === 'pack_animal') ? data.score : 0 },
            { id: "w02", name: "„Éé„Éº„Éü„Çπ„ÇØ„É™„Ç¢", description: "„Éé„Éº„Éü„Çπ„Åß3Âõû„ÇØ„É™„Ç¢„Åô„Çã", goal: 3, reward: 1500, check: (res, data) => (res.errors === 0) ? 1 : 0 },
            { id: "w03", name: "„Ç¶„Ç£„Éº„ÇØ„É™„Éº„Ç≥„É≥„Éú", description: "ÂêàË®à„Ç≥„É≥„ÉúÊï∞ 500 „ÇíÈÅîÊàê", goal: 500, reward: 1000, check: (res, data) => data.maxCombo },
            { id: "w04", name: "ÁæéÈ£üÂÆ∂", description: "È£ü„ÅπÁâ©„Éë„ÉÉ„ÇØ„ÅßÂêàË®à10,000ÁÇπÁ®º„Åê", goal: 10000, reward: 1000, check: (res, data) => (data.gameMode === 'time_30' && data.pack === 'pack_food') ? data.score : 0 }
        ];
        
        // ‚òÖ„Ç§„Éô„É≥„Éà
        const masterEventList = [
            { id: "e_sakura", name: "Ê°ú„Åæ„Å§„Çä„Ç§„Éô„É≥„Éà", start: "04-01", end: "04-15",
              description: "„ÄåÊ°ú„Åæ„Å§„Çä„ÄçÈñãÂÇ¨‰∏≠ÔºÅ<br>„ÉªËÉåÊôØ„ÄåÊ°ú„Äç„ÅåÂÖ®Âì°„Å´Ëß£ÊîæÔºÅ<br>„ÉªÈôêÂÆöÂçòË™û„Äå„Åï„Åè„Çâ„Äç„Äå„Åä„ÅØ„Å™„Åø„Äç„ÅåÂá∫ÁèæÔºÅ<br>„Éª„Ç¨„ÉÅ„É£„Åã„ÇâÈôêÂÆö„Ç¢„Ç§„ÉÜ„É†„ÄåÊ°ú„ÅÆ„Åã„Çì„Åñ„Åó„ÄçÊéíÂá∫ÔºÅ" }
        ];

        // ‚òÖÂÆüÁ∏æ
        const masterAchievementList = {
            totalTypes1000: { name: "„Çø„Ç§„Éë„ÉºË¶ãÁøí„ÅÑ", description: "ÂêàË®à„Çø„Ç§„ÉóÊï∞ 1,000Âõû ÈÅîÊàê", reward: 500, ap: 5, check: (data) => data.stats.totalTypes >= 1000 },
            totalTypes10000: { name: "„Éô„ÉÜ„É©„É≥„Çø„Ç§„Éë„Éº", description: "ÂêàË®à„Çø„Ç§„ÉóÊï∞ 10,000Âõû ÈÅîÊàê", reward: 2000, ap: 10, check: (data) => data.stats.totalTypes >= 10000 },
            totalTypes100000: { name: "„Çø„Ç§„Éó„Éû„Çπ„Çø„Éº", description: "ÂêàË®à„Çø„Ç§„ÉóÊï∞ 100,000Âõû ÈÅîÊàê", reward: 10000, ap: 50, check: (data) => data.stats.totalTypes >= 100000 },
            maxCombo50: { name: "„Ç≥„É≥„Éú„Éû„Çπ„Çø„Éº", description: "ÊúÄÂ§ß„Ç≥„É≥„Éú 50 ÈÅîÊàê", reward: 1000, ap: 10, check: (data) => data.stats.maxCombo >= 50 },
            maxCombo100: { name: "„Ç≥„É≥„ÉúÁ•û", description: "ÊúÄÂ§ß„Ç≥„É≥„Éú 100 ÈÅîÊàê", reward: 5000, ap: 20, check: (data) => data.stats.maxCombo >= 100 },
            noMissTime30: { name: "„Éë„Éº„Éï„Çß„ÇØ„Éà", description: "30Áßí„É¢„Éº„Éâ„Çí„Éé„Éº„Éü„Çπ„Åß„ÇØ„É™„Ç¢", reward: 1500, ap: 15, check: (data, res) => res.gameMode === 'time_30' && res.errors === 0 },
            money10000: { name: "„É™„ÉÉ„ÉÅ", description: "ÊâÄÊåÅÈáë 10,000 G ÈÅîÊàê", reward: 1000, ap: 5, check: (data) => data.stats.money >= 10000 },
            money100000: { name: "Â§ßÂØåË±™", description: "ÊâÄÊåÅÈáë 100,000 G ÈÅîÊàê", reward: 5000, ap: 20, check: (data) => data.stats.money >= 100000 },
            level10: { name: "„É¨„Éô„É´10Âà∞ÈÅî", description: "„Éó„É¨„Ç§„É§„Éº„É¨„Éô„É´„Åå10„Å´Âà∞ÈÅî„Åô„Çã", reward: 1000, ap: 5, check: (data) => data.stats.level >= 10 },
            level50: { name: "„É¨„Éô„É´50Âà∞ÈÅî", description: "„Éó„É¨„Ç§„É§„Éº„É¨„Éô„É´„Åå50„Å´Âà∞ÈÅî„Åô„Çã", reward: 5000, ap: 20, check: (data) => data.stats.level >= 50 },
            level100: { name: "„É¨„Éô„É´100Âà∞ÈÅî", description: "„Éó„É¨„Ç§„É§„Éº„É¨„Éô„É´„Åå100„Å´Âà∞ÈÅî„Åô„Çã", reward: 10000, ap: 50, check: (data) => data.stats.level >= 100 },
            challengeTA: { name: "„Çø„Ç§„É†„Ç¢„Çø„ÉÉ„Ç´„Éº", description: "„ÉÅ„É£„É¨„É≥„Ç∏„ÄåTA (20ÂçòË™û)„Äç„Çí„ÇØ„É™„Ç¢", reward: 2000, ap: 15, check: (data, res) => res.gameMode === 'timeAttack' && res.errors === 0 },
            challengeAcc: { name: "Á≤æÂØÜÊ©üÊ¢∞", description: "„ÉÅ„É£„É¨„É≥„Ç∏„ÄåÁ≤æÂ∫¶ (1ÂàÜ)„Äç„Çí„ÇØ„É™„Ç¢", reward: 2000, ap: 15, check: (data, res) => res.gameMode === 'accuracy' && res.accuracy >= 98.0 },
            prestige1: { name: "Ëª¢ÁîüËÄÖ", description: "Âàù„ÇÅ„Å¶„Éó„É¨„Çπ„ÉÜ„Éº„Ç∏„ÇíË°å„ÅÜ", reward: 10000, ap: 100, check: (data) => data.stats.prestigeLevel >= 1 },
            prestige20: { name: "Ë∂ÖË∂äËÄÖ", description: "„Éó„É¨„Çπ„ÉÜ„Éº„Ç∏„É¨„Éô„É´ 20 „Å´Âà∞ÈÅî", reward: 50000, ap: 200, check: (data) => data.stats.prestigeLevel >= 20 },
            gacha10: { name: "„Ç¨„ÉÅ„É£Â•Ω„Åç", description: "„Ç¨„ÉÅ„É£„Çí10ÂõûÂºï„Åè", reward: 1000, ap: 5, check: (data) => data.stats.gachaPulls >= 10 },
            gachaSuperRare: { name: "Âº∑ÈÅã", description: "„Çπ„Éº„Éë„Éº„É¨„Ç¢„ÇíÂºï„Åè", reward: 5000, ap: 20, check: (data, res) => res.gachaRarity === 'super-rare' },
            gachaLegendary: { name: "‰ºùË™¨„ÅÆÂºï„Åç", description: "„É¨„Ç∏„Çß„É≥„ÉÄ„É™„Éº„ÇíÂºï„Åè", reward: 10000, ap: 50, check: (data, res) => res.gachaRarity === 'legendary' },
            skillMaster: { name: "„Çπ„Ç≠„É´„Éû„Çπ„Çø„Éº", description: "„Çπ„Ç≠„É´„Çí10ÂÄã„Ç¢„É≥„É≠„ÉÉ„ÇØ", reward: 5000, ap: 20, check: (data) => Object.keys(data.skills).length >= 10 },
            petLover: { name: "„Éö„ÉÉ„ÉàÊÑõÂ•ΩÂÆ∂", description: "„Éö„ÉÉ„Éà„Çí3Âåπ„Ç¢„É≥„É≠„ÉÉ„ÇØ", reward: 5000, ap: 10, check: (data) => data.unlockedPets.length >= 3 },
            newModeMaster: { name: "„ÉÅ„É£„É¨„É≥„Ç∏„É£„Éº", description: "Êñ∞„Åó„ÅÑ„ÉÅ„É£„É¨„É≥„Ç∏„É¢„Éº„Éâ„ÇíÂÖ®„Å¶„Éó„É¨„Ç§", reward: 3000, ap: 15, check: (data) => data.stats.modesPlayed['english'] && data.stats.modesPlayed['double'] && data.stats.modesPlayed['fill'] && data.stats.modesPlayed['fast'] }
        };
        
        // ‚òÖAPÂ†±ÈÖ¨
        const apRewardList = [
            { ap: 20, type: "money", value: 5000 },
            { ap: 50, type: "item", value: "comboShield" },
            { ap: 100, type: "money", value: 20000 },
            { ap: 150, type: "pet-item", value: "pet_item_party" },
            { ap: 200, type: "money", value: 50000 },
            { ap: 300, type: "pet", value: "pet_robot" },
            { ap: 400, type: "charm", value: "charm_taka" },
            { ap: 500, type: "icon", value: "icon_legend" }
        ];

        // ‚òÖ„É≠„Ç∞„Ç§„É≥„Éú„Éº„Éä„ÇπÂâäÈô§
        
        // ‚òÖ„ÅäÂÆà„Çä
        const masterCharmList = {
            'none': { name: "„Å™„Åó", description: "„ÅäÂÆà„Çä„ÇíË£ÖÂÇô„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ", effect: {} },
            'charm_maneki': { name: "Èáë„ÅÆÊãõ„ÅçÁå´", description: "Áç≤ÂæóG„ÅåÊ∞∏‰πÖ„Å´+5%„Åï„Çå„Åæ„Åô„ÄÇ", effect: { money: 0.05 } },
            'charm_kame': { name: "‰∫Ä„ÅÆÁî≤ÁæÖ", description: "ÊúÄÂàù„ÅÆ3„Éü„Çπ„Åæ„Åß„Ç≥„É≥„Éú„ÅåÈÄîÂàá„Çå„Åæ„Åõ„Çì„ÄÇ", effect: { shield: 3 } },
            'charm_taka': { name: "È∑π„ÅÆÁæΩ", description: "„Éù„ÉÉ„Éó„Ç®„Éï„Çß„ÇØ„Éà„ÅåÂ∞ë„ÅóË±™ËèØ„Å´„Å™„Çä„Åæ„Åô„ÄÇ", effect: { pop: 1 } },
            'charm_hude': { name: "ÈÅî‰∫∫„ÅÆÁ≠Ü", description: "WPM„Å´Âøú„Åò„Å¶„Çπ„Ç≥„Ç¢„Å´„Éú„Éº„Éä„Çπ„ÅåÂÖ•„Çä„Åæ„Åô„ÄÇ", effect: { wpmScore: 0.1 } }
        };

        // ‚òÖ„Çπ„Ç≠„É´„ÉÑ„É™„Éº
        const masterSkillTree = {
            's01_score': { name: "„Çπ„Ç≥„Ç¢UP", icon: "S", maxLevel: 5, cost: 1, desc: "Âü∫Á§é„Çπ„Ç≥„Ç¢„Åå [L*1]% Â¢óÂä†„Åô„Çã", x: 50, y: 50, req: [] },
            's02_money': { name: "ÊâÄÊåÅÈáëUP", icon: "G", maxLevel: 5, cost: 1, desc: "Áç≤ÂæóG„Åå [L*1]% Â¢óÂä†„Åô„Çã", x: 150, y: 50, req: [] },
            'c01_combo': { name: "„Ç≥„É≥„ÉúÁå∂‰∫à", icon: "C", maxLevel: 3, cost: 2, desc: "„Ç≥„É≥„Éú„ÅÆÁå∂‰∫àÊôÇÈñì„Åå [L*0.1]Áßí Â¢óÂä†„Åô„Çã", x: 50, y: 150, req: ['s01_score'] },
            'c02_shield': { name: "„Ç∑„Éº„É´„ÉâÂº∑Âåñ", icon: "H", maxLevel: 2, cost: 3, desc: "„Ç≥„É≥„Éú„Ç∑„Éº„É´„Éâ„Åå [L*1]Âõû ËøΩÂä†„ÅßÁô∫Âãï„Åô„Çã", x: 150, y: 150, req: ['s02_money'] },
            'f01_fever': { name: "„Éï„Ç£„Éº„Éê„Éº+", icon: "F", maxLevel: 3, cost: 2, desc: "„Éï„Ç£„Éº„Éê„ÉºÁ™ÅÂÖ•„Ç≥„É≥„ÉúÊï∞„Åå [L*1] Ê∏õÂ∞ë„Åô„Çã", x: 50, y: 250, req: ['c01_combo'] },
            'f02_fever_rate': { name: "„Éï„Ç£„Éº„Éê„ÉºÂÄçÁéá", icon: "F+", maxLevel: 2, cost: 3, desc: "„Éï„Ç£„Éº„Éê„Éº‰∏≠„ÅÆ„Çπ„Ç≥„Ç¢ÂÄçÁéá„Åå [L*0.5]ÂÄç Â¢óÂä†„Åô„Çã", x: 150, y: 250, req: ['c02_shield'] },
            'p01_pet': { name: "„Éö„ÉÉ„ÉàÂøúÊè¥", icon: "P", maxLevel: 1, cost: 5, desc: "„Éö„ÉÉ„Éà„ÅÆÂøúÊè¥„Åå„Çπ„Ç≥„Ç¢„Å´ÂΩ±Èüø„Åô„Çã„Çà„ÅÜ„Å´„Å™„Çã", x: 100, y: 350, req: ['f01_fever', 'f02_fever_rate'] },
            'g01_gacha': { name: "„Ç¨„ÉÅ„É£ÈÅã", icon: "R", maxLevel: 5, cost: 2, desc: "„Ç¨„ÉÅ„É£„ÅÆ„É¨„Ç¢ÊéíÂá∫Áéá„Åå [L*0.2]% Â¢óÂä†„Åô„Çã (ÂØåË±™Ëª¢Áîü„Å®ÈáçË§á)", x: 250, y: 50, req: [] },
            'g02_gacha_cost': { name: "„Ç¨„ÉÅ„É£Ââ≤Âºï", icon: "G-", maxLevel: 3, cost: 3, desc: "„Ç¨„ÉÅ„É£„ÅÆ„Ç≥„Çπ„Éà„Åå [L*5]% Ê∏õÂ∞ë„Åô„Çã", x: 250, y: 150, req: ['g01_gacha'] },
        };

        
        // --- 4. „Å≤„Çâ„Åå„Å™ -> „É≠„Éº„ÉûÂ≠ó Â§âÊèõ„Éû„ÉÉ„Éó ---
        const romaMap = {
            '„ÅÇ': ['a'], '„ÅÑ': ['i', 'yi'], '„ÅÜ': ['u', 'wu'], '„Åà': ['e'], '„Åä': ['o'],
            '„Åã': ['ka', 'ca'], '„Åç': ['ki'], '„Åè': ['ku', 'cu'], '„Åë': ['ke'], '„Åì': ['ko', 'co'],
            '„Åï': ['sa'], '„Åó': ['si', 'shi'], '„Åô': ['su'], '„Åõ': ['se', 'ce'], '„Åù': ['so'],
            '„Åü': ['ta'], '„Å°': ['ti', 'chi'], '„Å§': ['tu', 'tsu'], '„Å¶': ['te'], '„Å®': ['to'],
            '„Å™': ['na'], '„Å´': ['ni'], '„Å¨': ['nu'], '„Å≠': ['ne'], '„ÅÆ': ['no'],
            '„ÅØ': ['ha'], '„Å≤': ['hi'], '„Åµ': ['hu', 'fu'], '„Å∏': ['he'], '„Åª': ['ho'],
            '„Åæ': ['ma'], '„Åø': ['mi'], '„ÇÄ': ['mu'], '„ÇÅ': ['me'], '„ÇÇ': ['mo'],
            '„ÇÑ': ['ya'], '„ÇÜ': ['yu'], '„Çà': ['yo'],
            '„Çâ': ['ra'], '„Çä': ['ri'], '„Çã': ['ru'], '„Çå': ['re'], '„Çç': ['ro'],
            '„Çè': ['wa'], '„Çí': ['wo'], '„Çì': ['n', 'nn', 'xn'],
            '„Éº': ['-'], '„ÄÅ': [','], '„ÄÇ': ['.'], '„Éª': ['/'], 
            '„Åå': ['ga'], '„Åé': ['gi'], '„Åê': ['gu'], '„Åí': ['ge'], '„Åî': ['go'],
            '„Åñ': ['za'], '„Åò': ['ji', 'zi'], '„Åö': ['zu'], '„Åú': ['ze'], '„Åû': ['zo'],
            '„Å†': ['da'], '„Å¢': ['di'], '„Å•': ['du'], '„Åß': ['de'], '„Å©': ['do'],
            '„Å∞': ['ba'], '„Å≥': ['bi'], '„Å∂': ['bu'], '„Åπ': ['be'], '„Åº': ['bo'],
            '„Å±': ['pa'], '„Å¥': ['pi'], '„Å∑': ['pu'], '„Å∫': ['pe'], '„ÅΩ': ['po'],
            '„Åç„ÇÉ': ['kya'], '„Åç„ÇÖ': ['kyu'], '„Åç„Çá': ['kyo'], '„Åó„ÇÉ': ['sha', 'sya'], '„Åó„ÇÖ': ['shu', 'syu'], '„Åó„Çá': ['sho', 'syo'], 
            '„Å°„ÇÉ': ['cha', 'tya'], '„Å°„ÇÖ': ['chu', 'tyu'], '„Å°„Çá': ['cho', 'tyo'], '„Å´„ÇÉ': ['nya'], '„Å´„ÇÖ': ['nyu'], '„Å´„Çá': ['nyo'], 
            '„Å≤„ÇÉ': ['hya'], '„Å≤„ÇÖ': ['hyu'], '„Å≤„Çá': ['hyo'], '„Åø„ÇÉ': ['mya'], '„Åø„ÇÖ': ['myu'], '„Åø„Çá': ['myo'], '„Çä„ÇÉ': ['rya'], '„Çä„ÇÖ': ['ryu'], '„Çä„Çá': ['ryo'],
            '„Åé„ÇÉ': ['gya'], '„Åé„ÇÖ': ['gyu'], '„Åé„Çá': ['gyo'], '„Åò„ÇÉ': ['ja', 'zya', 'jya'], '„Åò„ÇÖ': ['ju', 'zyu', 'jyu'], '„Åò„Çá': ['jo', 'zyo', 'jyo'],
            '„Å≥„ÇÉ': ['bya'], '„Å≥„ÇÖ': ['byu'], '„Å≥„Çá': ['byo'], '„Å¥„ÇÉ': ['pya'], '„Å¥„ÇÖ': ['pyu'], '„Å¥„Çá': ['pyo'],
            '„Å¶„ÅÉ': ['thi'], '„Åß„ÅÉ': ['dhi'], '„Å®„ÅÖ': ['twu'], '„Å©„ÅÖ': ['dwu'],
            '„Åµ„ÅÅ': ['fa'], '„Åµ„ÅÉ': ['fi'], '„Åµ„Åá': ['fe'], '„Åµ„Åâ': ['fo'],
            '„Åò„Åá': ['je', 'zye', 'jye'], 
            '„ÅÜ„ÅÉ': ['wi'], '„ÅÜ„Åá': ['we'],
            '„ÅÅ': ['xa', 'la'], '„ÅÉ': ['xi', 'li'], '„ÅÖ': ['xu', 'lu'], '„Åá': ['xe', 'le'], '„Åâ': ['xo', 'lo'],
            '„Å£': ['ltu', 'xtu'], 
            '„ÇÉ': ['xya', 'lya'], '„ÇÖ': ['xyu', 'lyu'], '„Çá': ['xyo', 'lyo'],
            'Ôºü': ['?'], 'ÔºÅ': ['!']
        };
        const allHiragana = Object.keys(romaMap).sort((a, b) => b.length - a.length);

        // --- 5. „Çª„Éº„Éñ/„É≠„Éº„ÉâÊ©üËÉΩ (Base64ÊöóÂè∑Âåñ) ---
        let gameData;

        // ‚òÖ„Éê„Ç∞‰øÆÊ≠£: saveData Èñ¢Êï∞„Çí loadData „ÅÆÂâç„Å´ÂÆöÁæ©
        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY, btoa(JSON.stringify(gameData)));
            } catch (e) {
                console.error("Failed to save data:", e);
                // „Éá„Éº„Çø„Çí‰øùÂ≠ò„Åß„Åç„Å™„ÅÑ„Å®„Ç≤„Éº„É†„ÅåÈÄ≤Ë°å„Åó„Å™„ÅÑ„Åü„ÇÅ„ÄÅ„ÅÇ„Åà„Å¶„Ç¢„É©„Éº„Éà„ÅØÂá∫„Åï„Å™„ÅÑ
            }
        }
        
        function getTodayString() {
            const date = new Date();
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function getWeekId() {
            const date = new Date();
            date.setHours(0, 0, 0, 0);
            // Êó•ÊõúÊó•„ÇíÈÄ±„ÅÆÂßã„Åæ„Çä(0)„Å®„Åô„Çã
            date.setDate(date.getDate() - date.getDay());
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getXPForLevel(level) {
            let prestigeBonus = 1.0;
            if (gameData.stats.prestigeType === 'standard') {
                prestigeBonus = 1 - (gameData.stats.prestigeLevel * 0.05); // 1Ëª¢Áîü„Åß5%Ê∏õ (ÊúÄÂ§ß50%„Åæ„Åß)
            }
            const effectiveBonus = Math.max(0.5, prestigeBonus); 
            return (LEVEL_BASE_XP * Math.pow(level - 1, 1.5)) * effectiveBonus;
        }
        function getLevelForXP(xp) {
            let level = 1;
            while (level < MAX_LEVEL && xp >= getXPForLevel(level + 1)) {
                level++;
            }
            return level;
        }
        function getPrestigeStar(level) {
            if (level === 0) return "";
            const icon = (gameData.stats.prestigeType === 'wealth') ? 'üíé' : '‚òÖ';
            return `${icon}${level}`; // ‚òÖ20ÊÆµÈöéÂØæÂøú
        }

        function loadData() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    let decodedData;
                    try { decodedData = atob(savedData); } catch (e) { decodedData = savedData; }
                    const parsedData = JSON.parse(decodedData);
                    
                    const defaultData = getDefaultGameData(); 

                    gameData = parsedData;

                    // Ë§áÈõë„Å™„Éç„Çπ„ÉàÊßãÈÄ†„ÅÆ‰∫íÊèõÊÄß„ÉÅ„Çß„ÉÉ„ÇØ
                    const checkAndMerge = (target, source) => {
                        for (const key in source) {
                            if (target[key] === undefined) {
                                target[key] = source[key];
                            } else if (typeof source[key] === 'object' && !Array.isArray(source[key]) && source[key] !== null) {
                                if (typeof target[key] !== 'object' || target[key] === null) {
                                    target[key] = source[key]; // Êó¢Â≠ò„Éá„Éº„Çø„Åå„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Åß„Å™„ÅÑÂ†¥Âêà„ÅØ‰∏äÊõ∏„Åç
                                } else {
                                    checkAndMerge(target[key], source[key]); // ÂÜçÂ∏∞ÁöÑ„Å´„ÉÅ„Çß„ÉÉ„ÇØ
                                }
                            }
                        }
                    };
                    
                    checkAndMerge(gameData, defaultData);
                    // stats„Å†„Åë„ÅØÂÄãÂà•„Ç≠„Éº„ÇÇ„ÉÅ„Çß„ÉÉ„ÇØ
                    checkAndMerge(gameData.stats, defaultData.stats);
                    checkAndMerge(gameData.settings, defaultData.settings);
                    checkAndMerge(gameData.upgrades, defaultData.upgrades);
                    checkAndMerge(gameData.missions, defaultData.missions);
                    
                    // ‚òÖ„É≠„Ç∞„Ç§„É≥„Éú„Éº„Éä„ÇπÂâäÈô§„Å´‰º¥„ÅÜ„Éá„Éº„ÇøÁßªË°åÔºà„ÇÇ„ÅóÂ≠òÂú®„Åó„Åü„ÇâÂâäÈô§Ôºâ
                    if (gameData.loginBonus) {
                        delete gameData.loginBonus;
                    }

                } else {
                    gameData = getDefaultGameData();
                }
            } catch (e) {
                console.error("Load failed, resetting data:", e);
                gameData = getDefaultGameData();
            }
            
            // BGM URLË®≠ÂÆö
            allBgms = [
                { id: 'bgm-audio', el: bgmAudio, url: "https://www.dropbox.com/scl/fi/79m1wyy142q9t7165jvpi/.mp3?rlkey=31l2lrxcg678t5gqe7eczh52k&st=f06uemyo&dl=1" },
                { id: 'bgm-audio-2', el: bgmAudio2, url: "https://www.dropbox.com/scl/fi/v63z211p38l9rx13h3m7c/battle.mp3?rlkey=l5i3rgz5e4j1mm8x2s7y2c74d&st=o05o763f&dl=1" },
                { id: 'bgm-audio-3', el: bgmAudio3, url: "https://www.dropbox.com/scl/fi/eplv77vllv8qebm9k3xxy/dream.mp3?rlkey=f9b1t9p3h9g44s6o8g04499r3&st=8w6f3oef&dl=1" }
            ];
            allBgms.forEach(bgm => {
                bgm.el.src = bgm.url;
            });
            
            // ‰ªäÊó•„ÅÆÊó•‰ªò„ÉÅ„Çß„ÉÉ„ÇØ („Éü„ÉÉ„Ç∑„Éß„É≥)
            const today = getTodayString();
            if (gameData.missions.lastLogin !== today) {
                gameData.missions.daily = getDefaultGameData().missions.daily;
                gameData.missions.dailyRewards = getDefaultGameData().missions.dailyRewards;
                gameData.missions.lastLogin = today;
            }
            
            // ‰ªäÈÄ±„ÅÆID„ÉÅ„Çß„ÉÉ„ÇØ („Ç¶„Ç£„Éº„ÇØ„É™„Éº„Éü„ÉÉ„Ç∑„Éß„É≥)
            const weekId = getWeekId();
            if (gameData.missions.lastWeekId !== weekId) {
                gameData.missions.weekly = {}; // „É™„Çª„ÉÉ„Éà
                gameData.missions.weeklyRewards = {}; // „É™„Çª„ÉÉ„Éà
                // Êñ∞„Åó„ÅÑ„Éü„ÉÉ„Ç∑„Éß„É≥„Çí3„Å§Ë®≠ÂÆö
                let newMissions = [...masterWeeklyMissions].sort(() => 0.5 - Math.random()).slice(0, 3);
                gameData.missions.currentWeeklyIds = newMissions.map(m => m.id);
                gameData.missions.lastWeekId = weekId;
            }
            
            // Áµ±Ë®à„Éá„Éº„Çø„ÅÆÂ±•Ê≠¥„Åå„Å™„Åë„Çå„Å∞‰ΩúÊàê
            if (!gameData.stats.history) {
                gameData.stats.history = [{ date: today, score: 0, wpm: 0, games: 0 }];
            }
            
            // ‚òÖ„Éá„Éï„Ç©„É´„Éà„Ç¢„Ç§„ÉÜ„É†Êú™Ëß£Êîæ„Éê„Ç∞‰øÆÊ≠£
            const defaultLists = {
                'unlockedBackgrounds': ['bg-default'],
                'unlockedFonts': ['font-default'], 
                'unlockedSounds': ['sound-default'], 
                'unlockedPacks': ['default', 'pack_english'], 
                'unlockedEffects': ['default'],
                'unlockedThemes': ['default'], 
                'unlockedPets': ['pet-cat'],
                'unlockedPetItems': ['none'],
                'unlockedPetHouses': ['pet-house-none'],
                'unlockedBgms': ['bgm-audio'],
                'unlockedKeyboardSkins': ['kb-skin-default'],
                'unlockedIcons': ['icon-default'],
                'unlockedCharms': ['none']
            };
            for (const listKey in defaultLists) {
                defaultLists[listKey].forEach(defaultId => {
                    if (!gameData[listKey].includes(defaultId)) {
                        gameData[listKey].push(defaultId);
                    }
                });
            }

            setWordList(gameData.settings.currentWordPack);
            applyTheme(); 
            applyBackground(); 
            applyFont(); 
            applyFuriganaSetting(); 
            applyBGMSetting(false); 
            applyPet();
            applyKeyboardSkin();
            applyCharmEffects(); // „ÅäÂÆà„ÇäÂäπÊûú„ÇíË®àÁÆó
            updateDataUI();

            prestigeBtn.style.display = (gameData.stats.level >= MAX_LEVEL && gameData.stats.prestigeLevel < MAX_PRESTIGE_LEVEL) ? 'flex' : 'none';
            
            checkActiveEvents();
            saveData(); // ‚òÖ„Éê„Ç∞‰øÆÊ≠£: Ë™≠„ÅøËæº„ÅøÁõ¥Âæå„Å´‰∏ÄÂ∫¶‰øùÂ≠ò
        }// ‚òÖ„Éê„Ç∞‰øÆÊ≠£: „Éá„Éï„Ç©„É´„Éà„Ç¢„Ç§„ÉÜ„É†Êú™Ëß£ÊîæÔºÜÊ©üËÉΩÂâäÈô§„ÅÆ„Åü„ÇÅ„ÄÅgetDefaultGameData „Çí‰∏äÊõ∏„ÅçÂÆöÁæ©
        function getDefaultGameData() { 
            let defaultItems = {};
            for (const itemKey in masterItemList) {
                if (!masterItemList[itemKey].gacha && !masterItemList[itemKey].event) { //‚òÖ„Ç§„Éô„É≥„Éà„Ç¢„Ç§„ÉÜ„É†„ÇíÈô§Â§ñ
                    defaultItems[itemKey] = false;
                }
            }

            let defaultAchievements = {};
            Object.keys(masterAchievementList).forEach(key => defaultAchievements[key] = false);

            let defaultMissions = {
                lastLogin: "1970-01-01",
                daily: {
                    playCount: 0,
                    moneyEarned: 0,
                    totalTypes: 0,
                    maxCombo: 0
                },
                dailyRewards: {
                    dailyPlay: false,
                    dailyMoney: false,
                    dailyTypes: false,
                    dailyMaxCombo: false
                },
                lastWeekId: "1970-01-01",
                currentWeeklyIds: [],
                weekly: {},
                weeklyRewards: {}
            };
            
            // ‚òÖ„É≠„Ç∞„Ç§„É≥„Éú„Éº„Éä„ÇπÂâäÈô§
            // let defaultLoginBonus = { ... };

            return { 
                stats: { 
                    money: 0, totalTypes: 0, correctTypes: 0, maxCombo: 0, 
                    totalPlayTime: 0, totalGamesPlayed: 0, level: 1, xp: 0, 
                    prestigeLevel: 0, prestigeType: null, playerName: "TYPER", 
                    gachaPulls: 0, ap: 0, skillPoints: 0,
                    modesPlayed: {}, // ‚òÖÊñ∞„É¢„Éº„Éâ
                    history: [] // ‚òÖÁµ±Ë®à
                }, 
                highScores: { 
                    time_30: { score: 0 }, 
                    words_30: { score: 0 }, 
                    suddenDeath: { score: 0 },
                    timeAttack: { score: 999.99 }, 
                    accuracy: { score: 0 },
                    // lyrics: { score: 0 }, // ‚òÖÊ≠åË©ûÂâäÈô§
                    english: { score: 0 },
                    double: { score: 0 },
                    fill: { score: 0 },
                    fast: { score: 0 }
                },
                ranking: { 
                    time_30: [], suddenDeath: [], timeAttack: [], accuracy: [],
                    // lyrics: [], // ‚òÖÊ≠åË©ûÂâäÈô§
                    english: [], double: [], fill: [], fast: []
                },
                ghosts: { 
                    time_30: [], suddenDeath: [], timeAttack: [], accuracy: [],
                    // lyrics: [], // ‚òÖÊ≠åË©ûÂâäÈô§
                    english: [], double: [], fill: [], fast: []
                },
                unlockedTitles: Array(TOTAL_TITLES).fill(false), 
                activeItems: defaultItems,
                settings: { 
                    currentBackground: 'bg-default', 
                    legendRainbowEffect: true, 
                    showFurigana: true,
                    bgmOn: true,
                    currentFont: 'font-default',
                    currentSound: 'sound-default',
                    currentWordPack: 'default',
                    currentEffect: 'default',
                    currentTheme: 'default',
                    currentPet: 'pet-cat',
                    currentPetItem: 'none',
                    currentPetHouse: 'pet-house-none',
                    currentTitleColor: '#2ecc71',
                    currentBgm: 'bgm-audio',
                    currentKeyboardSkin: 'kb-skin-default',
                    currentCharm: 'none',
                    currentIcon: 'icon-default',
                    petPosition: { x: 20, y: window.innerHeight - 120 },
                    currentPreset: 0
                },
                // ‚òÖ„Éá„Éï„Ç©„É´„ÉàËß£Êîæ„Éê„Ç∞‰øÆÊ≠£: „Éá„Éï„Ç©„É´„Éà„Ç¢„Ç§„ÉÜ„É†„Çí„É™„Çπ„Éà„Å´Âê´„ÇÅ„Çã
                unlockedBackgrounds: ['bg-default'],
                unlockedFonts: ['font-default'], 
                unlockedSounds: ['sound-default'], 
                unlockedPacks: ['default', 'pack_english'], // Ëã±Ë™û„ÅØ„Éá„Éï„Ç©„É´„ÉàËß£Êîæ
                unlockedEffects: ['default'],
                unlockedThemes: ['default'], 
                unlockedPets: ['pet-cat'],
                unlockedPetItems: ['none'],
                unlockedPetHouses: ['pet-house-none'],
                unlockedTitleColors: ['#2ecc71', '#e74c3c', '#3498db', '#f1c40f', '#ffffff'],
                unlockedBgms: ['bgm-audio'],
                unlockedKeyboardSkins: ['kb-skin-default'],
                unlockedIcons: ['icon-default'],
                unlockedCharms: ['none'],
                claimedApRewards: [],
                upgrades: { moneyBoost: 0, feverTime: 0, infiniteFever: false }, 
                missions: defaultMissions,
                // loginBonus: {}, // ‚òÖ„É≠„Ç∞„Ç§„É≥„Éú„Éº„Éä„ÇπÂâäÈô§
                achievements: defaultAchievements,
                skills: {}, // ‚òÖ„Çπ„Ç≠„É´
                presets: [ // ‚òÖ„Éó„É™„Çª„ÉÉ„Éà
                    { skills: {}, charm: 'none' },
                    { skills: {}, charm: 'none' },
                    { skills: {}, charm: 'none' }
                ],
                prestigeTrial: { // ‚òÖËª¢ÁîüË©¶Á∑¥
                    active: false,
                    type: null, // 'combo', 'perfect'
                    rewardSP: 0,
                    progress: 0
                },
                weakWords: {} // ‚òÖËã¶ÊâãÂçòË™û
            }; 
        }

        function updateDataUI() {
            moneyDisplay.innerText = gameData.stats.money.toLocaleString();
            skillPointDisplay.innerText = gameData.stats.skillPoints.toLocaleString();
            
            let prestigeStar = getPrestigeStar(gameData.stats.prestigeLevel);
            levelDisplay.innerText = `Lv. ${gameData.stats.level} ${prestigeStar}`;
            const currentLevelXP = getXPForLevel(gameData.stats.level);
            const nextLevelXP = getXPForLevel(gameData.stats.level + 1);
            let xpProgress = (gameData.stats.xp - currentLevelXP);
            let xpForNext = (nextLevelXP - currentLevelXP);

            if (gameData.stats.level >= MAX_LEVEL && gameData.stats.prestigeLevel < MAX_PRESTIGE_LEVEL) {
                xpProgress = 1;
                xpForNext = 1;
                xpLabel.innerText = "XP: MAX (Ëª¢ÁîüÂèØËÉΩ)";
            } else if (gameData.stats.level >= MAX_LEVEL && gameData.stats.prestigeLevel >= MAX_PRESTIGE_LEVEL) {
                xpProgress = 1;
                xpForNext = 1;
                xpLabel.innerText = "XP: MAX";
            }
             else {
                xpLabel.innerText = `XP: ${Math.floor(xpProgress).toLocaleString()} / ${Math.floor(xpForNext).toLocaleString()}`;
            }
            xpBarProgress.style.width = `${(xpProgress / xpForNext) * 100}%`;
            
            let currentModeKey = getModeKey();
            
            const modeLabels = {
                'time_30': "T-30„Éè„Ç§„Çπ„Ç≥„Ç¢",
                'words_30': "W-30„Éè„Ç§„Çπ„Ç≥„Ç¢",
                'suddenDeath': "„Çµ„Éâ„É≥„Éá„Çπ „Éè„Ç§„Çπ„Ç≥„Ç¢",
                'timeAttack': "TA (20ÂçòË™û) „Éè„Ç§„Çπ„Ç≥„Ç¢",
                'accuracy': "Á≤æÂ∫¶ (1ÂàÜ) „Éè„Ç§„Çπ„Ç≥„Ç¢",
                // 'lyrics': "Ê≠åË©û„Çø„Ç§„Éî„É≥„Ç∞ „Éè„Ç§„Çπ„Ç≥„Ç¢", // ‚òÖÊ≠åË©ûÂâäÈô§
                'english': "Ëã±ÂçòË™û „Éè„Ç§„Çπ„Ç≥„Ç¢",
                'double': "„ÉÄ„Éñ„É´ „Éè„Ç§„Çπ„Ç≥„Ç¢",
                'fill': "Á©¥Âüã„ÇÅ „Éè„Ç§„Çπ„Ç≥„Ç¢",
                'fast': "Êó©ÈÄÅ„Çä „Éè„Ç§„Çπ„Ç≥„Ç¢",
                'custom': "„Ç´„Çπ„Çø„É†„É¢„Éº„Éâ"
            };
            let label = modeLabels[currentModeKey] || "„Éè„Ç§„Çπ„Ç≥„Ç¢";
            
            highScoreLabel.innerText = label;
            
            if (gameMode !== 'custom') {
                if (!gameData.highScores[currentModeKey]) { 
                    if(gameMode === 'timeAttack') gameData.highScores[currentModeKey] = { score: 999.99 };
                    else gameData.highScores[currentModeKey] = { score: 0 }; 
                }
                let score = gameData.highScores[currentModeKey].score;
                if(gameMode === 'timeAttack') highScoreDisplay.innerText = (score === 999.99) ? "---" : `${score.toFixed(2)}s`;
                else if (gameMode === 'accuracy') highScoreDisplay.innerText = `${score.toFixed(2)}%`;
                else highScoreDisplay.innerText = score.toLocaleString();

            } else {
                highScoreDisplay.innerText = "---";
            }
        }
        
        // --- 6. „Ç≤„Éº„É†„É≠„Ç∏„ÉÉ„ÇØ („ÅäÈ°åË™≠„ÅøËæº„Åø) ---
        
        function getNextWord() {
            let wordData;
            if (gameMode === 'custom') {
                wordData = wordsToType[currentWordIndex];
            }
            else if (isEasyStartActive && currentWordIndex < 5) {
                wordData = easyWordList[Math.floor(Math.random() * easyWordList.length)];
            } else {
                let lengthToUse = currentTimeModeLength;
                if (gameMode === 'suddenDeath' || gameMode === 'accuracy' || gameMode === 'double' || gameMode === 'fill' || gameMode === 'fast' || gameMode === 'english') { 
                     lengthToUse = MIN_YOMI_LENGTH + Math.floor(Math.random() * (MAX_YOMI_LENGTH - MIN_YOMI_LENGTH + 1));
                }
                while (lengthToUse > MIN_YOMI_LENGTH && (!wordListByYomiLength[lengthToUse] || wordListByYomiLength[lengthToUse].length === 0)) {
                    lengthToUse--;
                }
                const availableWords = wordListByYomiLength[lengthToUse] || easyWordList;
                
                if (!availableWords || availableWords.length === 0) {
                    console.error("No available words for pack:", currentWordPack);
                    return { display: "„Ç®„É©„Éº", yomi: "„Åà„Çâ„Éº" }; // 
                }
                
                let attempts = 0;
                do {
                    wordData = availableWords[Math.floor(Math.random() * availableWords.length)];
                    attempts++;
                } while (recentWords.includes(wordData.yomi) && attempts < 10 && availableWords.length > RECENT_WORD_MAX)

                recentWords.push(wordData.yomi);
                if (recentWords.length > RECENT_WORD_MAX) {
                    recentWords.shift(); 
                }
            }
            return wordData;
        }

        function loadCurrentWord() {
            let wordData;
            
            if (gameMode === 'time' || gameMode === 'suddenDeath' || gameMode === 'accuracy' || gameMode === 'fast' || gameMode === 'english' || gameMode === 'fill') { 
                wordData = getNextWord();
                currentWordIndex++; 
            } 
            else if (gameMode === 'double') {
                wordData = getNextWord();
                doubleWordData = getNextWord(); // 2„Å§ÁõÆ„ÅÆ„ÅäÈ°å
                currentWordIndex++;
            }
            else { // 'words' or 'custom' or 'timeAttack'
                if (currentWordIndex >= gameValue) { 
                    if (gameRunning) endGame(); 
                    return; 
                }
                wordData = wordsToType[currentWordIndex];
            }

            if (!wordData) {
                console.error("Word data is undefined. Forcing game end.");
                if (gameRunning) endGame();
                return;
            }
            
            // ‚òÖËã¶ÊâãÂçòË™û
            if(gameMode !== 'custom') {
                if(!gameData.weakWords[wordData.yomi]) {
                    gameData.weakWords[wordData.yomi] = { yomi: wordData.yomi, display: wordData.display, miss: 0, total: 0 };
                }
                gameData.weakWords[wordData.yomi].total++;
            }

            // ‚òÖÁ©¥Âüã„ÇÅ„É¢„Éº„Éâ
            if (gameMode === 'fill') {
                const yomi = wordData.yomi;
                if (yomi.length > 2) {
                    const hideIndex = 1 + Math.floor(Math.random() * (yomi.length - 2));
                    const displayYomi = yomi.substring(0, hideIndex) + 'Ôºü' + yomi.substring(hideIndex + 1);
                    kanjiDisplay.innerHTML = `<ruby>${wordData.display}<rt>${displayYomi}</rt></ruby>`;
                } else {
                    kanjiDisplay.innerHTML = wordData.display;
                }
            } else {
                 kanjiDisplay.innerHTML = wordData.display;
            }
            
            // ‚òÖ„ÉÄ„Éñ„É´„É¢„Éº„Éâ
            if (gameMode === 'double' && doubleWordData) {
                wordDisplaySub.innerHTML = doubleWordData.display;
                wordDisplaySub.style.display = 'block';
            } else {
                wordDisplaySub.style.display = 'none';
            }

            const yomi = wordData.yomi;
            wordDisplayElement.innerHTML = '';
            hiraganaSpans = [];
            let i = 0;
            const wordLength = yomi.length; 
            while (i < wordLength) {
                let currentHiragana = '';
                let found = false;
                
                // ‚òÖËã±ÂçòË™û„É¢„Éº„Éâ
                if (gameMode === 'english') {
                    currentHiragana = yomi[i]; // 1ÊñáÂ≠ó„Åö„Å§
                    found = true;
                } else {
                    for (const hira of allHiragana) {
                        if (yomi.substring(i, i + hira.length) === hira) {
                            currentHiragana = hira;
                            found = true;
                            break;
                        }
                    }
                }
                if (!found) { currentHiragana = yomi[i]; }
                const span = document.createElement('span');
                span.innerText = currentHiragana;
                wordDisplayElement.appendChild(span);
                hiraganaSpans.push(span);
                i += currentHiragana.length;
            }
            targetHiraganaIndex = 0;
            updateTargetRoma();
        }

        function updateTargetRoma() {
            hiraganaSpans.forEach(span => span.classList.remove('current', 'incorrect'));
            if (targetHiraganaIndex >= hiraganaSpans.length) { return; }

            const targetHiragana = hiraganaSpans[targetHiraganaIndex].innerText;
            let romajiOptions = [];

            // ‚òÖËã±ÂçòË™û„É¢„Éº„Éâ
            if (gameMode === 'english') {
                romajiOptions = [targetHiragana];
            }
            else if (targetHiragana === '„Å£') {
                romajiOptions = romaMap['„Å£'].slice();
                if (targetHiraganaIndex + 1 < hiraganaSpans.length) {
                    const nextHiragana = hiraganaSpans[targetHiraganaIndex + 1].innerText;
                    let nextRoma = romaMap[nextHiragana];
                    let firstChar = '';
                    if (Array.isArray(nextRoma) && nextRoma.length > 0) { firstChar = nextRoma[0][0]; }
                    if (firstChar && !["a", "i", "u", "e", "o", "n", "-", ",", ".", "/", " "].includes(firstChar)) { romajiOptions.push(firstChar); }
                }
            } else if (targetHiragana === '„Çì') {
                romajiOptions = ['n', 'xn'];
                if (targetHiraganaIndex + 1 < hiraganaSpans.length) {
                    const nextHiragana = hiraganaSpans[targetHiraganaIndex + 1].innerText;
                    let nextRoma = romaMap[nextHiragana];
                    let startsWithN = false;
                    if (Array.isArray(nextRoma)) { startsWithN = nextRoma.some(r => r.startsWith('n'));
                    } else if (typeof nextRoma === 'string') { startsWithN = nextRoma.startsWith('n'); }
                    if (!startsWithN) { romajiOptions.push('nn'); }
                } else { romajiOptions.push('nn'); }
            } else { 
                romajiOptions = romaMap[targetHiragana] || [targetHiragana]; 
            }
            
            targetRomaOptions = romajiOptions.flat();
            currentRomaInput = "";
            hiraganaSpans[targetHiraganaIndex].classList.add('current');
        }
        
        // --- 7. „Ç≤„Éº„É†„É≠„Ç∏„ÉÉ„ÇØ (ÈñãÂßã / ÁµÇ‰∫Ü / „É™„Çª„ÉÉ„Éà) ---
        
        function startGame() {
            if (gameRunning || gameWaitingToStart) return; 
            gameWaitingToStart = true; 
            
            gameData.stats.totalGamesPlayed++;
            gameData.stats.modesPlayed[gameMode] = (gameData.stats.modesPlayed[gameMode] || 0) + 1;
            gameData.missions.daily.playCount++;
            
            fastModeSpeed = 1.0; // Êó©ÈÄÅ„Çä„É¢„Éº„Éâ„É™„Çª„ÉÉ„Éà
            
            // „É¢„Éº„Éâ„Åî„Å®„ÅÆ„ÅäÈ°åË®≠ÂÆö
            if (gameMode === 'words' || gameMode === 'timeAttack') { // ‚òÖÊ≠åË©ûÂâäÈô§
                wordsToType = [];
                let tempWordList = [...masterWordList];
                for (let i = 0; i < gameValue; i++) {
                    if (isEasyStartActive && i < 5) {
                        wordsToType.push(easyWordList[Math.floor(Math.random() * easyWordList.length)]);
                    } else {
                        if (tempWordList.length === 0) { tempWordList = [...masterWordList]; } 
                        const randIndex = Math.floor(Math.random() * tempWordList.length);
                        wordsToType.push(tempWordList.splice(randIndex, 1)[0]);
                    }
                }
            } else if (gameMode === 'custom') {
                // wordsToType „ÅØ switchMode ÊôÇ„Å´Ë®≠ÂÆöÊ∏à„Åø
            }

            loadCurrentWord(); 
        }

        function startGameTimer() {
            startTime = new Date();
            gameStartTime = new Date(); 
            clearInterval(timer); 
            const timerElement = document.getElementById('timer');
            
            startGhostTimer(); // ‚òÖ„Ç¥„Éº„Çπ„ÉàÂÜçÁîü
            playBGM(); 

            if (gameMode === 'time' || gameMode === 'accuracy') { 
                const updateDownTimer = () => {
                    let timeFactor = 1.0;
                    if (isSlowTimerActive) { timeFactor = 1.1; } 

                    const elapsedTime = ((new Date() - startTime) / 1000) / timeFactor;
                    
                    remainingTime = gameValue - elapsedTime;

                    if (isFeverTime && !gameData.upgrades.infiniteFever && Date.now() > feverEndTime) {
                        isFeverTime = false;
                        document.body.classList.remove('fever-active');
                        feverTimerDisplay.style.display = 'none';
                    }
                    if (isFeverTime && !gameData.upgrades.infiniteFever) {
                        feverTimerDisplay.innerText = ((feverEndTime - Date.now()) / 1000).toFixed(1);
                    }
                    if (isFeverTime && gameData.upgrades.infiniteFever) {
                         feverTimerDisplay.innerText = "‚àû"; 
                    }


                    if (remainingTime <= 0) { 
                        timerElement.innerText = "0.00"; 
                        endGame(); 
                    } 
                    else { timerElement.innerText = remainingTime.toFixed(2); }
                };
                timer = setInterval(updateDownTimer, 10); 
            } 
            else { // 'words', 'suddenDeath', 'timeAttack', 'english', 'double', 'fill', 'fast', 'custom'
                const updateUpTimer = () => {
                    let timeFactor = (gameMode === 'fast') ? fastModeSpeed : 1.0;
                    const elapsedTime = ((new Date() - startTime) / 1000) * timeFactor;

                    if (isFeverTime && !gameData.upgrades.infiniteFever && Date.now() > feverEndTime) {
                        isFeverTime = false;
                        document.body.classList.remove('fever-active');
                        feverTimerDisplay.style.display = 'none';
                    }
                    if (isFeverTime && !gameData.upgrades.infiniteFever) {
                        feverTimerDisplay.innerText = ((feverEndTime - Date.now()) / 1000).toFixed(1);
                    }
                    if (isFeverTime && gameData.upgrades.infiniteFever) {
                         feverTimerDisplay.innerText = "‚àû"; 
                    }

                    timerElement.innerText = elapsedTime.toFixed(2);
                };
                timer = setInterval(updateUpTimer, 10); 
            }
        }
        
        function endGame() {
            if (!gameRunning) return;
            gameRunning = false;
            gameWaitingToStart = false; 
            clearInterval(timer); 
            stopGhostTimer(); // ‚òÖ„Ç¥„Éº„Çπ„ÉàÂÅúÊ≠¢
            setPetState('idle'); // ‚òÖ„Éö„ÉÉ„Éà
            
            isFeverTime = false;
            document.body.classList.remove('fever-active');
            feverTimerDisplay.style.display = 'none';

            if (gameStartTime) {
                gameData.stats.totalPlayTime += (new Date() - gameStartTime);
            }

            const duration = (new Date() - startTime) / 1000;
            const wpm = (duration > 0) ? (correctCharsCount / 5) / (duration / 60) : 0;
            const accuracy = (totalTypeCount > 0) ? (correctCharsCount / totalTypeCount * 100) : 100;
            
            let finalMoneyGained = 0;
            if (!escapePressed) { 
                let baseMoney = (gameMode === 'suddenDeath') ? currentScore : Math.round(currentScore * 0.1);
                
                // Ëª¢Áîü„Éú„Éº„Éä„Çπ
                let prestigeBonus = (gameData.stats.prestigeType === 'standard') ? (1 + (gameData.stats.prestigeLevel * 0.05)) : 1.0;
                // „Çπ„Ç≠„É´„Éú„Éº„Éä„Çπ
                prestigeBonus += getSkillEffect('s02_money') * 0.01;
                // ‚òÖ„ÅäÂÆà„Çä„Éê„Ç∞‰øÆÊ≠£: getCharmEffect„Çí‰Ωø„ÅÜ
                prestigeBonus += getCharmEffect('money');
                
                baseMoney *= prestigeBonus;
                baseMoney *= (1 + (gameData.upgrades.moneyBoost * 0.1));
                if (isWeekendBoost) { baseMoney *= 1.5; } 
                
                finalMoneyGained = Math.round(baseMoney);

                if (isMoneyBoostActive) { finalMoneyGained *= 2; }
                
                if (gameMode !== 'custom') { 
                    gameData.stats.money += finalMoneyGained;
                    gameData.missions.daily.moneyEarned += finalMoneyGained;
                }
            }
            
            let newHighScore = false;
            let currentModeKey = getModeKey();

            if (!gameData.highScores[currentModeKey]) { 
                if(gameMode === 'timeAttack') gameData.highScores[currentModeKey] = { score: 999.99 };
                else gameData.highScores[currentModeKey] = { score: 0 }; 
            }
            
            let finalScore = currentScore;
            if (gameMode === 'suddenDeath' || gameMode === 'fast') finalScore = totalTypeCount;
            if (gameMode === 'timeAttack') finalScore = duration; // ÊôÇÈñì
            if (gameMode === 'accuracy') finalScore = accuracy; // Ê≠£Ëß£Áéá
            
            // Ëª¢Áîü„Éú„Éº„Éä„Çπ
            let prestigeScoreBonus = (gameData.stats.prestigeType === 'standard') ? (1 + (gameData.stats.prestigeLevel * 0.05)) : 1.0;
            // „Çπ„Ç≠„É´„Éú„Éº„Éä„Çπ
            prestigeScoreBonus += getSkillEffect('s01_score') * 0.01;
            // ‚òÖ„ÅäÂÆà„Çä„Éê„Ç∞‰øÆÊ≠£: WPM„Éú„Éº„Éä„Çπ
            prestigeScoreBonus += wpm * getCharmEffect('wpmScore');

            if (gameMode !== 'timeAttack' && gameMode !== 'accuracy') {
                finalScore *= prestigeScoreBonus;
            }
            if (isWeekendBoost && gameMode !== 'timeAttack' && gameMode !== 'accuracy') { 
                finalScore = Math.round(finalScore * 1.5); 
            } 
            finalScore = (gameMode === 'timeAttack') ? parseFloat(finalScore.toFixed(2)) : Math.round(finalScore);


            if (!escapePressed && gameMode !== 'custom') {
                if (gameMode === 'timeAttack') {
                    if (finalScore < gameData.highScores[currentModeKey].score) {
                        gameData.highScores[currentModeKey].score = finalScore;
                        newHighScore = true;
                    }
                } else {
                    if (finalScore > gameData.highScores[currentModeKey].score) {
                        gameData.highScores[currentModeKey].score = finalScore;
                        newHighScore = true;
                    }
                }
                
                if (newHighScore) {
                    addRankingEntry(currentModeKey, finalScore);
                    saveGhostData(currentModeKey); 
                }
            }
            
            let newTitleUnlocked = null;
            if (!escapePressed && gameMode !== 'custom' && gameMode !== 'timeAttack' && gameMode !== 'accuracy') { 
                masterTitleList.forEach((title, index) => {
                    if (!gameData.unlockedTitles[index] && finalScore >= title.score) {
                        gameData.unlockedTitles[index] = true;
                        newTitleUnlocked = title.name;
                    }
                });
            }
            
            // Áµ±Ë®àÊõ¥Êñ∞
            gameData.stats.totalTypes += totalTypeCount;
            gameData.stats.correctTypes += correctCharsCount;
            if (maxComboThisGame > gameData.stats.maxCombo) {
                gameData.stats.maxCombo = maxComboThisGame;
            }
            if (maxComboThisGame > gameData.missions.daily.maxCombo) {
                gameData.missions.daily.maxCombo = maxComboThisGame;
            }
            gameData.missions.daily.totalTypes += totalTypeCount;
            updateStatsHistory(finalScore, wpm); 
            
            
            const gameResult = { gameMode: getModeKey(), errors: errors, maxCombo: maxComboThisGame, accuracy: accuracy, gachaRarity: null, score: finalScore, pack: currentWordPack };
            
            // Ëª¢ÁîüË©¶Á∑¥„ÉÅ„Çß„ÉÉ„ÇØ
            checkPrestigeTrial(gameResult);

            if (gameMode !== 'custom') {
                checkMissions(gameResult);
                checkWeeklyMissions(gameResult);
                checkAchievements(gameResult);
            }

            saveData();
            updateDataUI(); 
            
            if (escapePressed) {
                document.getElementById('end-result-title').innerText = "„ÅäÁñ≤„ÇåÊßò";
                document.getElementById('end-title').innerText = "„Çø„Ç§„Éî„É≥„Ç∞È†ëÂºµ„ÇåÔºÅ";
            } else {
                let titleText = "GAME OVER";
                if(gameMode === 'suddenDeath' && errors > 0) titleText = "MISS!";
                else if (gameMode === 'suddenDeath' || gameMode === 'words' || gameMode === 'timeAttack' || gameMode === 'custom' || gameMode === 'english' || gameMode === 'double' || gameMode === 'fill' || gameMode === 'fast') titleText = "FINISH!";
                else if (gameMode === 'accuracy') titleText = (accuracy >= 98.0) ? "CHALLENGE CLEAR!" : "CHALLENGE FAILED...";
                
                document.getElementById('end-result-title').innerText = titleText;
                document.getElementById('end-title').innerText = newHighScore ? "üéâ NEW HIGH SCORE! üéâ" : "";
                if (newTitleUnlocked) { document.getElementById('end-title').innerText = `üèÜ Áß∞Âè∑„Äå${newTitleUnlocked}„ÄçÁç≤ÂæóÔºÅ üèÜ`; }
            }

            document.getElementById('end-wpm').querySelector('span').innerText = wpm.toFixed(2);
            document.getElementById('end-accuracy').querySelector('span').innerText = accuracy.toFixed(2) + '%';
            document.getElementById('end-total-typed').querySelector('span').innerText = totalTypeCount.toLocaleString();
            
            let scoreLabel = "Score";
            let scoreValue = finalScore.toLocaleString();
            if (gameMode === 'timeAttack') { scoreLabel = "Time"; scoreValue = `${finalScore.toFixed(2)}s`; }
            if (gameMode === 'accuracy') { scoreLabel = "Accuracy"; scoreValue = `${finalScore.toFixed(2)}%`; }
            if (gameMode === 'fast') { scoreLabel = "Typed"; scoreValue = finalScore.toLocaleString(); }
            document.getElementById('end-score').innerText = `${scoreLabel}: ${scoreValue}`;
            
            lastGameResult = { modeText: highScoreLabel.innerText, scoreValue: scoreValue, wpm: wpm.toFixed(2), accuracy: accuracy.toFixed(2) };

            const shareBtn = document.getElementById('share-button');
            if (gameMode === 'custom' || escapePressed) {
                shareBtn.style.display = 'none';
            } else {
                shareBtn.style.display = 'inline-block';
            }

            document.getElementById('end-screen-overlay').style.display = 'flex';
        }
        
        function getModeKey() {
            if (gameMode === 'time') return 'time_30';
            if (gameMode === 'words') return 'words_30';
            return gameMode; // ‰ªñ„ÅØ„Åù„ÅÆ„Åæ„Åæ
        }

        function resetGame() {
            // loadData() „ÅØÂëº„Å∞„Å™„ÅÑ„ÄÇË®≠ÂÆöÂ§âÊõ¥ÊôÇ„ÅÆ„ÅøÂëº„Å∂
            clearInterval(timer);
            stopGhostTimer(); 
            ghostScoreDisplay.style.display = 'none';
            document.getElementById('end-screen-overlay').style.display = 'none';

            gameRunning = false;
            gameWaitingToStart = false; 
            escapePressed = false; 
            errors = 0; totalTypeCount = 0;
            correctCharsCount = 0; currentWordIndex = 0;
            currentScore = 0; scoreDisplay.innerText = 0;
            currentCombo = 0; comboDisplay.innerText = 0; maxComboThisGame = 0; 
            totalTypedDisplay.innerText = 0; 
            boostLevel = 1;
            currentTimeModeLength = MIN_YOMI_LENGTH; 
            recentWords = []; 
            isWeekendBoost = false; 
            
            isScoreBoostActive = false; isMoneyBoostActive = false; isComboShieldActive = false;
            isEasyStartActive = false; isSlowTimerActive = false; isFeverItemActive = false;
            isFeverTime = false; document.body.classList.remove('fever-active'); feverTimerDisplay.style.display = 'none';
            
            // ‚òÖ„ÅäÂÆà„Çä„Éê„Ç∞‰øÆÊ≠£: „Çπ„Ç≠„É´„Å®„Ç¢„Ç§„ÉÜ„É†„ÅÆÂäπÊûú„ÇíÊ≠£„Åó„ÅèÂêàÁÆó
            let charmShield = getCharmEffect('shield');
            
            let effectText = [];

            const today = new Date();
            if (today.getDay() === 0 || today.getDay() === 6) {
                isWeekendBoost = true;
                effectText.push("ÈÄ±Êú´„Éú„Éº„Éä„Çπ („Çπ„Ç≥„Ç¢/G 1.5ÂÄç)");
            }
            
            if (gameData.activeItems.scoreBoost) { isScoreBoostActive = true; gameData.activeItems.scoreBoost = false; effectText.push("„Çπ„Ç≥„Ç¢x2"); }
            if (gameData.activeItems.moneyBoost) { isMoneyBoostActive = true; gameData.activeItems.moneyBoost = false; effectText.push("„ÅäÈáëx2"); }
            if (gameData.activeItems.comboShield) { isComboShieldActive = true; gameData.activeItems.comboShield = false; }
            
            let shieldCount = (isComboShieldActive ? 1 : 0) + charmShield + getSkillEffect('c02_shield');
            if (shieldCount > 0) {
                isComboShieldActive = true; // Áµ±Âêà
                effectText.push(`„Ç∑„Éº„É´„Éâ(${shieldCount})`);
            }
            
            if (gameData.activeItems.easyStart) { isEasyStartActive = true; gameData.activeItems.easyStart = false; effectText.push("„Ç§„Éº„Ç∏„Éº„Çπ„Çø„Éº„Éà"); }
            if (gameData.activeItems.slowTimer) { isSlowTimerActive = true; gameData.activeItems.slowTimer = false; effectText.push("„Çπ„É≠„Éº„Çø„Ç§„Éû„Éº"); }
            if (gameData.activeItems.feverBoost) { isFeverItemActive = true; gameData.activeItems.feverBoost = false; effectText.push("„Éï„Ç£„Éº„Éê„Éº+"); } 

            
            let baseTime = 30; let baseWords = 30; 

            if (gameData.activeItems.boostStart) { currentCombo = 10; comboDisplay.innerText = 10; gameData.activeItems.boostStart = false; effectText.push("„Ç≥„É≥„Éú10„Çπ„Çø„Éº„Éà"); }
            if (gameData.activeItems.timePlusTwo) { baseTime += 2; gameData.activeItems.timePlusTwo = false; effectText.push("ÊôÇÈñì+2Áßí"); }
            if (gameData.activeItems.timePlusFive) { baseTime += 5; gameData.activeItems.timePlusFive = false; effectText.push("ÊôÇÈñì+5Áßí"); }
            if (gameData.activeItems.wordSkip) { baseWords -= 1; gameData.activeItems.wordSkip = false; effectText.push("„Éé„É´„Éû-1"); }
            
            if (effectText.length > 0) { 
                document.getElementById('item-effect-display').innerText = `Ôºà${effectText.join(" | ")} Áô∫Âãï‰∏≠ÔºÅÔºâ`; 
                saveData();
            } else { 
                document.getElementById('item-effect-display').innerText = ""; 
            }
            
            const modeConfig = {
                'time': { value: baseTime, timerText: baseTime.toFixed(2), label: "TIME / LEFT", words: [] },
                'words': { value: baseWords, timerText: "0.00", label: "TIME", words: [] },
                'suddenDeath': { value: 9999, timerText: "0.00", label: "TIME", words: [] },
                'custom': { value: wordsToType.length, timerText: "0.00", label: "TIME", words: wordsToType },
                'timeAttack': { value: 20, timerText: "0.00", label: "TIME", words: [] },
                'accuracy': { value: 60, timerText: "60.00", label: "TIME / LEFT", words: [] },
                // 'lyrics': { value: wordPacks['pack_lyrics'].length, timerText: "0.00", label: "TIME", words: [...wordPacks['pack_lyrics']] }, // ‚òÖÊ≠åË©ûÂâäÈô§
                'english': { value: 9999, timerText: "0.00", label: "TIME", words: [] },
                'double': { value: 9999, timerText: "0.00", label: "TIME", words: [] },
                'fill': { value: 9999, timerText: "0.00", label: "TIME", words: [] },
                'fast': { value: 9999, timerText: "0.00", label: "TIME", words: [] }
            };
            
            const config = modeConfig[gameMode];
            gameValue = config.value;
            document.getElementById('timer').innerText = config.timerText;
            if (gameMode === 'time' || gameMode === 'accuracy') remainingTime = gameValue;
            timerLabel.innerText = config.label;
            wordsToType = config.words;
            
            if (gameMode !== 'custom') {
                loadGhostData(getModeKey());
            }

            document.body.classList.remove('combo-tier-1', 'combo-tier-2', 'combo-tier-3'); 
            mainContent.classList.remove('boost-active'); 
            keyboardContainer.classList.remove('perfect-mode'); 
            keyboardContainer.classList.remove('boost-rainbow');
            
            kanjiDisplay.innerHTML = "PopTyper";
            wordDisplayElement.innerHTML = '<span style="font-size: 0.8em; color: #777;">[Space] „Åß„Çπ„Çø„Éº„Éà</span>';
            wordDisplaySub.style.display = 'none';
            
            quoteInputElement.value = '';
            quoteInputElement.focus();

            playBGM();
        }

        // --- 8. „Çø„Ç§„ÉóÂá¶ÁêÜ„Å®„Ç®„Éï„Çß„ÇØ„Éà ---

        function playSound(soundName) {
            let soundToPlay;
            if (soundName === 'pop') {
                const setting = gameData.settings.currentSound;
                if (setting === 'sound-click') soundToPlay = popSound2;
                else if (setting === 'sound-synth') soundToPlay = popSound3;
                else soundToPlay = popSound;
            } else if (soundName === 'miss') {
                soundToPlay = missSound;
            } else if (soundName === 'boost') {
                soundToPlay = boostSound;
            } else if (soundName === 'shield') {
                soundToPlay = shieldSound;
            } else if (soundName === 'levelup') {
                soundToPlay = levelupSound;
            } else if (soundName === 'reward') {
                soundToPlay = rewardSound;
            } else if (soundName === 'gacha-normal') {
                soundToPlay = gachaNormalSound;
            } else if (soundName === 'gacha-rare') {
                soundToPlay = gachaRareSound;
            } else if (soundName === 'gacha-super-rare') {
                soundToPlay = gachaSuperRareSound;
            } else if (soundName === 'skill-unlock') {
                soundToPlay = skillUnlockSound;
            }


            if (soundToPlay) {
                soundToPlay.currentTime = 0;
                soundToPlay.play().catch(e => {
                    // console.log("Audio play interrupted");
                });
            }
        }

        function processTypedKey(typedKey) {
            if (!userInteracted) {
                userInteracted = true; 
                playBGM();
            }
            if (gameWaitingToStart) {
                startGameTimer();
                gameWaitingToStart = false;
                gameRunning = true;
            }
            if (!gameRunning) return;

            totalTypeCount++;
            totalTypedDisplay.innerText = totalTypeCount.toLocaleString(); 
            highlightKey(typedKey);
            createPopKey(typedKey);

            let prestigeBonus = (gameData.stats.prestigeType === 'standard') ? (1 + (gameData.stats.prestigeLevel * 0.05)) : 1.0;
            addXP(XP_PER_CHAR * prestigeBonus); 
        
            let newRomaInput = currentRomaInput + typedKey;
        
            // ‚òÖ„ÉÄ„Éñ„É´„É¢„Éº„Éâ: 2„Å§„ÅÆ„ÅäÈ°å„ÅÆ„Å©„Å°„Çâ„Åã„Å´„Éû„ÉÉ„ÉÅ„Åô„Çã„ÅãÂà§ÂÆö
            if (gameMode === 'double' && doubleWordData) {
                const yomi1 = hiraganaSpans.map(s => s.innerText).join('');
                const yomi2 = doubleWordData.yomi;

                if (typedKey === yomi1[0]) { // 1„Å§ÁõÆ„ÅÆ„ÅäÈ°å
                    // „Åù„ÅÆ„Åæ„ÅæÈÄ≤„ÇÄ
                } else if (typedKey === yomi2[0]) { // 2„Å§ÁõÆ„ÅÆ„ÅäÈ°å„Å´Âàá„ÇäÊõø„Åà
                    // ÁèæÂú®„ÅÆ„ÅäÈ°å„Çí„Çµ„Éñ„Å´
                    const mainWordData = { display: kanjiDisplay.innerHTML, yomi: yomi1 };
                    // „Çµ„Éñ„ÅÆ„ÅäÈ°å„Çí„É°„Ç§„É≥„Å´
                    wordsToType[currentWordIndex - 1] = doubleWordData;
                    doubleWordData = mainWordData;
                    
                    loadCurrentWord(); // „É°„Ç§„É≥„ÇíÂÜçË™≠„ÅøËæº„Åø
                    processTypedKey(typedKey); // „Ç≠„ÉºÂÖ•Âäõ„ÇíÂÜçÂá¶ÁêÜ
                    return;
                }
            }
        
            if (targetRomaOptions.includes(newRomaInput)) {
                handleCorrectType(); 
                correctCharsCount += newRomaInput.length;
                hiraganaSpans[targetHiraganaIndex].classList.add('correct');
                targetHiraganaIndex++;
                playSound('pop');
                
                if (targetHiraganaIndex >= hiraganaSpans.length) {
                    let prestigeBonus = (gameData.stats.prestigeType === 'standard') ? (1 + (gameData.stats.prestigeLevel * 0.05)) : 1.0;
                    addXP(XP_PER_WORD * prestigeBonus); 
                    
                    if (gameMode === 'fast') {
                        fastModeSpeed *= 1.05; // 5%„Åö„Å§Âä†ÈÄü
                    }

                    if (gameMode === 'words' || gameMode === 'custom' || gameMode === 'timeAttack') { // ‚òÖÊ≠åË©ûÂâäÈô§
                        currentWordIndex++; 
                    }
                    loadCurrentWord();
                } else { 
                    updateTargetRoma();
                }
                return; 
            }
            
            let isPartialMatch = targetRomaOptions.some(option => option.startsWith(newRomaInput));
            if (isPartialMatch) {
                currentRomaInput = newRomaInput;
                if(hiraganaSpans[targetHiraganaIndex]) { 
                    hiraganaSpans[targetHiraganaIndex].classList.remove('incorrect');
                }
            } else {
                handleMiss();
            }
        }

        function addXP(amount) {
            if (gameData.stats.level >= MAX_LEVEL && gameData.stats.prestigeLevel >= MAX_PRESTIGE_LEVEL) return; 
            if (gameData.stats.level >= MAX_LEVEL) return; // Ëª¢ÁîüÂæÖ„Å°

            gameData.stats.xp += amount;
            const currentLevel = gameData.stats.level;
            const newLevel = getLevelForXP(gameData.stats.xp);
            
            if (newLevel > currentLevel) {
                for (let lv = currentLevel + 1; lv <= newLevel; lv++) {
                    gameData.stats.level = Math.min(lv, MAX_LEVEL); // Lv100„Åß„Çπ„Éà„ÉÉ„Éó
                    playSound('levelup');
                    const bonus = lv * 100; 
                    gameData.stats.money += bonus;
                    
                    // „Çπ„Ç≠„É´„Éù„Ç§„É≥„Éà (5„É¨„Éô„É´„Åî„Å®)
                    if (lv % 5 === 0) {
                        gameData.stats.skillPoints++;
                        showQuickClaim(`„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÔºÅ Lv. ${gameData.stats.level}ÔºÅ\n+${bonus} G / +1 SP Áç≤ÂæóÔºÅ`);
                    } else {
                         showQuickClaim(`„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÔºÅ Lv. ${gameData.stats.level}ÔºÅ\n+${bonus} G Áç≤ÂæóÔºÅ`);
                    }
                    
                    // Ëª¢ÁîüË©¶Á∑¥ (Lv30)
                    if (gameData.prestigeTrial.active && gameData.stats.level >= 30) {
                        failPrestigeTrial("Lv. 30„Å´Âà∞ÈÅî„Åó„Å¶„Åó„Åæ„ÅÑ„Åæ„Åó„Åü");
                    }
                }
                
                if (gameData.stats.level >= MAX_LEVEL) {
                    prestigeBtn.style.display = 'flex';
                }
            }
            updateDataUI(); 
        }

        function handleCorrectType() {
            currentCombo++;
            if (currentCombo > maxComboThisGame) { maxComboThisGame = currentCombo; } 

            let scoreGained = 10 * boostLevel;
            
            let feverDuration = 10000 + (gameData.upgrades.feverTime * 1000);
            let feverMinCombo = 10 - getSkillEffect('f01_fever');

            if ((isFeverItemActive || gameData.upgrades.infiniteFever) && !isFeverTime && currentCombo >= feverMinCombo) {
                isFeverTime = true;
                feverEndTime = Date.now() + feverDuration; 
                document.body.classList.add('fever-active');
                feverTimerDisplay.style.display = 'block';
            }
            
            if (isFeverTime) {
                scoreGained *= (3 + getSkillEffect('f02_fever_rate') * 0.5);
            }
            
            // „Éö„ÉÉ„ÉàÂøúÊè¥„Çπ„Ç≠„É´
            if (petState === 'happy' && getSkillEffect('p01_pet') > 0) {
                scoreGained *= 1.1; // 10% UP
            }

            if (isScoreBoostActive) { scoreGained *= 2; }
            currentScore += Math.round(scoreGained);
            scoreDisplay.innerText = currentScore.toLocaleString();
            updateBoostState();
            setPetState('happy'); 

            // „Ç¥„Éº„Çπ„Éà
            if (gameMode !== 'custom' && gameMode !== 'timeAttack') {
                ghostData.push({ time: (new Date() - gameStartTime), score: currentScore, types: totalTypeCount });
            }
        }

        function handleMiss() {
            // ‚òÖ„ÅäÂÆà„Çä„Éê„Ç∞‰øÆÊ≠£: „Çπ„Ç≠„É´„Å®„Ç¢„Ç§„ÉÜ„É†„ÅÆÂäπÊûú„ÇíÊ≠£„Åó„ÅèÂêàÁÆó
            let charmShield = getCharmEffect('shield');
            let shieldCount = (isComboShieldActive ? 1 : 0) + charmShield + getSkillEffect('c02_shield');

            if (errors < shieldCount) {
                errors++; // „Ç∑„Éº„É´„ÉâÊ∂àË≤ª
                document.getElementById('item-effect-display').innerText = `„Ç∑„Éº„É´„ÉâÁô∫ÂãïÔºÅ (ÊÆã„Çä ${shieldCount - errors}Âõû)`;
                playSound('shield');
                currentRomaInput = "";
                if(hiraganaSpans[targetHiraganaIndex]) { 
                    hiraganaSpans[targetHiraganaIndex].classList.add('incorrect');
                    setTimeout(() => {
                        if(hiraganaSpans[targetHiraganaIndex]) {
                            hiraganaSpans[targetHiraganaIndex].classList.remove('incorrect');
                        }
                    }, 100);
                }
                updateTargetRoma();
                return;
            }
            
            errors++;
            // Ëã¶ÊâãÂçòË™û„Ç´„Ç¶„É≥„Éà
            if(gameMode !== 'custom' && hiraganaSpans.length > 0) {
                const yomi = hiraganaSpans.map(s => s.innerText).join('');
                if(gameData.weakWords[yomi]) {
                    gameData.weakWords[yomi].miss++;
                }
            }
            
            currentCombo = 0; 
            updateBoostState(); 
            setPetState('sad'); 
                
            if (gameMode === 'suddenDeath') {
                playSound('miss');
                endGame();
                return;
            }

            if (isFeverTime && !gameData.upgrades.infiniteFever) {
                isFeverTime = false;
                document.body.classList.remove('fever-active');
                feverTimerDisplay.style.display = 'none';
            }

            currentRomaInput = "";
            if(hiraganaSpans[targetHiraganaIndex]) { hiraganaSpans[targetHiraganaIndex].classList.add('incorrect'); }
            updateTargetRoma();
            playSound('miss');
        }

        function updateBoostState() {
            const oldBoostLevel = boostLevel;
            comboDisplay.innerText = currentCombo;
            
            if (currentCombo >= 30) { boostLevel = 3; } 
            else if (currentCombo >= 10) { boostLevel = 2; } 
            else { boostLevel = 1; }

            if (boostLevel >= 2) {
                mainContent.classList.add('boost-active');
                keyboardContainer.classList.add('boost-rainbow');
            } else {
                mainContent.classList.remove('boost-active');
                keyboardContainer.classList.remove('boost-rainbow');
            }

            if (boostLevel > oldBoostLevel && oldBoostLevel === 1) {
                playSound('boost');
            }

            document.body.classList.toggle('combo-tier-1', currentCombo >= 10);
            document.body.classList.toggle('combo-tier-2', currentCombo >= 30);
            document.body.classList.toggle('combo-tier-3', currentCombo >= 50);
            
            const errorRate = totalTypeCount > 20 ? errors / totalTypeCount : 0; 
            const perfectMode = errorRate < 0.15 && currentCombo > 5; 
            keyboardContainer.classList.toggle('perfect-mode', perfectMode);

            scoreDisplay.style.transform = `scale(${1 + (boostLevel - 1) * 0.1})`;
        }

        function createPopKey(key) {
            const popEl = document.createElement('div');
            popEl.className = 'pop-key';
            popEl.innerText = key.toUpperCase();
            
            const effect = gameData.settings.currentEffect;
            if (effect === 'effect-rainbow') {
                popEl.classList.add('rainbow');
            } else if (effect === 'effect-firework') {
                popEl.classList.add('firework');
            } else if (effect === 'effect-bubble') {
                popEl.classList.add('bubble');
            } else if (effect === 'effect-lines') {
                popEl.classList.add('lines');
            } else if (effect === 'effect-gold') {
                popEl.classList.add('firework'); 
                popEl.style.color = 'gold';
                popEl.style.textShadow = '0 0 5px gold, 0 0 10px gold';
            } else if (effect === 'default') {
                popEl.style.color = 'white'; 
            }
            
            // ‚òÖ„ÅäÂÆà„Çä„Éê„Ç∞‰øÆÊ≠£
            if (getCharmEffect('pop') > 0) {
                popEl.style.transform = 'scale(1.2)';
                popEl.style.textShadow = '0 0 10px #fff';
            }

            document.body.appendChild(popEl);
            let x, y;
            const currentSpan = hiraganaSpans[targetHiraganaIndex];
            if (popMode === 'fixed' && currentSpan) { 
                const rect = currentSpan.getBoundingClientRect();
                x = rect.left + rect.width / 2; y = rect.top;
            } else {
                const typingAreaRect = document.getElementById('typing-area').getBoundingClientRect();
                x = typingAreaRect.left + typingAreaRect.width / 2 + (Math.random() - 0.5) * 100;
                y = typingAreaRect.top + typingAreaRect.height / 2 + (Math.random() - 0.5) * 100;
            }
            popEl.style.left = `${x}px`; popEl.style.top = `${y}px`;
            
            if (effect !== 'effect-firework' && effect !== 'effect-bubble' && effect !== 'effect-lines' && effect !== 'effect-gold') {
                popEl.style.setProperty('--pop-x', `${(Math.random() - 0.5) * 400}px`);
                popEl.style.setProperty('--pop-y', `${-150 - Math.random() * 150}px`);
            }
            
            setTimeout(() => { popEl.remove(); }, 1200); 
        }

        function highlightKey(key) {
            const keyEl = keyboardContainer.querySelector(`.key[data-key="${key.toLowerCase()}"]`);
            if (keyEl) {
                keyEl.classList.add('highlight');
                setTimeout(() => { keyEl.classList.remove('highlight'); }, 100);
            }
        }// --- 9. „É¢„Éº„ÉÄ„É´ („Ç∑„Éß„ÉÉ„Éó/Áß∞Âè∑/Ë®≠ÂÆö/„Éü„ÉÉ„Ç∑„Éß„É≥/ÂÆüÁ∏æ) „ÅÆÂà∂Âæ° ---
        
        function renderShop() {
            const shopGridContainer = document.getElementById('shop-grid');
            shopGridContainer.innerHTML = '';
            
            const currentLevel = gameData.stats.level;
            const itemUnlockLevels = {
                'upgrade_infiniteFever': 30,
                'pack_difficult': 20, // ‚òÖÁ•û„ÄÖ„Éë„ÉÉ„ÇØ
            };

            Object.keys(masterItemList).forEach(itemId => {
                const item = masterItemList[itemId];
                if (item.gacha || item.event) return; // „Ç¨„ÉÅ„É£ÈôêÂÆöÂìÅ„Å®„Ç§„Éô„É≥„ÉàÂìÅ„ÅØ„Ç∑„Éß„ÉÉ„Éó„Å´Ë°®Á§∫„Åó„Å™„ÅÑ

                const itemEl = document.createElement('div');
                itemEl.className = 'shop-item';
                let buttonHtml;
                
                const requiredLevel = itemUnlockLevels[itemId];
                if (requiredLevel && currentLevel < requiredLevel) {
                    buttonHtml = `<button class="item-buy-btn" disabled>Lv. ${requiredLevel} „ÅßËß£Êîæ</button>`;
                } else {
                    const itemTypes = ['background', 'font', 'sound', 'pack', 'effect', 'theme', 'pet', 'pet-item', 'pet-house', 'bgm', 'kb-skin', 'icon', 'charm'];
                    let unlockedList;
                    if (item.type === 'font') unlockedList = gameData.unlockedFonts;
                    else if (item.type === 'sound') unlockedList = gameData.unlockedSounds;
                    else if (item.type === 'pack') unlockedList = gameData.unlockedPacks;
                    else if (item.type === 'effect') unlockedList = gameData.unlockedEffects;
                    else if (item.type === 'theme') unlockedList = gameData.unlockedThemes;
                    else if (item.type === 'pet') unlockedList = gameData.unlockedPets;
                    else if (item.type === 'pet-item') unlockedList = gameData.unlockedPetItems;
                    else if (item.type === 'pet-house') unlockedList = gameData.unlockedPetHouses;
                    else if (item.type === 'bgm') unlockedList = gameData.unlockedBgms;
                    else if (item.type === 'kb-skin') unlockedList = gameData.unlockedKeyboardSkins;
                    else if (item.type === 'icon') unlockedList = gameData.unlockedIcons;
                    else if (item.type === 'charm') unlockedList = gameData.unlockedCharms;
                    else if (item.type === 'background') unlockedList = gameData.unlockedBackgrounds;

                    if (unlockedList) {
                        if (unlockedList.includes(itemId)) {
                            buttonHtml = `<button class="item-buy-btn active" disabled>Ë≥ºÂÖ•Ê∏à„Åø</button>`;
                        } else if (gameData.stats.money >= item.price) {
                            buttonHtml = `<button class="item-buy-btn" onclick="buyItem('${itemId}')">Ë≥ºÂÖ• (${item.price.toLocaleString()}G)</button>`;
                        } else {
                            buttonHtml = `<button class="item-buy-btn" disabled>Ë≥áÈáë‰∏çË∂≥ (${item.price.toLocaleString()}G)</button>`;
                        }
                    } else if (item.type === 'upgrade') {
                        const level = gameData.upgrades[item.key] || 0;
                        if (level > 0) {
                             buttonHtml = `<button class="item-buy-btn active" disabled>Ë≥ºÂÖ•Ê∏à„Åø</button>`;
                        } else if (gameData.stats.money >= item.price) {
                            buttonHtml = `<button class="item-buy-btn" onclick="buyItem('${itemId}')">Ë≥ºÂÖ• (${item.price.toLocaleString()}G)</button>`;
                        } else {
                            buttonHtml = `<button class="item-buy-btn" disabled>Ë≥áÈáë‰∏çË∂≥ (${item.price.toLocaleString()}G)</button>`;
                        }
                    }
                    else if (gameData.activeItems[itemId]) {
                        buttonHtml = `<button class="item-buy-btn active" disabled>‰ΩøÁî®ÂæÖ„Å°</button>`;
                    } else if (gameData.stats.money >= item.price) {
                        buttonHtml = `<button class="item-buy-btn" onclick="buyItem('${itemId}')">Ë≥ºÂÖ• (${item.price.toLocaleString()}G)</button>`;
                    } else {
                        buttonHtml = `<button class="item-buy-btn" disabled>Ë≥áÈáë‰∏çË∂≥ (${item.price.toLocaleString()}G)</button>`;
                    }
                }
                itemEl.innerHTML = `<h3>${item.name}</h3> <p>${item.description}</p> <div class="item-price">${item.price.toLocaleString()} G</div> ${buttonHtml}`;
                shopGridContainer.appendChild(itemEl);
            });
            
            gachaPullBtn.disabled = gameData.stats.money < (GACHA_COST * (1 - (getSkillEffect('g02_gacha_cost') * 0.05)));
            let gachaBonus = (gameData.stats.prestigeType === 'wealth') ? gameData.stats.prestigeLevel * 2.5 : 0;
            gachaBonus += getSkillEffect('g01_gacha') * 0.2;
            gachaBonusText.style.display = (gachaBonus > 0) ? 'inline' : 'none';
            if (gachaBonus > 0) {
                gachaBonusText.innerText = ` („É¨„Ç¢Áéá +${gachaBonus.toFixed(1)}%UP‰∏≠!)`;
            }
        }
        window.buyItem = function(itemId) {
            const item = masterItemList[itemId];
            if (!item) return;

            const itemLists = {
                'background': gameData.unlockedBackgrounds,
                'font': gameData.unlockedFonts,
                'sound': gameData.unlockedSounds,
                'pack': gameData.unlockedPacks,
                'effect': gameData.unlockedEffects,
                'theme': gameData.unlockedThemes,
                'pet': gameData.unlockedPets,
                'pet-item': gameData.unlockedPetItems,
                'pet-house': gameData.unlockedPetHouses,
                'bgm': gameData.unlockedBgms,
                'kb-skin': gameData.unlockedKeyboardSkins,
                'icon': gameData.unlockedIcons,
                'charm': gameData.unlockedCharms
            };
            if (itemLists[item.type] && itemLists[item.type].includes(itemId)) {
                return alert("„Åì„ÅÆ„Ç¢„Ç§„ÉÜ„É†„ÅØË≥ºÂÖ•Ê∏à„Åø„Åß„Åô„ÄÇ");
            }
            if (item.type === 'upgrade' && (gameData.upgrades[item.key] || 0) > 0) return alert("„Åì„ÅÆ„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ„ÅØË≥ºÂÖ•Ê∏à„Åø„Åß„Åô„ÄÇ");
            if (item.type === 'boost' && gameData.activeItems[itemId]) return alert("„Åì„ÅÆ„Ç¢„Ç§„ÉÜ„É†„ÅØÊó¢„Å´‰ΩøÁî®ÂæÖ„Å°„Åß„Åô„ÄÇ");

            if (gameData.stats.money >= item.price) {
                gameData.stats.money -= item.price;
                if (item.type === 'utility') {
                    if (itemId === 'bonusMoney') {
                        gameData.stats.money += 50;
                        alert(`${item.name} „ÇíË≥ºÂÖ•„Åó„Åæ„Åó„ÅüÔºÅ ÊâÄÊåÅÈáë„Åå50ÂÜÜÂ¢ó„Åà„Åæ„Åô„ÄÇ`);
                    }
                } else if (itemLists[item.type]) {
                    itemLists[item.type].push(itemId);
                    alert(`${item.name} „ÇíË≥ºÂÖ•„Åó„Åæ„Åó„ÅüÔºÅ\nË©≥Á¥∞Ë®≠ÂÆö„Åã„ÇâÂ§âÊõ¥„Åß„Åç„Åæ„Åô„ÄÇ`);
                } else if (item.type === 'upgrade') {
                    gameData.upgrades[item.key] = (gameData.upgrades[item.key] || 0) + 1;
                    alert(`${item.name} „ÇíË≥ºÂÖ•„Åó„Åæ„Åó„ÅüÔºÅ`);
                } else { // boost
                    gameData.activeItems[itemId] = true;
                    alert(`${item.name} „ÇíË≥ºÂÖ•„Åó„Åæ„Åó„ÅüÔºÅ\nÊ¨°„ÅÆ„Ç≤„Éº„É†„ÅßËá™ÂãïÁöÑ„Å´‰ΩøÁî®„Åï„Çå„Åæ„Åô„ÄÇ`);
                }
                saveData();
                renderShop(); 
                updateDataUI();
            } else {
                alert("„ÅäÈáë„ÅåË∂≥„Çä„Åæ„Åõ„Çì„ÄÇ");
            }
        }
        
        function renderTitleList() {
            const titleListContainer = document.getElementById('title-list-container');
            titleListContainer.innerHTML = '';
            masterTitleList.forEach((title, index) => {
                const titleEl = document.createElement('div');
                titleEl.className = 'title-item'; 
                const isUnlocked = gameData.unlockedTitles[index];
                const statusClass = isUnlocked ? 'item-status unlocked' : 'item-status locked';
                const statusText = isUnlocked ? '‚úÖ Ëß£ÊîæÊ∏à„Åø' : 'üîí Êú™Ëß£Êîæ';
                titleEl.innerHTML = `<span class="item-name">${title.name}</span> <span class="item-description">ÂøÖË¶Å„Çπ„Ç≥„Ç¢: ${title.score.toLocaleString()}</span> <span class="${statusClass}">${statusText}</span>`;
                titleListContainer.appendChild(titleEl);
            });
            
            // Áß∞Âè∑„Ç´„É©„Éº
            titleColorSelectorContainer.innerHTML = '';
            gameData.unlockedTitleColors.forEach(color => {
                const btn = document.createElement('button');
                btn.className = 'title-color-btn';
                btn.style.backgroundColor = color;
                if (gameData.settings.currentTitleColor === color) {
                    btn.classList.add('active');
                }
                btn.addEventListener('click', () => {
                    gameData.settings.currentTitleColor = color;
                    saveData();
                    renderTitleList();
                    renderProfile();
                });
                titleColorSelectorContainer.appendChild(btn);
            });
        }

        function renderMissionList() {
            const container = document.getElementById('mission-list-container');
            container.innerHTML = '';
            Object.keys(masterMissionList).forEach(key => {
                const mission = masterMissionList[key];
                const missionData = gameData.missions.daily;
                const progress = missionData[mission.key] || 0;
                const isCompleted = gameData.missions.dailyRewards[key]; 
                
                let statusText = `(${progress.toLocaleString()} / ${mission.goal.toLocaleString()})`;
                let statusClass = "item-status locked";
                let rewardText = `+${mission.reward} G`;

                if (isCompleted) {
                    statusText = '‚úÖ ÈÅîÊàêÊ∏à„Åø';
                    statusClass = "item-status unlocked";
                    rewardText = ""; 
                } else if (progress >= mission.goal) {
                    statusText = 'üåü ÈÅîÊàêÔºÅ';
                    statusClass = "item-status unlocked";
                }

                const el = document.createElement('div');
                el.className = 'mission-item';
                el.innerHTML = `
                    <span class="item-name">${mission.name}</span>
                    <span class="${statusClass}">${statusText}</span>
                    <span class="item-reward">${rewardText}</span>
                    <span class="item-description">${mission.description}</span>
                `;
                container.appendChild(el);
            });
            
            // „Ç¶„Ç£„Éº„ÇØ„É™„Éº
            renderWeeklyMissions();
        }
        
        function renderWeeklyMissions() {
            weeklyMissionList.innerHTML = '';
            const now = new Date();
            const weekId = gameData.missions.lastWeekId;
            const weekStartDate = new Date(weekId);
            const weekEndDate = new Date(weekStartDate.getTime() + 7 * 24 * 60 * 60 * 1000 - 1);
            const timeLeft = weekEndDate.getTime() - now.getTime();
            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            weeklyTimer.innerText = `ÊÆã„Çä ${days}Êó• ${hours}ÊôÇÈñì`;
            
            gameData.missions.currentWeeklyIds.forEach(id => {
                const mission = masterWeeklyMissions.find(m => m.id === id);
                if (!mission) return;
                
                const progress = gameData.missions.weekly[id] || 0;
                const isCompleted = gameData.missions.weeklyRewards[id];
                
                let statusText = `(${progress.toLocaleString()} / ${mission.goal.toLocaleString()})`;
                let statusClass = "item-status locked";
                let rewardText = `+${mission.reward} G`;

                if (isCompleted) {
                    statusText = '‚úÖ ÈÅîÊàêÊ∏à„Åø';
                    statusClass = "item-status unlocked";
                    rewardText = ""; 
                } else if (progress >= mission.goal) {
                    statusText = 'üåü ÈÅîÊàêÔºÅ';
                    statusClass = "item-status unlocked";
                }

                const el = document.createElement('div');
                el.className = 'mission-item';
                el.innerHTML = `
                    <span class="item-name">${mission.name}</span>
                    <span class="${statusClass}">${statusText}</span>
                    <span class="item-reward">${rewardText}</span>
                    <span class="item-description">${mission.description}</span>
                `;
                weeklyMissionList.appendChild(el);
            });
        }

        function renderAchievementList() {
            const container = document.getElementById('achievement-list-container');
            container.innerHTML = '';
            renderApRewards(); // ‚òÖAPÂ†±ÈÖ¨
            
            Object.keys(masterAchievementList).forEach(key => {
                const ach = masterAchievementList[key];
                const isUnlocked = gameData.achievements[key];
                
                const statusClass = isUnlocked ? 'item-status unlocked' : 'item-status locked';
                const statusText = isUnlocked ? '‚úÖ ÈÅîÊàêÊ∏à„Åø' : 'üîí Êú™ÈÅîÊàê';
                const rewardText = isUnlocked ? `+${ach.reward} G` : '';
                const apText = `+${ach.ap} AP`;

                const el = document.createElement('div');
                el.className = 'achievement-item';
                el.innerHTML = `
                    <span class="item-name">${ach.name}</span>
                    <span class="item-ap">${apText}</span>
                    <span class="${statusClass}">${statusText}</span>
                    <span class="item-reward">${rewardText}</span>
                    <span class="item-description">${ach.description}</span>
                `;
                container.appendChild(el);
            });
        }
        
        function renderApRewards() {
            totalApDisplay.innerText = gameData.stats.ap.toLocaleString();
            apRewardsList.innerHTML = '';
            
            apRewardList.forEach((reward, index) => {
                const el = document.createElement('div');
                el.className = 'ap-reward-item';
                let rewardName = "";
                if (reward.type === 'money') {
                    rewardName = `${reward.value.toLocaleString()} G`;
                } else {
                    rewardName = masterItemList[reward.value].name;
                }
                
                el.innerHTML = `
                    <div class="ap-reward-ap">${reward.ap} AP</div>
                    <div class="ap-reward-name">${rewardName}</div>
                `;
                
                if (gameData.claimedApRewards.includes(index)) {
                    el.classList.add('claimed');
                    el.innerHTML += "<span>(ÂèóÂèñÊ∏à)</span>";
                } else if (gameData.stats.ap >= reward.ap) {
                    el.style.cursor = 'pointer';
                    el.style.borderColor = 'var(--color-correct)';
                    el.addEventListener('click', () => claimApReward(index, reward));
                }
                
                apRewardsList.appendChild(el);
            });
        }
        
        function claimApReward(index, reward) {
            if (gameData.claimedApRewards.includes(index)) return;
            if (gameData.stats.ap < reward.ap) return;
            
            gameData.claimedApRewards.push(index);
            let rewardMsg = "";

            if (reward.type === 'money') {
                gameData.stats.money += reward.value;
                rewardMsg = `${reward.value.toLocaleString()} G „ÇíÁç≤Âæó„Åó„Åæ„Åó„ÅüÔºÅ`;
            } else if (reward.type === 'item') {
                gameData.activeItems[reward.value] = true;
                rewardMsg = `${masterItemList[reward.value].name} „ÇíÁç≤Âæó„Åó„Åæ„Åó„ÅüÔºÅ`;
            } else if (reward.type === 'pet-item') {
                if (!gameData.unlockedPetItems.includes(reward.value)) gameData.unlockedPetItems.push(reward.value);
                rewardMsg = `${masterItemList[reward.value].name} „ÇíÁç≤Âæó„Åó„Åæ„Åó„ÅüÔºÅ`;
            } else if (reward.type === 'pet') {
                if (!gameData.unlockedPets.includes(reward.value)) gameData.unlockedPets.push(reward.value);
                rewardMsg = `${masterItemList[reward.value].name} „ÇíÁç≤Âæó„Åó„Åæ„Åó„ÅüÔºÅ`;
            } else if (reward.type === 'charm') {
                if (!gameData.unlockedCharms.includes(reward.value)) gameData.unlockedCharms.push(reward.value);
                rewardMsg = `${masterItemList[reward.value].name} „ÇíÁç≤Âæó„Åó„Åæ„Åó„ÅüÔºÅ`;
            } else if (reward.type === 'icon') {
                if (!gameData.unlockedIcons.includes(reward.value)) gameData.unlockedIcons.push(reward.value);
                rewardMsg = `${masterItemList[reward.value].name} „ÇíÁç≤Âæó„Åó„Åæ„Åó„ÅüÔºÅ`;
            }
            
            playSound('reward');
            alert(`APÂ†±ÈÖ¨„ÇíÁç≤ÂæóÔºÅ\n${rewardMsg}`);
            saveData();
            updateDataUI();
            renderApRewards();
        }

        function checkMissions(gameResult) {
            const dailyMissions = gameData.missions.daily;
            const dailyRewards = gameData.missions.dailyRewards;

            Object.keys(masterMissionList).forEach(key => {
                const mission = masterMissionList[key];
                if (!dailyRewards[key] && dailyMissions[mission.key] >= mission.goal) {
                    dailyRewards[key] = true; 
                    gameData.stats.money += mission.reward;
                    // ‚òÖÂç≥ÊôÇÂèó„ÅëÂèñ„Çä
                    showQuickClaim(`„Éá„Ç§„É™„Éº„Éü„ÉÉ„Ç∑„Éß„É≥ÈÅîÊàêÔºÅ\n„Äå${mission.name}„Äç\n+${mission.reward} G`);
                }
            });
        }
        
        function checkWeeklyMissions(gameResult) {
            gameData.missions.currentWeeklyIds.forEach(id => {
                if (gameData.missions.weeklyRewards[id]) return; // Êó¢„Å´ÈÅîÊàêÊ∏à„Åø
                
                const mission = masterWeeklyMissions.find(m => m.id === id);
                if (!mission) return;
                
                const progressToAdd = mission.check(gameResult, { 
                    gameMode: gameResult.gameMode, 
                    score: gameResult.score,
                    pack: gameResult.pack,
                    maxCombo: gameResult.maxCombo
                });
                
                const newProgress = (gameData.missions.weekly[id] || 0) + progressToAdd;
                gameData.missions.weekly[id] = newProgress;

                if (newProgress >= mission.goal) {
                    gameData.missions.weeklyRewards[id] = true;
                    gameData.stats.money += mission.reward;
                    showQuickClaim(`„Ç¶„Ç£„Éº„ÇØ„É™„Éº„Éü„ÉÉ„Ç∑„Éß„É≥ÈÅîÊàêÔºÅ\n„Äå${mission.name}„Äç\n+${mission.reward} G`);
                }
            });
        }
        
        function showQuickClaim(message) {
            quickClaimQueue.push(message);
            if (quickClaimQueue.length === 1) { // ÊúÄÂàù„ÅÆÈÄöÁü•„Å™„ÇâË°®Á§∫
                displayNextQuickClaim();
            }
        }
        
        function displayNextQuickClaim() {
            if (quickClaimQueue.length === 0) {
                quickClaimContainer.style.display = 'none';
                return;
            }
            const message = quickClaimQueue[0];
            quickClaimText.innerText = message;
            quickClaimContainer.style.display = 'flex';
            playSound('reward'); // ‚òÖÈÄöÁü•Èü≥
        }
        
        quickClaimBtn.addEventListener('click', () => {
            quickClaimQueue.shift(); // ÊúÄÂàù„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„Çí„Ç≠„É•„Éº„Åã„ÇâÂâäÈô§
            displayNextQuickClaim(); // Ê¨°„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
        });

        function checkAchievements(gameResult) {
            Object.keys(masterAchievementList).forEach(key => {
                if (!gameData.achievements[key]) {
                    const ach = masterAchievementList[key];
                    if (ach.check(gameData, gameResult)) {
                        gameData.achievements[key] = true; 
                        gameData.stats.money += ach.reward;
                        gameData.stats.ap += ach.ap; // ‚òÖAPÂä†ÁÆó
                        showQuickClaim(`ÂÆüÁ∏æËß£Èô§ÔºÅ\n„Äå${ach.name}„Äç\n+${ach.reward} G / +${ach.ap} AP`);
                    }
                }
            });
        }

        function renderStats() {
            const stats = gameData.stats;
            const totalSec = Math.floor(stats.totalPlayTime / 1000);
            const hours = Math.floor(totalSec / 3600);
            const minutes = Math.floor((totalSec % 3600) / 60);
            const seconds = totalSec % 60;
            const playTimeStr = `${hours}ÊôÇÈñì ${minutes}ÂàÜ ${seconds}Áßí`;

            const avgWPM = stats.totalPlayTime > 0 ? (stats.correctTypes / 5) / (stats.totalPlayTime / 60000) : 0;
            const avgAcc = stats.totalTypes > 0 ? (stats.correctTypes / stats.totalTypes * 100) : 100;
            const prestigeStar = getPrestigeStar(stats.prestigeLevel);
            const prestigeType = stats.prestigeType === 'wealth' ? 'ÂØåË±™' : (stats.prestigeType === 'standard' ? 'Ê®ôÊ∫ñ' : '„Å™„Åó');

            statsContainer.innerHTML = `
                <div class="stat-block">
                    <div class="stat-value">${stats.level} ${prestigeStar}</div>
                    <div class="stat-label">ÁèæÂú®„É¨„Éô„É´ (Ëª¢Áîü„Çø„Ç§„Éó: ${prestigeType})</div>
                </div>
                <div class="stat-block">
                    <div class="stat-value">${stats.ap.toLocaleString()}</div>
                    <div class="stat-label">Á¥ØË®àÂÆüÁ∏æ„Éù„Ç§„É≥„Éà (AP)</div>
                </div>
                <div class="stat-block">
                    <div class="stat-value">${playTimeStr}</div>
                    <div class="stat-label">Á∑è„Éó„É¨„Ç§ÊôÇÈñì</div>
                </div>
                <div class="stat-block">
                    <div class="stat-value">${stats.totalGamesPlayed.toLocaleString()} <span style="font-size: 0.5em;">Âõû</span></div>
                    <div class="stat-label">Á∑è„Éó„É¨„Ç§ÂõûÊï∞</div>
                </div>
                <div class="stat-block">
                    <div class="stat-value">${stats.totalTypes.toLocaleString()}</div>
                    <div class="stat-label">Á¥ØË®à„Çø„Ç§„ÉóÂõûÊï∞</div>
                </div>
                <div class="stat-block">
                    <div class="stat-value">${stats.maxCombo.toLocaleString()}</div>
                    <div class="stat-label">ÊúÄÂ§ß„Ç≥„É≥„Éú</div>
                </div>
                <div class="stat-block">
                    <div class="stat-value">${avgWPM.toFixed(2)}</div>
                    <div class="stat-label">Âπ≥Âùá WPM</div>
                </div>
                <div class="stat-block">
                    <div class="stat-value">${avgAcc.toFixed(2)}<span style="font-size: 0.5em;">%</span></div>
                    <div class="stat-label">Âπ≥Âùá Ê≠£Ëß£Áéá</div>
                </div>
            `;
            
            // Áµ±Ë®à„Ç∞„É©„Éï
            renderStatsGraph();
        }
        
        function updateStatsHistory(score, wpm) {
            const today = getTodayString();
            let todayHistory = gameData.stats.history.find(h => h.date === today);
            if (todayHistory) {
                todayHistory.score = Math.max(todayHistory.score, score);
                todayHistory.wpm = Math.max(todayHistory.wpm, wpm);
                todayHistory.games++;
            } else {
                gameData.stats.history.push({ date: today, score: score, wpm: wpm, games: 1 });
            }
            // 30Êó•ÂàÜ„Å†„Åë‰øùÊåÅ
            if (gameData.stats.history.length > 30) {
                gameData.stats.history.shift();
            }
        }
        
        function renderStatsGraph() {
            const history = gameData.stats.history;
            const labels = history.map(h => h.date.substring(5)); // M-D
            const wpmData = history.map(h => h.wpm);
            const scoreData = history.map(h => h.score);
            
            if (statsChart) {
                statsChart.destroy();
            }
            statsChart = new Chart(statsGraphCanvas, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Max WPM',
                            data: wpmData,
                            borderColor: 'rgba(52, 152, 219, 1)',
                            backgroundColor: 'rgba(52, 152, 219, 0.2)',
                            yAxisID: 'yWPM',
                            tension: 0.1
                        },
                        {
                            label: 'Max Score',
                            data: scoreData,
                            borderColor: 'rgba(46, 204, 113, 1)',
                            backgroundColor: 'rgba(46, 204, 113, 0.2)',
                            yAxisID: 'yScore',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        yWPM: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'WPM' },
                            ticks: { color: '#ecf0f1' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        yScore: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Score' },
                            ticks: { color: '#ecf0f1' },
                            grid: { drawOnChartArea: false } //ÁâáÊñπ„Å†„Åë
                        },
                        x: {
                            ticks: { color: '#ecf0f1' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#ecf0f1' } }
                    }
                }
            });
        }
        
        function applyBackground() {
            document.body.classList.remove('bg-ocean', 'bg-galaxy', 'bg-forest', 'bg-sunset', 'bg-cyber', 'bg-legend', 'bg-aurora', 'bg-sakura'); 
            
            // „Ç§„Éô„É≥„ÉàËÉåÊôØ
            if (gameData.activeEvent === 'e_sakura') {
                document.body.classList.add('bg-sakura');
                return; // „Ç§„Éô„É≥„ÉàÂÑ™ÂÖà
            }
            
            if (gameData.settings.currentBackground && gameData.settings.currentBackground !== 'bg-default') {
                const bgId = gameData.settings.currentBackground;
                const className = bgId.replace('bg_', 'bg-'); 
                document.body.classList.add(className);

                if (bgId === 'bg_legend' && gameData.settings.legendRainbowEffect) {
                    document.body.classList.add('effect-active');
                }
            }
        }

        function applyFuriganaSetting() {
            const btn = document.getElementById('furigana-toggle-btn');
            if (gameData.settings.showFurigana) {
                document.body.classList.add('show-furigana');
                btn.innerHTML = '<i class="fas fa-eye"></i> „Åµ„Çä„Åå„Å™: ON';
            } else {
                document.body.classList.remove('show-furigana');
                btn.innerHTML = '<i class="fas fa-eye-slash"></i> „Åµ„Çä„Åå„Å™: OFF';
            }
        }

        function applyBGMSetting(userClicked = false) {
            if (userClicked) {
                userInteracted = true; 
            }
            const btn = document.getElementById('bgm-toggle-btn');
            if (gameData.settings.bgmOn) {
                btn.innerHTML = '<i class="fas fa-music"></i> BGM: ON';
                // currentBgm.muted = false; // playBGMÂÜÖ„ÅßÂá¶ÁêÜ
                if (userClicked || (userInteracted && currentBgm.paused)) { 
                    playBGM();
                }
            } else {
                btn.innerHTML = '<i class="fas fa-volume-mute"></i> BGM: OFF';
                allBgms.forEach(bgm => bgm.el.muted = true); 
            }
        }
        
        function playBGM() {
            if (!userInteracted) return;
            // ‰ªñ„ÅÆBGM„Çí„Åô„Åπ„Å¶ÂÅúÊ≠¢
            allBgms.forEach(bgm => bgm.el.pause());
            
            // ÁèæÂú®„ÅÆBGM„ÇíÁâπÂÆö
            const currentBgmObj = allBgms.find(bgm => bgm.id === gameData.settings.currentBgm);
            currentBgm = currentBgmObj ? currentBgmObj.el : bgmAudio;
            
            if (gameData.settings.bgmOn) {
                currentBgm.muted = false;
                if (currentBgm.paused) {
                    currentBgm.play().catch(e => { /* console.log("BGM play interrupted"); */ });
                }
            }
        }

        function stopBGM() {
             allBgms.forEach(bgm => bgm.el.pause()); 
        }

        function applyFont() {
            document.body.classList.remove('font-serif', 'font-rounded', 'font-pixel');
            if (gameData.settings.currentTheme === 'default' && gameData.settings.currentFont !== 'font-default') {
                document.body.classList.add(gameData.settings.currentFont);
            }
        }
        function renderFontSelector() {
            const container = document.getElementById('font-selector-container');
            container.innerHTML = '';
            const allFonts = [
                { id: 'font-default', name: '„Éá„Éï„Ç©„É´„Éà' },
                { id: 'font_serif', name: 'ÊòéÊúù‰Ωì' },
                { id: 'font_rounded', name: '‰∏∏„Ç¥„Ç∑„ÉÉ„ÇØ' },
                { id: 'font_pixel', name: '„Éî„ÇØ„Çª„É´ („ÉÜ„Éº„Éû)' }
            ];

            allFonts.forEach(font => {
                const btn = document.createElement('button');
                btn.className = 'font-select-btn';
                btn.innerText = font.name;
                const fontId = font.id.replace('_', '-');
                btn.dataset.font = fontId;
                
                if (gameData.unlockedFonts.includes(font.id) || gameData.unlockedFonts.includes(fontId)) { // ‚òÖ„Éê„Ç∞‰øÆÊ≠£
                    if (gameData.settings.currentFont === fontId) {
                        btn.classList.add('active');
                    }
                    btn.addEventListener('click', () => {
                        gameData.settings.currentFont = fontId;
                        applyFont();
                        saveData();
                        renderFontSelector(); 
                    });
                } else {
                    btn.disabled = true;
                    btn.innerText = `${font.name} (Êú™ÈñãÊîæ)`;
                }
                container.appendChild(btn);
            });
        }
        
        function renderSoundSelector() {
            const container = document.getElementById('sound-selector-container');
            container.innerHTML = '';
            const allSounds = [
                { id: 'sound-default', name: '„Éá„Éï„Ç©„É´„Éà (Pop)' },
                { id: 'sound_click', name: '„Ç´„ÉÅ„Ç´„ÉÅ' },
                { id: 'sound_synth', name: '„Éî„Ç≥„Éî„Ç≥' }
            ];

            allSounds.forEach(sound => {
                const btn = document.createElement('button');
                btn.className = 'sound-select-btn';
                btn.innerText = sound.name;
                const soundId = sound.id.replace('_', '-');
                
                if (gameData.unlockedSounds.includes(sound.id) || gameData.unlockedSounds.includes(soundId)) { // ‚òÖ„Éê„Ç∞‰øÆÊ≠£
                    if (gameData.settings.currentSound === soundId) {
                        btn.classList.add('active');
                    }
                    btn.addEventListener('click', () => {
                        gameData.settings.currentSound = soundId;
                        saveData();
                        renderSoundSelector(); 
                        playSound('pop'); 
                    });
                } else {
                    btn.disabled = true;
                    btn.innerText = `${sound.name} (Êú™ÈñãÊîæ)`;
                }
                container.appendChild(btn);
            });
        }

        function renderWordPackSelector() {
            const container = document.getElementById('word-pack-selector-container');
            container.innerHTML = '';
            
            const allPacks = [
                { id: 'default', name: '„Éá„Éï„Ç©„É´„Éà' },
                { id: 'pack_animal', name: 'ÂãïÁâ©„Éë„ÉÉ„ÇØ' },
                { id: 'pack_food', name: 'È£ü„ÅπÁâ©„Éë„ÉÉ„ÇØ' },
                { id: 'pack_difficult', name: 'Á•û„ÄÖ„ÅÆÂçòË™û' }
            ];

            allPacks.forEach(pack => {
                const btn = document.createElement('button');
                btn.className = 'word-pack-select-btn';
                btn.innerText = pack.name;
                const packId = pack.id.replace('_', '-');
                
                if (gameData.unlockedPacks.includes(pack.id) || gameData.unlockedPacks.includes(packId)) { // ‚òÖ„Éê„Ç∞‰øÆÊ≠£
                    if (gameData.settings.currentWordPack === packId) {
                        btn.classList.add('active');
                    }
                    btn.addEventListener('click', () => {
                        gameData.settings.currentWordPack = packId;
                        setWordList(packId); 
                        saveData();
                        renderWordPackSelector(); 
                    });
                } else {
                    btn.disabled = true;
                    btn.innerText = `${pack.name} (Êú™ÈñãÊîæ)`;
                }
                container.appendChild(btn);
            });
        }
        
        function renderEffectSelector() {
            const container = document.getElementById('effect-selector-container');
            container.innerHTML = '';
            
            const allEffects = [
                { id: 'default', name: '„Éá„Éï„Ç©„É´„Éà' },
                { id: 'effect_rainbow', name: 'ËôπËâ≤' },
                { id: 'effect_firework', name: 'Ëä±ÁÅ´' },
                { id: 'effect_bubble', name: 'Ê≥°' },
                { id: 'effect_lines', name: 'ÈõÜ‰∏≠Á∑ö' },
                { id: 'effect_gold', name: '„Ç¥„Éº„É´„Éâ („Ç¨„ÉÅ„É£ÈôêÂÆö)' }
            ];

            allEffects.forEach(effect => {
                const btn = document.createElement('button');
                btn.className = 'effect-select-btn';
                btn.innerText = effect.name;
                const effectId = effect.id.replace('_', '-');
                
                if (gameData.unlockedEffects.includes(effect.id) || gameData.unlockedEffects.includes(effectId)) { // ‚òÖ„Éê„Ç∞‰øÆÊ≠£
                    if (gameData.settings.currentEffect === effectId) {
                        btn.classList.add('active');
                    }
                    btn.addEventListener('click', () => {
                        gameData.settings.currentEffect = effectId;
                        saveData();
                        renderEffectSelector();
                    });
                } else {
                    btn.disabled = true;
                    btn.innerText = `${effect.name} (Êú™ÈñãÊîæ)`;
                }
                container.appendChild(btn);
            });
        }

        function applyTheme() {
            const theme = gameData.settings.currentTheme;
            document.body.className = ''; // „Åæ„ÅöÂÖ®„ÇØ„É©„Çπ„Çí„É™„Çª„ÉÉ„Éà
            if (theme !== 'default') {
                document.body.classList.add(theme);
            }
            applyBackground(); 
            applyFont(); 
        }
        function renderThemeSelector() {
            const container = document.getElementById('theme-selector-container');
            container.innerHTML = '';
            const allThemes = [
                { id: 'default', name: '„Éá„Éï„Ç©„É´„Éà' },
                { id: 'theme_cyber', name: '„Çµ„Ç§„Éê„Éº' },
                { id: 'theme_wa', name: 'ÂíåÈ¢®' },
                { id: 'theme_pixel', name: '„Éî„ÇØ„Çª„É´' }
            ];
            allThemes.forEach(theme => {
                const btn = document.createElement('button');
                btn.className = 'theme-select-btn';
                btn.innerText = theme.name;
                const themeId = theme.id.replace('_', '-');
                
                if (gameData.unlockedThemes.includes(theme.id) || gameData.unlockedThemes.includes(themeId)) { // ‚òÖ„Éê„Ç∞‰øÆÊ≠£
                    if (gameData.settings.currentTheme === themeId) {
                        btn.classList.add('active');
                    }
                    btn.addEventListener('click', () => {
                        gameData.settings.currentTheme = themeId;
                        applyTheme();
                        saveData();
                        renderThemeSelector();
                    });
                } else {
                    btn.disabled = true;
                    btn.innerText = `${theme.name} (Êú™ÈñãÊîæ)`;
                }
                container.appendChild(btn);
            });
        }


        function renderBackgroundSelector() {
            const container = document.getElementById('background-selector-container');
            container.innerHTML = '';
            const allBgs = [
                { id: 'bg-default', name: '„Éá„Éï„Ç©„É´„Éà' },
                { id: 'bg_ocean', name: 'Êµ∑' },
                { id: 'bg_galaxy', name: 'ÈäÄÊ≤≥' },
                { id: 'bg_forest', name: 'Ê£Æ' },
                { id: 'bg_sunset', name: 'Â§ïÁÑº„Åë' },
                { id: 'bg_cyber', name: '„Çµ„Ç§„Éê„Éº' },
                { id: 'bg_legend', name: '‰ºùË™¨' },
                { id: 'bg_aurora', name: '„Ç™„Éº„É≠„É© („Ç¨„ÉÅ„É£ÈôêÂÆö)' },
                { id: 'bg_sakura', name: 'Ê°ú („Ç§„Éô„É≥„ÉàÈôêÂÆö)' }
            ];

            allBgs.forEach(bg => {
                const btn = document.createElement('button');
                btn.className = 'bg-select-btn';
                btn.innerText = bg.name;
                const bgId = bg.id.replace('bg_', 'bg-'); // ‚òÖ„Éê„Ç∞‰øÆÊ≠£: IDÁµ±‰∏Ä
                
                if (gameData.unlockedBackgrounds.includes(bg.id) || gameData.unlockedBackgrounds.includes(bgId)) { // ‚òÖ„Éê„Ç∞‰øÆÊ≠£
                    if (gameData.settings.currentBackground === bg.id || gameData.settings.currentBackground === bgId) { // ‚òÖ„Éê„Ç∞‰øÆÊ≠£
                        btn.classList.add('active');
                    }
                    btn.addEventListener('click', () => {
                        gameData.settings.currentBackground = bg.id; // ‰øùÂ≠ò„ÅØ_‰ªò„Åç
                        applyBackground();
                        saveData();
                        renderBackgroundSelector(); 
                    });
                } else {
                    btn.disabled = true;
                    btn.innerText = `${bg.name} (Êú™ÈñãÊîæ)`;
                }
                container.appendChild(btn);
            });

            const effectBtn = document.getElementById('legend-effect-btn');
            if (gameData.settings.currentBackground === 'bg_legend') {
                effectBtn.style.display = 'flex';
                effectBtn.innerHTML = gameData.settings.legendRainbowEffect 
                    ? '<i class="fas fa-magic"></i> ‰ºùË™¨„Ç®„Éï„Çß„ÇØ„Éà: ON' 
                    : '<i class="fas fa-magic"></i> ‰ºùË™¨„Ç®„Éï„Çß„ÇØ„Éà: OFF';
            } else {
                effectBtn.style.display = 'none';
            }
        }
        
        function applyPet() {
            const petId = gameData.settings.currentPet.replace('pet_', '');
            const petEmojis = {'cat': 'üò∫', 'dog': 'üê∂', 'robot': 'ü§ñ'};
            petSprite.innerText = petEmojis[petId] || 'üò∫';
            petSprite.className = `idle`;
            
            const itemId = gameData.settings.currentPetItem;
            const itemEmojis = {'none': '', 'pet_item_santa': 'üéÖ', 'pet_item_party': 'ü•≥', 'pet_item_sakura': 'üå∏'}; // ‚òÖID‰øÆÊ≠£
            petItemHat.innerText = itemEmojis[itemId] || '';

            const houseId = gameData.settings.currentPetHouse;
            const houseEmojis = {'pet-house-none': '', 'pet_house_cushion': 'üõãÔ∏è', 'pet_house_space': 'üöÄ'}; // ‚òÖID‰øÆÊ≠£
            petHouse.innerText = houseEmojis[houseId] || '';
            
            const pos = gameData.settings.petPosition;
            petContainer.style.top = `${pos.y}px`;
            petContainer.style.left = `${pos.x}px`;
        }
        function renderPetSelector() {
            const container = document.getElementById('pet-selector-container');
            container.innerHTML = '';
            const allPets = [
                { id: 'pet-cat', name: 'Áå´' },
                { id: 'pet_dog', name: 'Áä¨' }, // ‚òÖID‰øÆÊ≠£
                { id: 'pet_robot', name: '„É≠„Éú„ÉÉ„Éà (APÂ†±ÈÖ¨)' } // ‚òÖID‰øÆÊ≠£
            ];
            allPets.forEach(pet => {
                const btn = document.createElement('button');
                btn.className = 'pet-select-btn';
                btn.innerText = pet.name;
                const petId = pet.id.replace('_', '-');
                
                if (gameData.unlockedPets.includes(pet.id) || gameData.unlockedPets.includes(petId)) { // ‚òÖ„Éê„Ç∞‰øÆÊ≠£
                    if (gameData.settings.currentPet === petId) btn.classList.add('active');
                    btn.addEventListener('click', () => {
                        gameData.settings.currentPet = petId;
                        applyPet();
                        saveData();
                        renderPetSelector();
                    });
                } else {
                    btn.disabled = true;
                    btn.innerText = `${pet.name} (Êú™ÈñãÊîæ)`;
                }
                container.appendChild(btn);
            });
        }
        function renderPetItemSelector() {
            const container = document.getElementById('pet-item-selector-container');
            container.innerHTML = '';
            const allItems = [
                { id: 'none', name: '„Å™„Åó' },
                { id: 'pet_item_santa', name: '„Çµ„É≥„ÇøÂ∏Ω' },
                { id: 'pet_item_party', name: '„Éë„Éº„ÉÜ„Ç£Â∏Ω („Ç¨„ÉÅ„É£)' },
                { id: 'pet_item_sakura', name: 'Ê°ú„ÅÆ„Åã„Çì„Åñ„Åó („Ç§„Éô)' }
            ];
            allItems.forEach(item => {
                const btn = document.createElement('button');
                btn.className = 'pet-item-select-btn';
                btn.innerText = item.name;
                
                if (gameData.unlockedPetItems.includes(item.id)) { // ‚òÖID‰øÆÊ≠£
                    if (gameData.settings.currentPetItem === item.id) btn.classList.add('active');
                    btn.addEventListener('click', () => {
                        gameData.settings.currentPetItem = item.id;
                        applyPet();
                        saveData();
                        renderPetItemSelector();
                    });
                } else {
                    btn.disabled = true;
                    btn.innerText = `${item.name} (Êú™ÈñãÊîæ)`;
                }
                container.appendChild(btn);
            });
        }
        function renderPetHouseSelector() {
            const container = document.getElementById('pet-house-selector-container');
            container.innerHTML = '';
            const allItems = [
                { id: 'pet-house-none', name: '„Å™„Åó' },
                { id: 'pet_house_cushion', name: '„ÇØ„ÉÉ„Ç∑„Éß„É≥' }, // ‚òÖID‰øÆÊ≠£
                { id: 'pet_house_space', name: 'ÂÆáÂÆôËàπ' } // ‚òÖID‰øÆÊ≠£
            ];
            allItems.forEach(item => {
                const btn = document.createElement('button');
                btn.className = 'pet-house-select-btn';
                btn.innerText = item.name;
                const itemId = item.id.replace('_', '-');
                
                if (gameData.unlockedPetHouses.includes(item.id) || gameData.unlockedPetHouses.includes(itemId)) { // ‚òÖ„Éê„Ç∞‰øÆÊ≠£
                    if (gameData.settings.currentPetHouse === itemId) btn.classList.add('active');
                    btn.addEventListener('click', () => {
                        gameData.settings.currentPetHouse = itemId;
                        applyPet();
                        saveData();
                        renderPetHouseSelector();
                    });
                } else {
                    btn.disabled = true;
                    btn.innerText = `${item.name} (Êú™ÈñãÊîæ)`;
                }
                container.appendChild(btn);
            });
        }
        
        function renderIconSelector() {
            const container = document.getElementById('icon-selector-container');
            container.innerHTML = '';
            
            gameData.unlockedIcons.forEach(iconId => {
                const icon = masterItemList[iconId];
                if (!icon) return;
                
                const btn = document.createElement('button');
                btn.className = 'icon-select-btn';
                btn.innerText = icon.emoji;
                
                if (gameData.settings.currentIcon === iconId) btn.classList.add('active');
                
                btn.addEventListener('click', () => {
                    gameData.settings.currentIcon = iconId;
                    saveData();
                    renderIconSelector();
                    renderProfile();
                });
                
                container.appendChild(btn);
            });
        }

        function setPetState(newState) {
            if (petState === newState && newState !== 'idle') return;
            clearTimeout(petStateTimer);
            cancelAnimationFrame(petAnimationFrame);
            petSprite.classList.remove('idle', 'happy', 'sad');
            petSprite.classList.add(newState);
            petState = newState;
            
            if (newState !== 'idle') {
                petStateTimer = setTimeout(() => {
                    petSprite.classList.remove(newState);
                    petSprite.classList.add('idle');
                    petState = 'idle';
                }, 500); // 0.5Áßí„ÅßÂÖÉ„Å´Êàª„Çã
            }
        }
        
        function applyKeyboardSkin() {
            const skin = gameData.settings.currentKeyboardSkin;
            keyboardContainer.className = ''; // „É™„Çª„ÉÉ„Éà
            if (skin !== 'kb-skin-default') {
                keyboardContainer.classList.add(skin.replace('kb_skin_', 'skin-'));
            }
        }
        function renderKeyboardSkinSelector() {
            const container = document.getElementById('keyboard-skin-selector-container');
            container.innerHTML = '';
            const allSkins = [
                { id: 'kb-skin-default', name: '„Éá„Éï„Ç©„É´„Éà' },
                { id: 'kb_skin_wood', name: 'Êú®ÁõÆË™ø' },
                { id: 'kb_skin_pixel', name: '„Éî„ÇØ„Çª„É´' },
                { id: 'kb_skin_neko', name: 'ËÇâÁêÉ („Ç¨„ÉÅ„É£)' }
            ];
            allSkins.forEach(skin => {
                const btn = document.createElement('button');
                btn.className = 'keyboard-skin-select-btn';
                btn.innerText = skin.name;
                const skinId = skin.id.replace('_', '-');
                
                if (gameData.unlockedKeyboardSkins.includes(skin.id) || gameData.unlockedKeyboardSkins.includes(skinId)) { // ‚òÖ„Éê„Ç∞‰øÆÊ≠£
                    if (gameData.settings.currentKeyboardSkin === skin.id || gameData.settings.currentKeyboardSkin === skinId) btn.classList.add('active');
                    btn.addEventListener('click', () => {
                        gameData.settings.currentKeyboardSkin = skin.id; // _‰ªò„Åç„Åß‰øùÂ≠ò
                        applyKeyboardSkin();
                        saveData();
                        renderKeyboardSkinSelector();
                    });
                } else {
                    btn.disabled = true;
                    btn.innerText = `${skin.name} (Êú™ÈñãÊîæ)`;
                }
                container.appendChild(btn);
            });
        }
        
        function renderBgmSelector() {
            const container = document.getElementById('bgm-selector-container');
            container.innerHTML = '';
            const allBgmsList = [
                { id: 'bgm-audio', name: '„Éá„Éï„Ç©„É´„Éà' },
                { id: 'bgm_2', name: 'Battle' },
                { id: 'bgm_3', name: 'Dream' }
            ];
            allBgmsList.forEach(bgm => {
                const btn = document.createElement('button');
                btn.className = 'bgm-select-btn';
                btn.innerText = bgm.name;
                const bgmId = bgm.id.replace('_', '-');
                
                if (gameData.unlockedBgms.includes(bgm.id) || gameData.unlockedBgms.includes(bgmId)) { // ‚òÖ„Éê„Ç∞‰øÆÊ≠£
                    if (gameData.settings.currentBgm === bgmId) btn.classList.add('active');
                    btn.addEventListener('click', () => {
                        gameData.settings.currentBgm = bgmId;
                        playBGM();
                        saveData();
                        renderBgmSelector();
                    });
                } else {
                    btn.disabled = true;
                    btn.innerText = `${bgm.name} (Êú™ÈñãÊîæ)`;
                }
                container.appendChild(btn);
            });
        }
        
        function applyCharmEffects() {
            // ‚òÖ„ÅäÂÆà„Çä„Éê„Ç∞‰øÆÊ≠£: „Ç≤„Éº„É†„É™„Çª„ÉÉ„ÉàÊôÇ„Å´ÂäπÊûú„ÇíÈÅ©Áî®„Åô„Çã„Åü„ÇÅ„ÄÅresetGame() „Åã„ÇâÂëº„Å≥Âá∫„Åï„Çå„Çã
        }
        function getCharmEffect(effectType) {
            const charmId = gameData.settings.currentCharm;
            if (charmId === 'none' || !masterCharmList[charmId]) return 0;
            
            const effect = masterCharmList[charmId].effect;
            return effect[effectType] || 0;
        }
        function renderCharmSelector() {
            const container = document.getElementById('charm-selector-container');
            container.innerHTML = '';
            
            gameData.unlockedCharms.forEach(charmId => {
                const charm = masterCharmList[charmId];
                if (!charm) return; // ‚òÖ„Éê„Ç∞‰øÆÊ≠£
                
                const btn = document.createElement('button');
                btn.className = 'charm-select-btn';
                btn.innerText = charm.name;
                
                if (gameData.settings.currentCharm === charmId) btn.classList.add('active');
                
                btn.addEventListener('click', () => {
                    gameData.settings.currentCharm = charmId;
                    applyCharmEffects();
                    saveData();
                    renderCharmSelector();
                    renderProfile(); // „Éú„Éº„Éä„ÇπË°®Á§∫Êõ¥Êñ∞
                });
                
                // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó
                btn.addEventListener('mouseenter', (e) => showSkillTooltip(charm.name, charm.description, '', ''));
                btn.addEventListener('mouseleave', () => hideSkillTooltip());
                btn.addEventListener('mousemove', (e) => {
                    skillTooltip.style.left = `${e.clientX + 15}px`;
                    skillTooltip.style.top = `${e.clientY + 15}px`;
                });
                
                container.appendChild(btn);
            });
        }
        
        
        function loadGhostData(modeKey) {
            ghostData = [];
            ghostScore = 0;
            currentGhostIndex = 0;
            if (gameData.ghosts[modeKey] && gameData.ghosts[modeKey].length > 0) {
                ghostData = gameData.ghosts[modeKey];
                ghostScoreDisplay.style.display = 'block';
                ghostScoreDisplay.className = '';
                ghostScoreDisplay.querySelector('span').innerText = '0';
            } else {
                ghostScoreDisplay.style.display = 'none';
            }
        }
        function startGhostTimer() {
            if (ghostData.length === 0) return;
            ghostTimer = setInterval(updateGhostScore, 100);
        }
        function stopGhostTimer() {
            clearInterval(ghostTimer);
        }
        function updateGhostScore() {
            if (!gameRunning) return;
            const elapsedTime = new Date() - gameStartTime;
            
            while(ghostData[currentGhostIndex] && elapsedTime >= ghostData[currentGhostIndex].time) {
                if (gameMode === 'suddenDeath' || gameMode === 'fast') ghostScore = ghostData[currentGhostIndex].types;
                else ghostScore = ghostData[currentGhostIndex].score;
                currentGhostIndex++;
            }
            
            ghostScoreDisplay.querySelector('span').innerText = ghostScore.toLocaleString();
            
            let currentDisplayScore = (gameMode === 'suddenDeath' || gameMode === 'fast') ? totalTypeCount : currentScore;
            
            if (currentDisplayScore > ghostScore) {
                ghostScoreDisplay.className = 'beating';
            } else if (currentDisplayScore < ghostScore) {
                ghostScoreDisplay.className = 'losing';
            } else {
                ghostScoreDisplay.className = '';
            }
        }
        function saveGhostData(modeKey) {
            if (gameMode !== 'custom' && gameMode !== 'timeAttack') {
                gameData.ghosts[modeKey] = [...ghostData]; 
            }
        }
        
        
        // --- 10. „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº ---

        function switchMode(newMode) {
            if (gameRunning || gameWaitingToStart) return;
            gameMode = newMode;
            
            // „Éë„ÉÉ„ÇØÂàá„ÇäÊõø„Åà
            if (newMode === 'english') setWordList('pack_english');
            else if (newMode === 'fill') setWordList('pack_difficult'); 
            else setWordList(gameData.settings.currentWordPack); 
            
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.getElementById(newMode + '-mode-btn') || document.getElementById(newMode + '-mode-btn'.replace('Attack', 'attack'));
            if(activeBtn) activeBtn.classList.add('active');

            updateDataUI(); 
            resetGame();
        }

        // „É°„Ç§„É≥„É¢„Éº„Éâ
        document.getElementById('time-mode-btn').addEventListener('click', () => switchMode('time'));
        document.getElementById('word-mode-btn').addEventListener('click', () => switchMode('words'));
        document.getElementById('sudden-death-mode-btn').addEventListener('click', () => switchMode('suddenDeath'));
        // „ÉÅ„É£„É¨„É≥„Ç∏„É¢„Éº„Éâ
        document.getElementById('time-attack-mode-btn').addEventListener('click', () => switchMode('timeAttack'));
        document.getElementById('accuracy-mode-btn').addEventListener('click', () => switchMode('accuracy'));
        // document.getElementById('lyrics-mode-btn').addEventListener('click', () => switchMode('lyrics')); // ‚òÖÊ≠åË©ûÂâäÈô§
        document.getElementById('english-mode-btn').addEventListener('click', () => switchMode('english'));
        document.getElementById('double-mode-btn').addEventListener('click', () => switchMode('double'));
        document.getElementById('fill-mode-btn').addEventListener('click', () => switchMode('fill'));
        document.getElementById('fast-mode-btn').addEventListener('click', () => switchMode('fast'));

        document.getElementById('custom-mode-btn').addEventListener('click', () => {
            document.getElementById('advanced-settings-btn').click();
            setTimeout(() => customTextarea.focus(), 100);
        });


        document.getElementById('retry-button').addEventListener('click', () => {
            resetGame();
        });

        document.getElementById('share-button').addEventListener('click', () => {
            const { modeText, scoreValue, wpm, accuracy } = lastGameResult;
            const text = `Pop Typer„ÅßÁµêÊûú„Çí„Ç∑„Çß„Ç¢ÔºÅ\n„É¢„Éº„Éâ: ${modeText}\n${scoreValue}\nWPM: ${wpm}\nAccuracy: ${accuracy}%\n#PopTyper`;
            
            try {
                navigator.clipboard.writeText(text).then(() => {
                    alert("„Çπ„Ç≥„Ç¢„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ");
                }, () => {
                    alert("„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ");
                });
            } catch (e) {
                alert("„Åä‰Ωø„ÅÑ„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØ„Ç≥„Éî„ÉºÊ©üËÉΩ„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ");
            }
        });

        document.addEventListener('keydown', (e) => {
            if (!userInteracted) {
                userInteracted = true; 
                playBGM(); 
            }
            if (e.key === 'Alt' || e.key === 'Control' || e.key === 'Shift' || e.key === 'Meta') return;

            const isModalOpen = [
                settingsOverlay, shopOverlay, titleListOverlay,
                missionOverlay, achievementOverlay, statsOverlay,
                adminPanelOverlay, gachaResultOverlay, // ‚òÖ„É≠„Ç∞„Ç§„É≥„Éú„Éº„Éä„ÇπÂâäÈô§
                rankingOverlay, prestigeChoiceOverlay, skillTreeOverlay,
                newsOverlay, profileOverlay
            ].some(modal => modal.style.display === 'flex' || modal.style.display === 'block');

            if (isModalOpen) {
                if (e.target.id === 'custom-textarea') {
                    return;
                }
                e.preventDefault(); 
                return;
            }

            if (!gameRunning && !gameWaitingToStart) {
                if (e.key === ' ') {
                    e.preventDefault();
                    if (document.getElementById('end-screen-overlay').style.display === 'flex') {
                        document.getElementById('retry-button').click(); 
                    } 
                    else {
                        resetGame(); 
                        startGame(); 
                    }
                }
                return; 
            }

            // ‚òÖEsc„Ç≠„Éº„Éê„Ç∞‰øÆÊ≠£
            if (e.key === 'Escape') {
                if (gameRunning || gameWaitingToStart) {
                    escapePressed = true; 
                    endGame();
                }
                return;
            }

            if (e.key.length !== 1 || e.key === ' ') { 
                if (e.key === ' ') e.preventDefault();
                return;
            }

            if (gameRunning || gameWaitingToStart) {
                if (isAutoTyping) return;
                processTypedKey(e.key.toLowerCase());
            }
        });

        // „É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè„Éú„Çø„É≥
        shopBtn.addEventListener('click', () => { 
            if (gameRunning || gameWaitingToStart) return; 
            renderShop();
            shopOverlay.style.display = 'flex'; 
        });
        titleListBtn.addEventListener('click', () => { 
            if (gameRunning || gameWaitingToStart) return; 
            renderTitleList();
            titleListOverlay.style.display = 'flex'; 
        });
        advancedSettingsBtn.addEventListener('click', () => { 
            if (gameRunning || gameWaitingToStart) return; 
            renderBackgroundSelector();
            renderFontSelector(); 
            renderSoundSelector(); 
            renderWordPackSelector();
            renderEffectSelector(); 
            renderThemeSelector(); 
            renderPetSelector();
            renderPetItemSelector(); 
            renderPetHouseSelector();
            renderBgmSelector();
            renderKeyboardSkinSelector();
            renderCharmSelector();
            renderIconSelector();
            prestigeBtn.style.display = (gameData.stats.level >= MAX_LEVEL && gameData.stats.prestigeLevel < MAX_PRESTIGE_LEVEL) ? 'flex' : 'none'; 
            settingsOverlay.style.display = 'flex'; 
        });
        missionBtn.addEventListener('click', () => { 
            if (gameRunning || gameWaitingToStart) return; 
            renderMissionList();
            missionOverlay.style.display = 'flex'; 
        });
        achievementBtn.addEventListener('click', () => { 
            if (gameRunning || gameWaitingToStart) return; 
            renderAchievementList();
            achievementOverlay.style.display = 'flex'; 
        });
        statsBtn.addEventListener('click', () => { 
            if (gameRunning || gameWaitingToStart) return; 
            renderStats();
            statsOverlay.style.display = 'flex'; 
        });
        rankingBtn.addEventListener('click', () => { 
            if (gameRunning || gameWaitingToStart) return; 
            renderRanking();
            rankingOverlay.style.display = 'flex'; 
        });
        skillTreeBtn.addEventListener('click', () => { 
            if (gameRunning || gameWaitingToStart) return; 
            renderSkillTree();
            skillTreeOverlay.style.display = 'block'; 
        });
        newsBtn.addEventListener('click', () => { 
            if (gameRunning || gameWaitingToStart) return; 
            renderNewsBoard();
            newsOverlay.style.display = 'flex'; 
        });
        profileButton.addEventListener('click', () => { 
            if (gameRunning || gameWaitingToStart) return; 
            renderProfile();
            profileOverlay.style.display = 'flex'; 
        });
        
        
        // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã„Éú„Çø„É≥
        const overlaysAndCloseBtns = {
            'shop-overlay': 'close-shop-btn',
            'title-list-overlay': 'close-title-list-btn',
            'settings-overlay': 'close-settings-btn',
            'admin-panel-overlay': 'close-admin-panel-btn',
            'mission-overlay': 'close-mission-btn',
            'achievement-overlay': 'close-achievement-btn',
            'stats-overlay': 'close-stats-btn',
            // 'login-bonus-overlay': 'close-login-bonus-btn', // ‚òÖ„É≠„Ç∞„Ç§„É≥„Éú„Éº„Éä„ÇπÂâäÈô§
            'gacha-result-overlay': 'close-gacha-result-btn',
            'ranking-overlay': 'close-ranking-btn',
            'prestige-choice-overlay': 'close-prestige-choice-btn',
            'skill-tree-overlay': 'close-skill-tree-btn',
            'news-overlay': 'close-news-btn',
            'profile-overlay': 'close-profile-btn'
        };

        for (const overlayId in overlaysAndCloseBtns) {
            const closeBtnId = overlaysAndCloseBtns[overlayId];
            const overlay = document.getElementById(overlayId);
            const closeBtn = document.getElementById(closeBtnId);

            closeBtn.addEventListener('click', () => { 
                overlay.style.display = 'none'; 
                if (overlayId === 'skill-tree-overlay') hideSkillTooltip();
            });
            overlay.addEventListener('click', (e) => { 
                if (e.target === overlay) { 
                    overlay.style.display = 'none'; 
                    if (overlayId === 'skill-tree-overlay') hideSkillTooltip();
                } 
            });
        }


        // Ë®≠ÂÆöÁîªÈù¢ÂÜÖ„ÅÆ„Éú„Çø„É≥
        document.getElementById('delete-data-btn').addEventListener('click', () => {
            if (window.confirm("Êú¨ÂΩì„Å´„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\nÔºà„Éè„Ç§„Çπ„Ç≥„Ç¢„ÄÅÊâÄÊåÅÈáë„ÄÅ„É¨„Éô„É´„ÄÅËß£Êîæ„Åó„ÅüÂÖ®„Ç¢„Ç§„ÉÜ„É†„Åå„É™„Çª„ÉÉ„Éà„Åï„Çå„Åæ„ÅôÔºâ")) {
                try {
                    localStorage.removeItem(STORAGE_KEY);
                    gameData = getDefaultGameData();
                    loadData(); 
                    alert("„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü„ÄÇ");
                    settingsOverlay.style.display = 'none';
                    resetGame(); 
                } catch (e) { console.error("Data deletion failed", e); alert("„Éá„Éº„Çø„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ"); }
            }
        });
        profileChangeNameBtn.addEventListener('click', () => {
            const name = prompt("„É©„É≥„Ç≠„É≥„Ç∞„Å´ÁôªÈå≤„Åô„ÇãÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:", gameData.stats.playerName);
            if (name && name.trim().length > 0) {
                gameData.stats.playerName = name.trim();
                saveData();
                renderProfile();
                alert("ÂêçÂâç„ÇíÂ§âÊõ¥„Åó„Åæ„Åó„Åü: " + gameData.stats.playerName);
            }
        });
        document.getElementById('pop-mode-btn').addEventListener('click', () => { 
            if (popMode === 'random') {
                popMode = 'fixed';
                document.getElementById('pop-mode-btn').innerHTML = '<i class="fas fa-bullseye"></i> ÊºîÂá∫: ÂÖ•ÂäõÁÆáÊâÄ';
            } else {
                popMode = 'random';
                document.getElementById('pop-mode-btn').innerHTML = '<i class="fas fa-bolt"></i> ÊºîÂá∫: „É©„É≥„ÉÄ„É†';
            }
        });
        
        document.getElementById('legend-effect-btn').addEventListener('click', () => {
            gameData.settings.legendRainbowEffect = !gameData.settings.legendRainbowEffect;
            saveData();
            applyBackground();
            renderBackgroundSelector(); 
        });

        document.getElementById('furigana-toggle-btn').addEventListener('click', () => {
            gameData.settings.showFurigana = !gameData.settings.showFurigana;
            saveData();
            applyFuriganaSetting();
        });

        document.getElementById('bgm-toggle-btn').addEventListener('click', () => {
            gameData.settings.bgmOn = !gameData.settings.bgmOn;
            saveData();
            applyBGMSetting(true); 
        });

        document.getElementById('start-custom-btn').addEventListener('click', () => {
            if (gameRunning || gameWaitingToStart) return;
            const text = customTextarea.value;
            if (text.trim().length === 0) {
                alert("„ÅäÈ°å„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
                return;
            }
            wordsToType = parseCustomWords(text);
            if (wordsToType.length === 0) {
                alert("ÊúâÂäπ„Å™„ÅäÈ°å„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ\nÂΩ¢Âºè: Êº¢Â≠ó[„Çà„Åø] „Åæ„Åü„ÅØ „Å≤„Çâ„Åå„Å™");
                return;
            }
            gameValue = wordsToType.length; 
            settingsOverlay.style.display = 'none'; 
            switchMode('custom');
            startGame();
        });
        
        weakWordPracticeBtn.addEventListener('click', () => {
            if (gameRunning || gameWaitingToStart) return;
            const weakWords = Object.values(gameData.weakWords)
                .filter(w => w.miss > 0 && w.total > 2) // 3Âõû‰ª•‰∏äÊåëÊà¶„Åó„Å¶„Éü„Çπ„Åó„ÅüÂçòË™û
                .sort((a, b) => (b.miss / b.total) - (a.miss / a.total)); // „Éü„ÇπÁéáÈ†Ü
            
            if (weakWords.length === 0) {
                alert("Ëã¶ÊâãÂçòË™û„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ");
                return;
            }
            
            wordsToType = weakWords.slice(0, 20); // ‰∏ä‰Ωç20‰ª∂
            gameValue = wordsToType.length; 
            settingsOverlay.style.display = 'none'; 
            switchMode('custom');
            startGame();
        });

        // ‚òÖÊîπÈÄ†ÁÇπ: Ëª¢Áîü
        prestigeBtn.addEventListener('click', () => {
            if (gameData.stats.level < MAX_LEVEL) {
                alert(`„É¨„Éô„É´ ${MAX_LEVEL} „Åß„Éó„É¨„Çπ„ÉÜ„Éº„Ç∏„ÅåËß£Êîæ„Åï„Çå„Åæ„Åô„ÄÇ`);
                return;
            }
            if (gameData.stats.prestigeLevel >= MAX_PRESTIGE_LEVEL) {
                alert("„ÅÇ„Å™„Åü„ÅØÊó¢„Å´ÊúÄÂ§ßËª¢Áîü„É¨„Éô„É´„Å´ÈÅî„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ");
                return;
            }
            
            prestigeModalLevel.innerText = (gameData.stats.prestigeLevel + 1);
            
            // Ëª¢Áîü„Çø„Ç§„Éó„ÅåÊú™ÈÅ∏Êäû„ÅÆÂ†¥Âêà
            if (gameData.stats.prestigeType === null) {
                prestigeTypeChoice.style.display = 'block';
                prestigeTrialChoice.style.display = 'none';
                prestigeChoiceOverlay.style.display = 'flex';
            } else {
                // ÈÅ∏ÊäûÊ∏à„Åø„ÅÆÂ†¥Âêà„ÅØË©¶Á∑¥„É¢„Éº„ÉÄ„É´
                prestigeTypeChoice.style.display = 'none';
                prestigeTrialChoice.style.display = 'block';
                
                // Ë©¶Á∑¥„ÅÆSPÂ†±ÈÖ¨„ÇíË®àÁÆó (Ëª¢Áîü„É¨„Éô„É´„Å´Âøú„Åò„Å¶Â¢óÂä†)
                const baseSP = Math.floor(1 + gameData.stats.prestigeLevel / 5);
                document.querySelectorAll('.trial-sp-reward').forEach(el => {
                    const parentId = el.closest('.prestige-choice-option').id;
                    if (parentId === 'prestige-trial-none') el.innerText = baseSP;
                    if (parentId === 'prestige-trial-combo') el.innerText = baseSP * 2;
                    if (parentId === 'prestige-trial-perfect') el.innerText = baseSP * 3;
                });
                
                // ÁèæÂú®„ÅÆË©¶Á∑¥Áä∂Ê≥Å
                if (gameData.prestigeTrial.active) {
                    const trialMap = { 'combo': '„Ç≥„É≥„Éú„ÅÆË©¶Á∑¥', 'perfect': 'ÂÆåÂÖ®ÁÑ°Ê¨†„ÅÆË©¶Á∑¥' };
                    prestigeCurrentTrialText.innerText = `${trialMap[gameData.prestigeTrial.type]} (ÈÅîÊàêÂ∫¶: ${gameData.prestigeTrial.progress}%)`;
                    prestigeCurrentTrialText.style.color = 'var(--color-accent)';
                } else {
                    prestigeCurrentTrialText.innerText = "„Å™„Åó (Ë©¶Á∑¥Â§±Êïó„ÄÅ„Åæ„Åü„ÅØÊú™ÈÅ∏Êäû)";
                    prestigeCurrentTrialText.style.color = '#aaa';
                }

                prestigeChoiceOverlay.style.display = 'flex';
            }
        });
        
        prestigeChoiceStandard.addEventListener('click', () => {
            if (window.confirm("Ëª¢Áîü„Çø„Ç§„Éó„Äå„Çπ„Çø„É≥„ÉÄ„Éº„Éâ„Äç„ÇíÈÅ∏„Å≥„Åæ„Åô„ÅãÔºü\n(„Çπ„Ç≥„Ç¢„Å®XP„Å´„Éú„Éº„Éä„Çπ)\n„Åì„ÅÆÈÅ∏Êäû„ÅØÂ§âÊõ¥„Åß„Åç„Åæ„Åõ„Çì„ÄÇ")) {
                gameData.stats.prestigeType = 'standard';
                executePrestige(); // ÂàùÂõû„ÅØË©¶Á∑¥„Å™„Åó
                prestigeChoiceOverlay.style.display = 'none';
            }
        });
        
        prestigeChoiceWealth.addEventListener('click', () => {
             if (window.confirm("Ëª¢Áîü„Çø„Ç§„Éó„ÄåÂØåË±™„Äç„ÇíÈÅ∏„Å≥„Åæ„Åô„ÅãÔºü\n(„Ç¨„ÉÅ„É£„ÅÆ„É¨„Ç¢ÁéáUP)\n„Åì„ÅÆÈÅ∏Êäû„ÅØÂ§âÊõ¥„Åß„Åç„Åæ„Åõ„Çì„ÄÇ")) {
                gameData.stats.prestigeType = 'wealth';
                executePrestige(); // ÂàùÂõû„ÅØË©¶Á∑¥„Å™„Åó
                prestigeChoiceOverlay.style.display = 'none';
            }
        });
        
        prestigeTrialNone.addEventListener('click', () => {
             if (window.confirm("Ë©¶Á∑¥„Å™„Åó„ÅßËª¢Áîü„Åó„Åæ„Åô„ÅãÔºü")) {
                executePrestige();
                prestigeChoiceOverlay.style.display = 'none';
            }
        });
        prestigeTrialCombo.addEventListener('click', () => {
             if (window.confirm("Ë©¶Á∑¥„Äå„Ç≥„É≥„Éú„ÅÆË©¶Á∑¥„Äç„ÇíÈñãÂßã„Åó„Åæ„Åô„ÅãÔºü")) {
                gameData.prestigeTrial = { active: true, type: 'combo', rewardSP: (Math.floor(1 + gameData.stats.prestigeLevel / 5)) * 2, progress: 0 };
                executePrestige();
                prestigeChoiceOverlay.style.display = 'none';
            }
        });
        prestigeTrialPerfect.addEventListener('click', () => {
             if (window.confirm("Ë©¶Á∑¥„ÄåÂÆåÂÖ®ÁÑ°Ê¨†„ÅÆË©¶Á∑¥„Äç„ÇíÈñãÂßã„Åó„Åæ„Åô„ÅãÔºü")) {
                gameData.prestigeTrial = { active: true, type: 'perfect', rewardSP: (Math.floor(1 + gameData.stats.prestigeLevel / 5)) * 3, progress: 0 };
                executePrestige();
                prestigeChoiceOverlay.style.display = 'none';
            }
        });


        function executePrestige() {
            // Ë©¶Á∑¥„ÅÆSPË®àÁÆó
            let spGained = 0;
            if (gameData.prestigeTrial.active) {
                if (gameData.prestigeTrial.progress >= 100) { // ÈÅîÊàê
                    spGained = gameData.prestigeTrial.rewardSP;
                    alert(`Ë©¶Á∑¥ÈÅîÊàêÔºÅ „Çπ„Ç≠„É´„Éù„Ç§„É≥„Éà ${spGained} SP „ÇíÁç≤ÂæóÔºÅ`);
                } else {
                    // Ë©¶Á∑¥Â§±Êïó (SP„Å™„Åó)
                }
            } else {
                // Ë©¶Á∑¥„Å™„Åó
                spGained = Math.floor(1 + gameData.stats.prestigeLevel / 5);
            }
            
            gameData.stats.prestigeLevel++;
            gameData.stats.skillPoints += spGained;
            gameData.stats.level = 1;
            gameData.stats.xp = 0;
            gameData.stats.money = 0;
            gameData.prestigeTrial = { active: false, type: null, rewardSP: 0, progress: 0 }; // Ë©¶Á∑¥„É™„Çª„ÉÉ„Éà
            
            Object.keys(gameData.activeItems).forEach(key => {
                gameData.activeItems[key] = false;
            });
            
            playSound('reward');
            saveData();
            loadData();
            resetGame();
            alert(`„Éó„É¨„Çπ„ÉÜ„Éº„Ç∏ ${gameData.stats.prestigeLevel} „Å´Âà∞ÈÅî„Åó„Åæ„Åó„ÅüÔºÅ`);
            settingsOverlay.style.display = 'none';
        }
        
        function checkPrestigeTrial(gameResult) {
            if (!gameData.prestigeTrial.active || gameData.stats.level >= 30) return;
            
            const trial = gameData.prestigeTrial;
            if (trial.type === 'combo') {
                trial.progress = Math.max(trial.progress, (gameResult.maxCombo / 100) * 100);
            } else if (trial.type === 'perfect') {
                if (gameResult.gameMode === 'time_30' && gameResult.errors === 0) {
                    trial.progress = 100;
                }
            }
            
            if (trial.progress >= 100) {
                alert("„Éó„É¨„Çπ„ÉÜ„Éº„Ç∏„ÅÆË©¶Á∑¥„ÇíÈÅîÊàê„Åó„Åæ„Åó„ÅüÔºÅ\nLv. 100 „Å´Âà∞ÈÅî„Åó„Å¶Ëª¢Áîü„Åô„Çã„Å®„ÄÅËøΩÂä†SP„Åå„Éú„Éº„Éä„Çπ„Åï„Çå„Åæ„Åô„ÄÇ");
                trial.active = false; // ÈÅîÊàê„Åó„Åü„Çâ„Éï„É©„Ç∞„ÅØ„Ç™„Éï„Å´„Åô„Çã (Â†±ÈÖ¨„ÅØ‰øùÊåÅ)
                saveData();
            }
        }
        
        function failPrestigeTrial(reason) {
            if (!gameData.prestigeTrial.active) return;
            alert(`Ë©¶Á∑¥Â§±Êïó„ÄÇ\n(${reason})\nÊ¨°„ÅÆËª¢Áîü„ÅßÂÜçÊåëÊà¶„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
            gameData.prestigeTrial = { active: false, type: null, rewardSP: 0, progress: 0 };
            saveData();
        }

        // ‚òÖ„É≠„Ç∞„Ç§„É≥„Éú„Éº„Éä„ÇπÂâäÈô§
        // function checkLoginBonus() { ... }
        // receiveLoginBonusBtn.addEventListener('click', () => { ... });

        // ‚òÖÊîπÈÄ†ÁÇπ: „Ç¨„ÉÅ„É£
        gachaPullBtn.addEventListener('click', () => {
            const cost = GACHA_COST * (1 - (getSkillEffect('g02_gacha_cost') * 0.05));
            if (gameData.stats.money < cost) {
                alert("„ÅäÈáë„ÅåË∂≥„Çä„Åæ„Åõ„Çì„ÄÇ");
                return;
            }
            if (!window.confirm(`„É©„É≥„ÉÄ„É†„Éú„ÉÉ„ÇØ„Çπ„ÇíÂºï„Åç„Åæ„Åô„ÅãÔºü\n(${cost.toLocaleString()} G)`)) {
                return;
            }

            gameData.stats.money -= cost;
            gameData.stats.gachaPulls++;
            gachaPullBtn.disabled = true;
            
            // ÂØåË±™Ëª¢Áîü„Éú„Éº„Éä„Çπ
            let baseRates = {...gachaPool};
            let prestigeBonus = (gameData.stats.prestigeType === 'wealth') ? gameData.stats.prestigeLevel * 2.5 : 0;
            prestigeBonus += getSkillEffect('g01_gacha') * 0.2; // „Çπ„Ç≠„É´„Éú„Éº„Éä„Çπ
            
            if (prestigeBonus > 0) {
                baseRates['legendary'] = Math.min(baseRates['legendary'] + (prestigeBonus * 0.2), 20); // 2Ââ≤Â¢ó„Åó (‰∏äÈôê20%)
                baseRates['super-rare'] = Math.min(baseRates['super-rare'] + (prestigeBonus * 0.8), 50); // 8Ââ≤Â¢ó„Åó (‰∏äÈôê50%)
                baseRates['normal'] = Math.max(0, baseRates['normal'] - prestigeBonus); // „Éé„Éº„Éû„É´„ÅåÊ∏õ„Çã
            }
            
            const rand = Math.random() * 100;
            let rarity = 'normal';
            if (rand < baseRates['legendary']) {
                rarity = 'legendary';
            } else if (rand < baseRates['legendary'] + baseRates['super-rare']) {
                rarity = 'super-rare';
            } else if (rand < baseRates['legendary'] + baseRates['super-rare'] + baseRates['rare']) {
                rarity = 'rare';
            }
            
            // „Ç§„Éô„É≥„Éà„Ç¢„Ç§„ÉÜ„É†„Çí„Ç¨„ÉÅ„É£„Éó„Éº„É´„Å´ËøΩÂä†
            let currentGachaPool = {
                'normal': [...gachaItemsByRarity['normal']],
                'rare': [...gachaItemsByRarity['rare']],
                'super-rare': [...gachaItemsByRarity['super-rare']],
                'legendary': [...gachaItemsByRarity['legendary']]
            };
            if (gameData.activeEvent === 'e_sakura') {
                currentGachaPool['rare'].push('pet_item_sakura');
            }
            
            const possibleItems = currentGachaPool[rarity];
            const itemId = possibleItems[Math.floor(Math.random() * possibleItems.length)];
            const item = masterItemList[itemId];
            
            showGachaResult(item, itemId, rarity);
            checkAchievements({ gachaRarity: rarity }); // „Ç¨„ÉÅ„É£ÂÆüÁ∏æ„ÉÅ„Çß„ÉÉ„ÇØ
            
            saveData();
            updateDataUI();
            renderShop();
        });

        function showGachaResult(item, itemId, rarity) {
            let rarityText = "NORMAL";
            gachaResultRarity.className = "";
            playSound('gacha-normal');

            if (rarity === 'rare') {
                rarityText = "RARE!";
                gachaResultRarity.className = "rare";
                playSound('gacha-rare');
            } else if (rarity === 'super-rare') {
                rarityText = "SUPER RARE!!";
                gachaResultRarity.className = "super-rare";
                playSound('gacha-super-rare');
            } else if (rarity === 'legendary') {
                rarityText = "‚ú®LEGENDARY!!!‚ú®";
                gachaResultRarity.className = "legendary";
                playSound('gacha-super-rare');
            }
            
            gachaResultRarity.innerText = rarityText;
            gachaResultItem.innerText = item.name;
            gachaResultDescription.innerText = item.description;

            // „Ç¢„Ç§„ÉÜ„É†‰ªò‰∏é
            const itemLists = {
                'background': gameData.unlockedBackgrounds,
                'effect': gameData.unlockedEffects,
                'pet-item': gameData.unlockedPetItems,
                'icon': gameData.unlockedIcons,
                'kb-skin': gameData.unlockedKeyboardSkins,
                'charm': gameData.unlockedCharms
            };
            if (item.type === 'utility') {
                if (itemId === 'money_small' || itemId === 'money_medium') {
                    gameData.stats.money += item.value;
                } else if (itemId === 'boost_pack') {
                    item.value.forEach(boostId => gameData.activeItems[boostId] = true);
                }
            } else if (itemLists[item.type]) {
                if (!itemLists[item.type].includes(itemId)) {
                    itemLists[item.type].push(itemId);
                }
            }

            gachaResultOverlay.style.display = 'flex';
        }
        
        function addRankingEntry(modeKey, score) {
            const playerName = gameData.stats.playerName || "TYPER";
            
            if (window.confirm("„Éè„Ç§„Çπ„Ç≥„Ç¢„Çí„É©„É≥„Ç≠„É≥„Ç∞„Å´ÁôªÈå≤„Åó„Åæ„Åô„ÅãÔºü")) {
                const name = prompt("„É©„É≥„Ç≠„É≥„Ç∞„Å´ÁôªÈå≤„Åô„ÇãÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:", playerName);
                if (name && name.trim().length > 0) {
                    gameData.stats.playerName = name.trim();
                    const entry = { name: gameData.stats.playerName, score: score, icon: gameData.settings.currentIcon };
                    
                    if (!gameData.ranking[modeKey]) gameData.ranking[modeKey] = [];
                    gameData.ranking[modeKey].push(entry);
                    
                    const isTimeAttack = modeKey === 'timeAttack';
                    gameData.ranking[modeKey].sort((a, b) => {
                        return isTimeAttack ? a.score - b.score : b.score - a.score;
                    });
                    
                    gameData.ranking[modeKey] = gameData.ranking[modeKey].slice(0, 10);
                    saveData();
                }
            }
        }
        
        function getRanking(modeKey) {
            return gameData.ranking[modeKey] || [];
        }
        
        function renderRanking(modeKey = 'time_30') {
            rankingModeSelector.innerHTML = '';
            const modes = [
                { key: 'time_30', name: '30Áßí' },
                { key: 'suddenDeath', name: '„Çµ„Éâ„É≥„Éá„Çπ' },
                { key: 'timeAttack', name: 'TA' },
                { key: 'accuracy', name: 'Á≤æÂ∫¶' },
                // { key: 'lyrics', name: 'Ê≠åË©û' }, // ‚òÖÊ≠åË©ûÂâäÈô§
                { key: 'english', name: 'Ëã±ÂçòË™û' },
                { key: 'double', name: '„ÉÄ„Éñ„É´' },
                { key: 'fill', name: 'Á©¥Âüã„ÇÅ' },
                { key: 'fast', name: 'Êó©ÈÄÅ„Çä' }
            ];
            
            modes.forEach(mode => {
                const btn = document.createElement('button');
                btn.className = 'sidebar-btn';
                btn.innerText = mode.name;
                btn.style.width = 'auto';
                if (mode.key === modeKey) {
                    btn.classList.add('active');
                }
                btn.addEventListener('click', () => renderRanking(mode.key));
                rankingModeSelector.appendChild(btn);
            });

            rankingList.innerHTML = '';
            const ranking = getRanking(modeKey);
            
            if (ranking.length === 0) {
                rankingList.innerHTML = '<li>„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</li>';
                return;
            }

            ranking.forEach((entry, index) => {
                const li = document.createElement('li');
                let scoreText = entry.score.toLocaleString();
                if (modeKey === 'timeAttack') scoreText = `${entry.score.toFixed(2)}s`;
                if (modeKey === 'accuracy') scoreText = `${entry.score.toFixed(2)}%`;
                
                const iconEmoji = (masterItemList[entry.icon] ? masterItemList[entry.icon].emoji : 'üë§') || 'üë§';
                
                li.innerHTML = `
                    <span>#${index + 1}</span>
                    <div>
                        <span class="rank-icon">${iconEmoji}</span>
                        <span class="rank-name">${entry.name}</span>
                    </div>
                    <span class="rank-score">${scoreText}</span>
                `;
                rankingList.appendChild(li);
            });
        }
        
        petContainer.addEventListener('mousedown', (e) => {
            isPetDragging = true;
            petContainer.classList.add('dragging');
            petDragOffsetX = e.clientX - petContainer.getBoundingClientRect().left;
            petDragOffsetY = e.clientY - petContainer.getBoundingClientRect().top;
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isPetDragging) return;
            let x = e.clientX - petDragOffsetX;
            let y = e.clientY - petDragOffsetY;
            
            x = Math.max(0, Math.min(window.innerWidth - petContainer.offsetWidth, x));
            y = Math.max(0, Math.min(window.innerHeight - petContainer.offsetHeight, y));

            petContainer.style.left = `${x}px`;
            petContainer.style.top = `${y}px`;
        });

        document.addEventListener('mouseup', () => {
            if (isPetDragging) {
                isPetDragging = false;
                petContainer.classList.remove('dragging');
                gameData.settings.petPosition = {
                    x: petContainer.getBoundingClientRect().left,
                    y: petContainer.getBoundingClientRect().top
                };
                saveData();
            }
        });


        // „Éá„Éº„Çø„ÅÆ„Ç®„ÇØ„Çπ„Éù„Éº„Éà
        document.getElementById('export-button').addEventListener('click', () => { 
            try {
                const dataStr = btoa(JSON.stringify(gameData));
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = 'pop-typer-save.sav';
                let linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click(); linkElement.remove();
                alert("„Éá„Éº„Çø„ÇíÊõ∏„ÅçÂá∫„Åó„Åæ„Åó„Åü„ÄÇ");
            } catch (e) { alert("„Éá„Éº„ÇøÊõ∏„ÅçÂá∫„Åó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ"); }
        });
        
        // „Éá„Éº„Çø„ÅÆ„Ç§„É≥„Éù„Éº„Éà
        document.getElementById('import-input').addEventListener('change', (event) => { 
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    let importedDataStr = e.target.result;
                    let importedData;
                    try {
                        importedData = JSON.parse(atob(importedDataStr));
                    } catch (e) {
                        importedData = JSON.parse(importedDataStr);
                    }
                    
                    if (importedData && importedData.stats && importedData.highScores) {
                        if (window.confirm("„Çª„Éº„Éñ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åô„ÄÇÁèæÂú®„ÅÆ„Éá„Éº„Çø„ÅØ‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô„ÄÇ\n„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü")) {
                            gameData = importedData;
                            saveData(); loadData(); resetGame();
                            alert("„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü„ÄÇ");
                            settingsOverlay.style.display = 'none';
                        }
                    } else { alert("ÁÑ°Âäπ„Å™„Çª„Éº„Éñ„Éá„Éº„Çø„Éï„Ç°„Ç§„É´„Åß„Åô„ÄÇ"); }
                } catch (err) { alert("„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ"); }
            };
            reader.readAsText(file); event.target.value = null;
        });

        // --- 11. ÂàùÊúüÂåñÂÆüË°å ---
        // ‚òÖ„Éê„Ç∞‰øÆÊ≠£: loadData() „Å® resetGame() „Çí„Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„Éó„ÅßÂÆüË°å
        loadData();
        resetGame();

        // --- 12. Èö†„Åó„Ç≥„Éº„Éâ„Éª„Éë„Éç„É´Âà∂Âæ° ---

        document.getElementById('code-btn').addEventListener('click', () => {
            if (gameRunning || gameWaitingToStart) return; 

            const inputCode = prompt("„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:");
            
            if (inputCode === "MANY") {
                const amount = 10000; 
                gameData.stats.money += amount;
                saveData();
                updateDataUI();
                alert(`ÊâÄÊåÅÈáë„Åå ${amount.toLocaleString()} G Â¢ó„Åà„Åæ„Åó„ÅüÔºÅ`);
            } 
            else if (inputCode === "GLASY") { 
                adminPanelOverlay.style.display = 'flex';
            }
            else if (inputCode === "TAIPINGU") { 
                document.getElementById('auto-type-panel-container').style.display = 'block';
            }
            else if (inputCode) { 
                alert("„Ç≥„Éº„Éâ„ÅåÈÅï„ÅÑ„Åæ„Åô„ÄÇ");
            }
        });

        adminPanelContainer.addEventListener('click', (e) => {
            if (!e.target.classList.contains('admin-btn')) return;

            const action = e.target.dataset.action;
            const value = e.target.dataset.value;
            let actionTaken = true;

            switch (action) {
                case 'money':
                    if (value === 'reset') { gameData.stats.money = 0; }
                    else { gameData.stats.money += parseInt(value, 10); }
                    if (gameData.stats.money < 0) { gameData.stats.money = 0; }
                    break;
                case 'xp':
                    addXP(parseInt(value, 10));
                    break;
                case 'level':
                    if (value === '100') {
                        gameData.stats.xp = getXPForLevel(100);
                        gameData.stats.level = 100;
                        prestigeBtn.style.display = 'flex';
                    } else if (value === 'reset') {
                        gameData.stats.xp = 0;
                        gameData.stats.level = 1;
                    }
                    break;
                case 'sp':
                    gameData.stats.skillPoints += parseInt(value, 10);
                    break;
                case 'unlock-all':
                    const lists = ['unlockedBackgrounds', 'unlockedFonts', 'unlockedSounds', 'unlockedPacks', 'unlockedEffects', 'unlockedThemes', 'unlockedPets', 'unlockedPetItems', 'unlockedPetHouses', 'unlockedBgms', 'unlockedKeyboardSkins', 'unlockedIcons', 'unlockedCharms'];
                    lists.forEach((listKey) => {
                        const itemType = listKey.replace('unlocked', '').replace('s', '').toLowerCase();
                        let typeKey = itemType;
                        if(typeKey === 'petitem') typeKey = 'pet-item';
                        if(typeKey === 'pethouse') typeKey = 'pet-house';
                        if(typeKey === 'keyboardskin') typeKey = 'kb-skin';
                        
                        const allItems = Object.keys(masterItemList).filter(k => masterItemList[k].type === typeKey);
                        gameData[listKey] = [...new Set([...gameData[listKey], ...allItems])]; // ‚òÖ„Éê„Ç∞‰øÆÊ≠£: „Éá„Éï„Ç©„É´„ÉàÂê´„ÇÅ„Å¶„Éû„Éº„Ç∏
                    });
                    alert('„Åô„Åπ„Å¶„ÅÆ„Ç´„Çπ„Çø„Éû„Ç§„Ç∫„Çí„Ç¢„É≥„É≠„ÉÉ„ÇØ„Åó„Åæ„Åó„Åü„ÄÇ');
                    break;
                case 'lock-all':
                    const oldStats = { ...gameData.stats }; // Áµ±Ë®àÊÉÖÂ†±„ÅØÁ∂≠ÊåÅ
                    gameData = getDefaultGameData();
                    gameData.stats = oldStats; // Áµ±Ë®àÊÉÖÂ†±„ÇíÊàª„Åô
                    alert('„Ç´„Çπ„Çø„Éû„Ç§„Ç∫„Çí„Éá„Éï„Ç©„É´„Éà‰ª•Â§ñ„Åô„Åπ„Å¶„É≠„ÉÉ„ÇØ„Åó„Åæ„Åó„Åü„ÄÇ');
                    break;
                case 'unlock-titles':
                    gameData.unlockedTitles = Array(TOTAL_TITLES).fill(true);
                    alert('„Åô„Åπ„Å¶„ÅÆÁß∞Âè∑„Çí„Ç¢„É≥„É≠„ÉÉ„ÇØ„Åó„Åæ„Åó„Åü„ÄÇ');
                    break;
                case 'lock-titles':
                    gameData.unlockedTitles = Array(TOTAL_TITLES).fill(false);
                    alert('„Åô„Åπ„Å¶„ÅÆÁß∞Âè∑„Çí„É≠„ÉÉ„ÇØ„Åó„Åæ„Åó„Åü„ÄÇ');
                    break;
                default:
                    actionTaken = false;
                    break;
            }

            if (actionTaken) {
                saveData();
                loadData(); // ‚òÖ„Éê„Ç∞‰øÆÊ≠£: loadData„ÇíÂëº„Çì„ÅßUI„Å´ÂèçÊò†
                resetGame();
            }
        });
        
        function startAutoTyper() {
            stopAutoTyper(); 
            if (!isAutoTyping) return;

            autoTyper = setInterval(() => {
                if (!gameRunning && !gameWaitingToStart) {
                    if (document.getElementById('end-screen-overlay').style.display !== 'flex') {
                        resetGame();
                        startGame();
                    }
                    return;
                }

                let keyToPress = null;
                if (currentRomaInput.length > 0) {
                    const partialMatch = targetRomaOptions.find(option => option.startsWith(currentRomaInput));
                    if (partialMatch && partialMatch.length > currentRomaInput.length) {
                        keyToPress = partialMatch[currentRomaInput.length];
                    } else {
                        keyToPress = targetRomaOptions[0][0];
                    }
                } else if (targetRomaOptions.length > 0) {
                    keyToPress = targetRomaOptions[0][0];
                }
                
                if (keyToPress) {
                    processTypedKey(keyToPress);
                } else if (gameRunning) {
                    if (gameMode === 'words' || gameMode === 'custom' || gameMode === 'timeAttack') { // ‚òÖÊ≠åË©ûÂâäÈô§
                        currentWordIndex++; 
                    }
                    loadCurrentWord();
                }

            }, autoTypeInterval);
        }

        function stopAutoTyper() {
            clearInterval(autoTyper);
        }

        document.getElementById('auto-type-toggle').addEventListener('click', (e) => {
            autoTypeToggleClickCount++;

            isAutoTyping = !isAutoTyping;
            if (isAutoTyping) {
                e.target.innerText = "Ëá™ÂãïÂÖ•Âäõ ON";
                e.target.classList.add('active');
                startAutoTyper();
            } else {
                e.target.innerText = "Ëá™ÂãïÂÖ•Âäõ OFF";
                e.target.classList.remove('active');
                stopAutoTyper();
            }

            if (autoTypeToggleClickCount >= 4) {
                document.getElementById('auto-type-panel-container').style.display = 'none';
            }
        });

        document.getElementById('auto-type-interval-grid').addEventListener('click', (e) => {
            if (e.target.classList.contains('interval')) {
                document.querySelectorAll('.auto-type-btn.interval').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                
                autoTypeInterval = parseInt(e.target.dataset.interval, 10);
                
                if (isAutoTyping) {
                    startAutoTyper();
                }
            }
        });

        function parseCustomWords(text) {
            const lines = text.split('\n').filter(line => line.trim().length > 0);
            const customWords = [];
            const regex = /(.+?)\[(.+?)\]/; // ‰æã: Êº¢Â≠ó[„Åã„Çì„Åò]

            lines.forEach(line => {
                line = line.trim();
                const match = line.match(regex);
                
                if (match && match[1] && match[2]) {
                    // Êº¢Â≠ó[„Çà„Åø] ÂΩ¢Âºè
                    const display = `<ruby>${match[1]}<rt>${match[2]}</rt></ruby>`;
                    const yomi = match[2];
                    customWords.push({ display: display, yomi: yomi });
                } else {
                    // „Å≤„Çâ„Åå„Å™/„Ç´„Çø„Ç´„Éä„ÅÆ„Åø
                    customWords.push({ display: line, yomi: line });
                }
            });
            return customWords;
        }
        
        // --- 13. Êñ∞Ê©üËÉΩ („Çπ„Ç≠„É´„ÉÑ„É™„Éº„ÄÅ„Éó„É≠„Éï„Ç£„Éº„É´„ÄÅ„ÅäÁü•„Çâ„Åõ) ---
        
        function renderProfile() {
            profileMainIcon.innerText = (masterItemList[gameData.settings.currentIcon] ? masterItemList[gameData.settings.currentIcon].emoji : 'üë§') || 'üë§';
            profileName.innerText = gameData.stats.playerName;
            profileIcon.innerText = (masterItemList[gameData.settings.currentIcon] ? masterItemList[gameData.settings.currentIcon].emoji : 'üë§') || 'üë§';
            
            profileMainName.firstChild.textContent = gameData.stats.playerName + ' ';
            
            const titles = masterTitleList.filter((_, i) => gameData.unlockedTitles[i]);
            const currentTitle = titles.length > 0 ? titles[titles.length - 1].name : '„Çø„Ç§„Éë„ÉºË¶ãÁøí„ÅÑ';
            profileMainTitle.innerText = currentTitle;
            profileMainTitle.style.color = gameData.settings.currentTitleColor;
            
            profileMainLevel.innerText = gameData.stats.level;
            profileMainPrestige.innerText = getPrestigeStar(gameData.stats.prestigeLevel);
            profileMainAp.innerText = gameData.stats.ap;
            
            // „Éú„Éº„Éä„Çπ‰∏ÄË¶ß
            profileBonusList.innerHTML = '';
            let bonuses = {
                score: (gameData.stats.prestigeType === 'standard' ? gameData.stats.prestigeLevel * 5 : 0) + (getSkillEffect('s01_score') * 1),
                money: (gameData.upgrades.moneyBoost * 10) + (getSkillEffect('s02_money') * 1),
                gacha: (gameData.stats.prestigeType === 'wealth' ? gameData.stats.prestigeLevel * 2.5 : 0) + (getSkillEffect('g01_gacha') * 0.2),
                fever: getSkillEffect('f01_fever'),
                shield: getSkillEffect('c02_shield')
            };
            if (getCharmEffect('money') > 0) bonuses.money += 5;
            
            profileBonusList.innerHTML = `
                <div>„Çπ„Ç≥„Ç¢„Éú„Éº„Éä„Çπ: <span>+${bonuses.score.toFixed(0)}%</span></div>
                <div>ÊâÄÊåÅÈáë„Éú„Éº„Éä„Çπ: <span>+${bonuses.money.toFixed(0)}%</span></div>
                <div>„Ç¨„ÉÅ„É£„É¨„Ç¢ÁéáUP: <span>+${bonuses.gacha.toFixed(1)}%</span></div>
                <div>„Éï„Ç£„Éº„Éê„ÉºÁ™ÅÂÖ•: <span>-${bonuses.fever} „Ç≥„É≥„Éú</span></div>
                <div>ËøΩÂä†„Ç∑„Éº„É´„Éâ: <span>+${bonuses.shield} Âõû</span></div>
            `;
        }
        
        function checkActiveEvents() {
            const today = new Date();
            const mmdd = (today.getMonth() + 1).toString().padStart(2, '0') + '-' + today.getDate().toString().padStart(2, '0');
            
            gameData.activeEvent = null;
            
            for (const event of masterEventList) {
                if (mmdd >= event.start && mmdd <= event.end) {
                    gameData.activeEvent = event.id;
                    // „Ç§„Éô„É≥„ÉàÈôêÂÆö„Ç¢„Ç§„ÉÜ„É†„Çí„Ç¢„É≥„É≠„ÉÉ„ÇØ
                    if (event.id === 'e_sakura') {
                        if (!gameData.unlockedBackgrounds.includes('bg_sakura')) gameData.unlockedBackgrounds.push('bg_sakura');
                        // „Ç¨„ÉÅ„É£„Éó„Éº„É´„Å∏„ÅÆËøΩÂä†„ÅØ„Ç¨„ÉÅ„É£ÂÆüË°åÊôÇ„Å´Ë°å„ÅÜ
                    }
                    break; // ÈáçË§á„ÅØ„Åó„Å™„ÅÑ
                }
            }
        }
        
        function renderNewsBoard() {
            newsListContainer.innerHTML = '';
            
            // 1. „Ç§„Éô„É≥„Éà
            if (gameData.activeEvent) {
                const event = masterEventList.find(e => e.id === gameData.activeEvent);
                const el = document.createElement('div');
                el.className = 'news-item';
                el.innerHTML = `<h3><i class="fas fa-magic"></i> „Ç§„Éô„É≥„ÉàÈñãÂÇ¨‰∏≠</h3> <p>${event.description}</p>`;
                newsListContainer.appendChild(el);
            }
            
            // 2. „Ç¶„Ç£„Éº„ÇØ„É™„Éº
            const weeklyEl = document.createElement('div');
            weeklyEl.className = 'news-item';
            weeklyEl.innerHTML = `<h3><i class="fas fa-calendar-week"></i> ‰ªäÈÄ±„ÅÆ„Éü„ÉÉ„Ç∑„Éß„É≥</h3> <p>„Äå„Éü„ÉÉ„Ç∑„Éß„É≥„Äç„Çø„Éñ„Åã„ÇâÊåëÊà¶„Åß„Åç„Åæ„Åô„ÄÇ‰ªäÈÄ±„ÇÇÈ†ëÂºµ„Çä„Åæ„Åó„Çá„ÅÜÔºÅ</p>`;
            newsListContainer.appendChild(weeklyEl);
            
            // 3. Ëª¢ÁîüË©¶Á∑¥
            if (gameData.prestigeTrial.active) {
                const el = document.createElement('div');
                el.className = 'news-item';
                el.innerHTML = `<h3><i class="fas fa-tasks"></i> Ëª¢Áîü„ÅÆË©¶Á∑¥ ÊåëÊà¶‰∏≠</h3> <p>ÁèæÂú®„ÄÅ„Éó„É¨„Çπ„ÉÜ„Éº„Ç∏„ÅÆË©¶Á∑¥„Å´ÊåëÊà¶‰∏≠„Åß„Åô„ÄÇLv. 30„Å´„Å™„ÇãÂâç„Å´ÈÅîÊàê„Åó„Åæ„Åó„Çá„ÅÜÔºÅ</p>`;
                newsListContainer.appendChild(el);
            }
        }
        
        function getSkillEffect(skillId) {
            return gameData.skills[skillId] || 0;
        }

        function renderSkillTree() {
            skillTreeGrid.innerHTML = '';
            skillPointsAvailable.innerText = gameData.stats.skillPoints;
            skillTreePrestigeLevel.innerText = gameData.stats.prestigeLevel;

            // „Çπ„Ç≠„É´„Éé„Éº„ÉâÊèèÁîª
            for (const id in masterSkillTree) {
                const skill = masterSkillTree[id];
                const node = document.createElement('div');
                node.className = 'skill-node';
                node.id = `skill-${id}`;
                node.style.left = `${skill.x}px`;
                node.style.top = `${skill.y}px`;
                node.innerHTML = `<span>${skill.icon}</span>`;
                
                const currentLevel = getSkillEffect(id);
                let isLocked = false;
                
                // ÂâçÊèêÊù°‰ª∂„ÉÅ„Çß„ÉÉ„ÇØ
                if (skill.req.length > 0) {
                    isLocked = skill.req.some(reqId => getSkillEffect(reqId) === 0);
                }
                
                if (isLocked) {
                    node.classList.add('locked');
                } else if (currentLevel >= skill.maxLevel) {
                    node.classList.add('maxed');
                } else if (currentLevel > 0) {
                    node.classList.add('unlocked');
                }

                // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
                node.addEventListener('click', () => unlockSkill(id));
                node.addEventListener('mouseenter', (e) => {
                    const statusText = isLocked ? 'ÂâçÊèê„Çπ„Ç≠„É´„ÅåÂøÖË¶Å„Åß„Åô' : (currentLevel >= skill.maxLevel ? 'MAX„É¨„Éô„É´„Åß„Åô' : (gameData.stats.skillPoints < skill.cost ? `SP„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô („Ç≥„Çπ„Éà: ${skill.cost} SP)` : `„ÇØ„É™„ÉÉ„ÇØ„ÅßÁøíÂæó („Ç≥„Çπ„Éà: ${skill.cost} SP)`));
                    const desc = skill.desc.replace('[L*1]', `<strong>${(currentLevel + 1) * 1}</strong>`).replace('[L*0.1]', `<strong>${((currentLevel + 1) * 0.1).toFixed(1)}</strong>`).replace('[L*5]', `<strong>${((currentLevel + 1) * 5)}</strong>`).replace('[L*0.5]', `<strong>${((currentLevel + 1) * 0.5).toFixed(1)}</strong>`).replace('[L*0.2]', `<strong>${((currentLevel + 1) * 0.2).toFixed(1)}</strong>`);
                    showSkillTooltip(skill.name, `${desc}<br>(Lv. ${currentLevel} / ${skill.maxLevel})`, statusText, (isLocked || gameData.stats.skillPoints < skill.cost) ? 'locked' : '');
                });
                node.addEventListener('mouseleave', () => hideSkillTooltip());
                node.addEventListener('mousemove', (e) => {
                    skillTooltip.style.left = `${e.clientX + 15}px`;
                    skillTooltip.style.top = `${e.clientY + 15}px`;
                });

                skillTreeGrid.appendChild(node);
                
                // „É©„Ç§„É≥ÊèèÁîª
                skill.req.forEach(reqId => {
                    const reqSkill = masterSkillTree[reqId];
                    if (!reqSkill) return;
                    
                    const line = document.createElement('div');
                    line.className = 'skill-line';
                    const dx = skill.x - reqSkill.x;
                    const dy = skill.y - reqSkill.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    const angle = Math.atan2(dy, dx) * (180 / Math.PI);
                    
                    line.style.width = `${dist}px`;
                    line.style.left = `${reqSkill.x + 30}px`; // „Éé„Éº„Éâ„ÅÆ‰∏≠ÂøÉ„Åã„Çâ
                    line.style.top = `${reqSkill.y + 30}px`;
                    line.style.transform = `rotate(${angle}deg)`;
                    
                    if (currentLevel > 0 && getSkillEffect(reqId) > 0) {
                        line.classList.add('unlocked');
                    }
                    skillTreeGrid.appendChild(line);
                });
            }
        }
        
        function unlockSkill(id) {
            const skill = masterSkillTree[id];
            const currentLevel = getSkillEffect(id);
            if (currentLevel >= skill.maxLevel) return;
            if (gameData.stats.skillPoints < skill.cost) return;
            
            // ÂâçÊèêÊù°‰ª∂„ÉÅ„Çß„ÉÉ„ÇØ
            let isLocked = false;
            if (skill.req.length > 0) {
                isLocked = skill.req.some(reqId => getSkillEffect(reqId) === 0);
            }
            if (isLocked) return;
            
            gameData.stats.skillPoints -= skill.cost;
            gameData.skills[id] = (gameData.skills[id] || 0) + 1;
            playSound('skill-unlock');
            applyCharmEffects(); // „Çπ„Ç≠„É´„Å´„Çà„Çã„ÅäÂÆà„ÇäÂäπÊûúÂ§âÊõ¥„Å™„Å©
            renderSkillTree();
        }
        
        function showSkillTooltip(name, desc, cost, status) {
            skillTooltip.style.display = 'block';
            document.getElementById('skill-tooltip-name').innerText = name;
            document.getElementById('skill-tooltip-desc').innerHTML = desc;
            document.getElementById('skill-tooltip-cost').innerText = cost;
            document.getElementById('skill-tooltip-status').innerText = (status === 'locked') ? 'ÂâçÊèê„Çπ„Ç≠„É´„ÅåÂøÖË¶Å„Åß„Åô' : '';
        }
        function hideSkillTooltip() {
            skillTooltip.style.display = 'none';
        }
        
        skillResetBtn.addEventListener('click', () => {
            const cost = gameData.stats.prestigeLevel * 1000;
            if (gameData.stats.money < cost) {
                alert(`„Çπ„Ç≠„É´„É™„Çª„ÉÉ„Éà„Å´„ÅØ ${cost.toLocaleString()} G „ÅåÂøÖË¶Å„Åß„Åô„ÄÇ`);
                return;
            }
            if (window.confirm(`Êú¨ÂΩì„Å´„Çπ„Ç≠„É´„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü\nÊ∂àË≤ª„Åó„Åü„Åô„Åπ„Å¶„ÅÆSP„ÅåÊàª„Çä„Åæ„Åô„ÄÇ\n(„Ç≥„Çπ„Éà: ${cost.toLocaleString()} G)`)) {
                let totalSpSpent = 0;
                for (const id in gameData.skills) {
                    if (masterSkillTree[id]) { // ‚òÖ„Éê„Ç∞‰øÆÊ≠£: Â≠òÂú®„Åó„Å™„ÅÑ„Çπ„Ç≠„É´ID„ÇíÂèÇÁÖß„Åó„Å™„ÅÑ
                        totalSpSpent += gameData.skills[id] * masterSkillTree[id].cost;
                    }
                }
                
                gameData.stats.money -= cost;
                gameData.stats.skillPoints += totalSpSpent;
                gameData.skills = {};
                saveData();
                renderSkillTree();
                updateDataUI();
            }
        });
        
        // „Éó„É™„Çª„ÉÉ„Éà
        presetContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('preset-btn-load')) {
                const presetId = parseInt(e.target.dataset.id, 10);
                loadPreset(presetId);
            }
        });
        savePresetBtn.addEventListener('click', () => {
            const presetId = gameData.settings.currentPreset;
            if (window.confirm(`ÁèæÂú®„ÅÆ„Çπ„Ç≠„É´„Å®„ÅäÂÆà„Çä„Çí„Éó„É™„Çª„ÉÉ„Éà ${presetId + 1} „Å´‰∏äÊõ∏„Åç‰øùÂ≠ò„Åó„Åæ„Åô„ÅãÔºü`)) {
                savePreset(presetId);
                alert(`„Éó„É™„Çª„ÉÉ„Éà ${presetId + 1} „Å´‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ`);
            }
        });
        
        function savePreset(id) {
            gameData.presets[id] = {
                skills: { ...gameData.skills },
                charm: gameData.settings.currentCharm
            };
            saveData();
        }
        
        function loadPreset(id) {
            if (window.confirm(`„Éó„É™„Çª„ÉÉ„Éà ${id + 1} „ÇíË™≠„ÅøËæº„Åø„Åæ„Åô„ÅãÔºü\nÁèæÂú®„ÅÆ„Çπ„Ç≠„É´Ââ≤„ÇäÊåØ„Çä„ÅØ„É™„Çª„ÉÉ„Éà„Åï„Çå„Åæ„Åô„ÄÇ\n(SP„ÅØÊàª„Çä„Åæ„Åô)`)) {
                const preset = gameData.presets[id];
                if (!preset) return;
                
                // SP„Çí„É™„Çª„ÉÉ„Éà
                let totalSpSpent = 0;
                for (const id in gameData.skills) {
                    if (masterSkillTree[id]) { // ‚òÖ„Éê„Ç∞‰øÆÊ≠£
                        totalSpSpent += gameData.skills[id] * masterSkillTree[id].cost;
                    }
                }
                gameData.stats.skillPoints += totalSpSpent;
                gameData.skills = {};
                
                // „Éó„É™„Çª„ÉÉ„Éà„ÅÆSP„ÇíÊ∂àË≤ª
                let presetSpCost = 0;
                for (const id in preset.skills) {
                    if (masterSkillTree[id]) { // ‚òÖ„Éê„Ç∞‰øÆÊ≠£
                        presetSpCost += preset.skills[id] * masterSkillTree[id].cost;
                    }
                }
                
                if (gameData.stats.skillPoints >= presetSpCost) {
                    gameData.stats.skillPoints -= presetSpCost;
                    gameData.skills = { ...preset.skills };
                    gameData.settings.currentCharm = preset.charm;
                    gameData.settings.currentPreset = id;
                    
                    alert(`„Éó„É™„Çª„ÉÉ„Éà ${id + 1} „Çí„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü„ÄÇ`);
                    saveData();
                    renderSkillTree();
                    renderCharmSelector();
                    applyCharmEffects();
                    renderProfile(); // „Éú„Éº„Éä„ÇπË°®Á§∫Êõ¥Êñ∞
                    
                    document.querySelectorAll('.preset-btn-load').forEach(btn => btn.classList.remove('active'));
                    document.querySelector(`.preset-btn-load[data-id="${id}"]`).classList.add('active');
                } else {
                    alert(`SP„ÅåË∂≥„Çä„Åæ„Åõ„Çì„ÄÇ${presetSpCost} SP „ÅåÂøÖË¶Å„Åß„Åô„ÄÇ`);
                    // „É≠„Éº„ÉâÂ§±Êïó„Åó„Åü„ÅÆ„Åß„É™„Çª„ÉÉ„ÉàÁä∂ÊÖã„ÅÆ„Åæ„Åæ
                    saveData();
                    renderSkillTree();
                }
            }
        }
    </script>
</body>
</html>